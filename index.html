<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Latte Studio</title>
    <!-- 引入 Tailwind CSS (无需下载，直接使用) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入图标库，CDN 主备 -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        (() => {
            if (window.lucide && typeof window.lucide.createIcons === 'function') return;
            const fallback = document.createElement('script');
            fallback.src = 'https://cdn.jsdelivr.net/npm/lucide@latest';
            document.head.appendChild(fallback);
        })();
    </script>
    <style>
        /* 基础样式与暗色模式优化 */
        body { background-color: #0c0c0c; color: #e5e5e5; font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Microsoft YaHei", sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .tab-content { display: none; animation: fadeIn 0.25s ease-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        
        /* 适配全面屏安全区域（iOS 刘海 / 底部 Home 条） */
        .safe-top {
            padding-top: env(safe-area-inset-top);
            padding-top: constant(safe-area-inset-top);
        }
        .safe-bottom {
            padding-bottom: env(safe-area-inset-bottom);
            padding-bottom: constant(safe-area-inset-bottom);
        }
        
        /* 移动端输入体验优化，避免 iOS 放大 */
        input, select, textarea, button {
            font-size: 16px;
        }
        
        /* 数字滑轮选择器样式 */
        .wheel-overlay-backdrop {
            background: rgba(0, 0, 0, 0.65);
        }
        .wheel-column {
            scroll-behavior: smooth;
        }
        .wheel-item {
            height: 40px;
        }
        .wheel-center-mask {
            pointer-events: none;
        }
        
        /* 毛玻璃与卡片质感 */
        .glass-panel { background: rgba(30, 30, 30, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .focus-ring:focus { outline: none; border-color: #d97706; box-shadow: 0 0 0 1px #d97706; }
        /* ========== 大字体与触控优化补丁 ========== */
        
        /* 1. 提升全局基础字号 (让 rem 单位整体变大) */
        html {
            font-size: 18px; /* 默认是16px，改为18px相当于整体放大 12.5% */
        }

        /* 2. 强制覆盖太小的字体类 */
        /* 把原本 10px 的小标强制改为 12px */
        .text-\[10px\] { 
            font-size: 0.75rem !important; /* 约 13.5px */
            opacity: 0.8; /* 稍微增加对比度 */
        }
        
        /* 把原本 xs (12px) 的字体强制改为 14px */
        .text-xs { 
            font-size: 0.85rem !important; /* 约 15.3px */
        }
        
        /* 把原本 sm (14px) 的字体强制改为 16px */
        .text-sm { 
            font-size: 1rem !important; /* 18px */
        }

        /* 3. 增大输入框和按钮的触控区域 */
        input, select, button {
            /* 确保高度至少 44px (符合手指点击标准) */
            min-height: 44px !important; 
        }
        
        /* 修正因为字体变大导致的顶部导航布局拥挤 */
        header h1 {
            font-size: 1.25rem !important; /* 20px */
        }
        
        /* 修正输入框内的大数字 */
        .text-3xl {
            font-size: 2.25rem !important; /* 让核心数字更大更清晰 */
            font-weight: 600 !important;   /* 加粗 */
        }

        /* 优化标签按钮的内边距 */
        button.text-\[10px\] {
            padding-left: 12px !important;
            padding-right: 12px !important;
            padding-top: 8px !important;
            padding-bottom: 8px !important;
        }

        /* 优化历史记录卡片的间距 */
        #history-list .p-3 {
            padding: 1rem !important; /* 增大卡片内边距 */
        }

        /* 多行文本截断支持（确保 line-clamp 在所有浏览器中正常工作） */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
    <script>
        tailwind.config = {
            theme: { extend: { colors: { stone: { 850: '#1c1917', 900: '#151515' }, amber: { 450: '#fbbf24', 600: '#d97706' } } } }
        }
    </script>
</head>
<body class="pb-24 select-none">

    <!-- 顶部导航 -->
    <header class="fixed top-0 w-full z-50 bg-[#0c0c0c]/90 backdrop-blur-md border-b border-white/5 h-14 flex items-center justify-between px-4 safe-top">
        <div class="flex items-center gap-2">
            <div class="bg-gradient-to-br from-amber-700 to-amber-900 p-1.5 rounded-lg text-white shadow-lg shadow-amber-900/20">
                <i data-lucide="coffee" class="w-5 h-5"></i>
            </div>
            <h1 class="font-bold text-lg tracking-tight text-stone-200">Latte Studio</h1>
        </div>
    </header>

    <main class="w-full pt-20 px-4 pb-24">
        
        <!-- ==================== 1. 记录页 (Record) ==================== -->
        <div id="tab-record" class="tab-content active space-y-5">
            
            <!-- 豆子展示卡片 -->
            <div class="relative h-48 rounded-3xl overflow-hidden bg-stone-900 border border-white/10 shadow-2xl group transition-all transform-gpu">
                
                <img id="bean-hero-img" class="absolute inset-0 w-full h-full object-cover transition-transform duration-700 group-hover:scale-105 hidden" alt="Coffee Bean" />
                
                <div id="bean-hero-fallback" class="absolute inset-0 bg-stone-800"></div>

                <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent"></div>
                
                <div class="absolute bottom-0 left-0 p-5 w-full z-10">
                    <h2 id="hero-bean-name" class="text-2xl font-bold text-white leading-tight drop-shadow-md mb-2 truncate" style="font-size: clamp(1rem, 4vw, 1.5rem); text-shadow: 0 2px 4px rgba(0,0,0,0.8);">选择咖啡豆</h2>
                    
                    <div class="flex items-center gap-2 mb-3">
                        <span id="hero-roast-badge" class="text-[10px] !opacity-100 font-bold text-white px-2 py-0.5 rounded-full backdrop-blur-sm shadow-sm hidden">中深烘</span>
                        <span id="hero-stage-badge" class="text-[10px] !opacity-100 font-bold text-white px-2 py-0.5 rounded-full backdrop-blur-sm shadow-sm hidden"></span>
                    </div>
                    <div id="hero-bean-stats" class="flex flex-wrap gap-2 text-xs text-stone-200"></div>
                    
                    <div class="grid grid-cols-2 gap-2">
                        <div class="flex flex-col gap-1">
                            <div class="relative">
                                <select id="input-bean" class="w-full appearance-none bg-black/40 backdrop-blur-md text-white border border-white/20 pl-4 pr-10 py-3 rounded-xl text-sm font-medium focus:outline-none focus:bg-stone-900/90 focus:border-amber-500 transition-all">
                                    <option value="">请先在资产页添加...</option>
                                </select>
                                <i data-lucide="chevron-down" class="absolute right-3 top-3.5 text-white/70 w-4 h-4 pointer-events-none"></i>
                            </div>
                            <div id="bean-info-display" class="text-[10px] text-stone-500 px-1 flex items-center justify-between min-h-[16px]"></div>
                        </div>

                        <div class="flex flex-col gap-1">
                            <div class="relative">
                                <select id="input-milk" class="w-full appearance-none bg-black/40 backdrop-blur-md text-white border border-white/20 pl-4 pr-10 py-3 rounded-xl text-sm font-medium focus:outline-none focus:bg-stone-900/90 focus:border-amber-500 transition-all">
                                    <option value="">请选择牛奶...</option>
                                </select>
                                <i data-lucide="chevron-down" class="absolute right-3 top-3.5 text-white/70 w-4 h-4 pointer-events-none"></i>
                            </div>
                            <div id="milk-info-display" class="text-[10px] text-stone-500 px-1 text-right min-h-[16px]"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 设备栏：咖啡机 / 磨豆机 -->
            <div class="grid grid-cols-2 gap-4 mt-2">
                <div class="glass-panel rounded-2xl p-4 flex flex-col justify-center">
                    <label class="text-[10px] uppercase text-stone-500 font-bold mb-1 flex items-center gap-1">
                        <i data-lucide="zap" class="w-3"></i> 咖啡机
                    </label>
                    <select id="input-machine" class="w-full bg-transparent text-stone-300 text-xs appearance-none focus:outline-none truncate py-1 mt-1"></select>
                </div>
                <div class="glass-panel rounded-2xl p-4 flex flex-col justify-center">
                    <label class="text-[10px] uppercase text-stone-500 font-bold mb-1 flex items-center gap-1">
                        <i data-lucide="cpu" class="w-3"></i> 磨豆机
                    </label>
                    <select id="input-grinder" class="w-full bg-transparent text-stone-300 text-xs appearance-none focus:outline-none truncate py-1 mt-1"></select>
                </div>
            </div>

            <!-- 核心参数：粉重 / 研磨度 / 水温 / 牛奶克重 / 萃取时间 / 液重 -->
            <div class="grid grid-cols-2 gap-4 mt-3">
                <div class="glass-panel rounded-2xl p-4 transition-colors hover:bg-stone-800/50">
                    <label class="flex items-center text-[10px] font-bold text-stone-500 uppercase mb-2"><i data-lucide="scale" class="w-3 mr-1"></i> 粉重</label>
                    <div class="relative">
                        <input 
                            type="text" 
                            id="input-dose" 
                            value="18.0" 
                            inputmode="decimal"
                            readonly
                            data-wheel="true"
                            data-min="10"
                            data-max="25"
                            data-step="0.1"
                            class="w-full bg-transparent text-3xl font-mono text-white text-center focus:outline-none placeholder-stone-700 cursor-pointer"
                        >
                        <span class="absolute right-0 bottom-2 text-stone-600 text-xs font-mono">g</span>
                    </div>
                </div>
                <div class="glass-panel rounded-2xl p-4 transition-colors hover:bg-stone-800/50">
                    <label class="flex items-center text-[10px] font-bold text-stone-500 uppercase mb-2">
                        <i data-lucide="sliders" class="w-3 mr-1"></i> 研磨度
                    </label>
                    <div class="relative">
                        <input 
                            type="text" 
                            id="input-grind-size" 
                            value="10.0"
                            placeholder="10.0"
                            inputmode="decimal"
                            readonly
                            data-wheel="true"
                            data-min="0"
                            data-max="30"
                            data-step="0.1"
                            class="w-full bg-transparent text-3xl font-mono text-amber-500 text-center focus:outline-none placeholder-stone-700 cursor-pointer"
                        >
                    </div>
                </div>
                <div class="glass-panel rounded-2xl p-4 transition-colors hover:bg-stone-800/50">
                    <label class="flex items-center text-[10px] font-bold text-stone-500 uppercase mb-2">
                        <i data-lucide="thermometer" class="w-3 mr-1"></i> 水温
                    </label>
                    <div class="relative flex items-baseline justify-center gap-1">
                        <input 
                            type="text" 
                            id="input-temp" 
                            value="93" 
                            inputmode="numeric"
                            readonly
                            data-wheel="true"
                            data-min="85"
                            data-max="100"
                            data-step="1"
                            class="w-14 bg-transparent text-3xl font-mono text-center focus:outline-none cursor-pointer temp-input text-white"
                        >
                        <span class="text-stone-600 text-xs font-mono">°C</span>
                    </div>
                </div>
                <div class="glass-panel rounded-2xl p-4 transition-colors hover:bg-stone-800/50">
                    <label class="relative flex items-center text-[10px] font-bold text-stone-500 uppercase mb-2">
                        <i data-lucide="milk" class="w-3 mr-1"></i> 牛奶
                        <span id="milk-coffee-ratio" class="absolute right-0 text-[10px] text-amber-500 font-mono"></span>
                    </label>
                    <div class="relative">
                        <input 
                            type="text" 
                            id="input-milk-weight" 
                            value="200" 
                            inputmode="decimal"
                            readonly
                            data-wheel="true"
                            data-min="0"
                            data-max="300"
                            data-step="1"
                            class="w-full bg-transparent text-3xl font-mono text-white text-center focus:outline-none placeholder-stone-700 cursor-pointer"
                        >
                        <span class="absolute right-0 bottom-2 text-stone-600 text-xs font-mono">g</span>
                    </div>
                </div>
                <div class="glass-panel rounded-2xl p-4 transition-colors hover:bg-stone-800/50">
                    <label class="flex items-center text-[10px] font-bold text-stone-500 uppercase mb-2"><i data-lucide="timer" class="w-3 mr-1"></i> 萃取时间</label>
                    <div class="relative">
                        <input 
                            type="text" 
                            id="input-time" 
                            value="25" 
                            inputmode="numeric"
                            readonly
                            data-wheel="true"
                            data-min="10"
                            data-max="45"
                            data-step="1"
                            class="w-full bg-transparent text-3xl font-mono text-white text-center focus:outline-none placeholder-stone-700 cursor-pointer"
                        >
                        <span class="absolute right-0 bottom-2 text-stone-600 text-xs font-mono">s</span>
                    </div>
                </div>
                <div class="glass-panel rounded-2xl p-4 transition-colors hover:bg-stone-800/50">
                    <label class="relative flex items-center text-[10px] font-bold text-stone-500 uppercase mb-2">
                        <i data-lucide="droplets" class="w-3 mr-1"></i> 液重
                        <span id="dose-yield-ratio" class="absolute right-0 text-[10px] text-amber-500 font-mono"></span>
                    </label>
                    <div class="relative">
                        <input 
                            type="text" 
                            id="input-yield" 
                            value="36.0" 
                            inputmode="decimal"
                            readonly
                            data-wheel="true"
                            data-min="15"
                            data-max="60"
                            data-step="0.1"
                            class="w-full bg-transparent text-3xl font-mono text-white text-center focus:outline-none placeholder-stone-700 cursor-pointer"
                        >
                        <span class="absolute right-0 bottom-2 text-stone-600 text-xs font-mono">g</span>
                    </div>
                </div>
            </div>

            <!-- 评价区 -->
            <div class="glass-panel rounded-2xl p-5 space-y-4">
                <div class="flex justify-between items-center">
                    <span class="text-xs font-bold text-stone-500 uppercase tracking-widest">口感评价</span>
                    <button id="btn-god-shot" class="flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-bold transition-all bg-stone-800 text-stone-500 border border-stone-700 active:scale-95">
                        <i data-lucide="crown" class="w-3"></i> 完美萃取
                    </button>
                </div>
                
                <div class="flex gap-3 justify-center py-1" id="star-container"></div>

                <div class="flex flex-wrap gap-2" id="tags-container">
                    <button onclick="addNewTagPrompt()" class="text-[10px] px-3 py-1.5 rounded-lg border border-dashed border-stone-700 text-stone-500 hover:text-stone-300 hover:border-stone-500 transition-colors flex items-center justify-center gap-1 active:bg-stone-800 leading-none">
                        <i data-lucide="plus" class="w-3 h-3"></i> 标签
                    </button>
                </div>

                <textarea id="input-notes" placeholder="风味描述、流速、通道效应..." class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-sm min-h-[80px] focus:outline-none focus:border-amber-600/50 resize-none text-stone-300 placeholder-stone-700"></textarea>
                
                <!-- 图片上传 -->
                <div class="mt-3">
                    <label class="text-[10px] font-bold text-stone-500 uppercase mb-2 block">拉花/成品图片</label>
                    <div class="relative">
                        <input type="file" id="input-log-image" accept="image/*" class="hidden" />
                        <div id="log-image-preview-container" class="hidden mb-2">
                            <div class="relative inline-block">
                                <img id="log-image-preview" src="" alt="预览" class="w-full max-w-[200px] h-auto rounded-xl border border-stone-700 object-cover" />
                                <button onclick="clearLogImage()" class="absolute -top-2 -right-2 w-6 h-6 rounded-full bg-red-600 text-white flex items-center justify-center hover:bg-red-700 transition-colors">
                                    <i data-lucide="x" class="w-3 h-3"></i>
                                </button>
                            </div>
                        </div>
                        <button onclick="document.getElementById('input-log-image').click()" class="w-full px-4 py-2 rounded-xl border border-dashed border-stone-700 text-stone-400 hover:text-stone-300 hover:border-stone-600 transition-colors flex items-center justify-center gap-2">
                            <i data-lucide="image" class="w-4 h-4"></i>
                            <span class="text-xs">添加图片</span>
                        </button>
                    </div>
                </div>
            </div>

            <button id="btn-save-log" onclick="saveLog()" class="w-full bg-gradient-to-r from-amber-600 to-amber-700 hover:from-amber-500 hover:to-amber-600 text-white font-bold py-4 rounded-2xl shadow-lg shadow-amber-900/30 active:scale-[0.98] transition-all flex items-center justify-center gap-2">
                <i data-lucide="save" class="w-5"></i> <span id="btn-save-log-text">记录这杯</span>
            </button>
        </div>

        <!-- ==================== 2. 历史页 (History) ==================== -->
        <div id="tab-history" class="tab-content space-y-4">
            <div class="sticky top-14 z-20 bg-[#0c0c0c]/95 backdrop-blur py-3 border-b border-stone-900 px-1 flex items-center gap-2 overflow-x-auto no-scrollbar">
                <button onclick="toggleFilter('god')" id="filter-god" class="flex-shrink-0 flex items-center gap-1.5 px-3 py-1.5 h-8 rounded-full text-xs font-medium border border-stone-800 text-stone-400 bg-stone-900 transition-colors hover:bg-stone-800">
                    <i data-lucide="crown" class="w-3 h-3"></i> 完美记录
                </button>
                <div class="w-[1px] bg-stone-800 h-6"></div>
                <div id="history-filters" class="flex items-center gap-2"></div>
                <div class="w-[1px] bg-stone-800 h-6"></div>
                <button 
                    onclick="toggleDateFilter()" 
                    id="filter-date-btn"
                    class="flex-shrink-0 flex items-center gap-1.5 px-3 py-1.5 h-8 rounded-full text-xs font-medium border transition-colors ${filterDateStart || filterDateEnd ? 'bg-stone-800 text-amber-500 border-amber-500/50' : 'bg-stone-900 border-stone-800 text-stone-400 hover:bg-stone-800'}"
                >
                    <i data-lucide="calendar" class="w-3 h-3"></i>
                    <span>${filterDateStart || filterDateEnd ? formatDateRange(filterDateStart, filterDateEnd) : '日期筛选'}</span>
                    ${filterDateStart || filterDateEnd ? `<i data-lucide="x" class="w-3 h-3 ml-1" onclick="event.stopPropagation(); clearDateFilter();"></i>` : ''}
                </button>
            </div>
            
            <div id="history-list" class="space-y-3 min-h-[300px]">
                <div class="text-center py-20 text-stone-600">暂无记录</div>
            </div>
        </div>

        <!-- ==================== 3. 资产页 (Gear) ==================== -->
        <div id="tab-gear" class="tab-content space-y-6">
            
            <div class="flex bg-stone-900 p-1 rounded-xl border border-stone-800">
                <button onclick="switchGearSubTab('beans')" class="gear-sub-tab flex-1 py-2 text-xs font-bold uppercase rounded-lg transition-all bg-stone-800 text-white shadow-sm" data-target="beans">咖啡豆</button>
                <button onclick="switchGearSubTab('milks')" class="gear-sub-tab flex-1 py-2 text-xs font-bold uppercase rounded-lg transition-all text-stone-500" data-target="milks">牛奶</button>
                <button onclick="switchGearSubTab('machines')" class="gear-sub-tab flex-1 py-2 text-xs font-bold uppercase rounded-lg transition-all text-stone-500" data-target="machines">咖啡机</button>
                <button onclick="switchGearSubTab('grinders')" class="gear-sub-tab flex-1 py-2 text-xs font-bold uppercase rounded-lg transition-all text-stone-500" data-target="grinders">磨豆机</button>
                <button onclick="switchGearSubTab('tags')" class="gear-sub-tab flex-1 py-2 text-xs font-bold uppercase rounded-lg transition-all text-stone-500" data-target="tags">标签</button>
                <button onclick="switchGearSubTab('backup')" class="gear-sub-tab flex-1 py-2 text-xs font-bold uppercase rounded-lg transition-all text-stone-500" data-target="backup">备份</button>
            </div>

            <!-- 添加按钮 -->
            <div id="gear-add-button-container" class="mb-4 hidden">
                <button onclick="showAssetFormModal()" class="w-full flex items-center justify-center gap-2 bg-gradient-to-r from-amber-600 to-amber-700 hover:from-amber-500 hover:to-amber-600 text-white font-bold py-3 rounded-xl shadow-lg shadow-amber-900/30 active:scale-[0.98] transition-all">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                    <span>添加新项目</span>
                </button>
            </div>

            <!-- 排序功能（仅咖啡豆） -->
            <div id="bean-sort-container" class="mb-4 hidden">
                <div class="flex items-center gap-2 overflow-x-auto no-scrollbar pb-2">
                    <span class="text-[10px] font-bold text-stone-500 uppercase flex-shrink-0">排序：</span>
                    <button onclick="toggleBeanSort('roastDate')" class="bean-sort-btn flex-shrink-0 px-3 py-1.5 rounded-full text-xs font-medium border transition-colors" data-field="roastDate">烘焙日期</button>
                    <button onclick="toggleBeanSort('name')" class="bean-sort-btn flex-shrink-0 px-3 py-1.5 rounded-full text-xs font-medium border transition-colors" data-field="name">名称</button>
                    <button onclick="toggleBeanSort('remaining')" class="bean-sort-btn flex-shrink-0 px-3 py-1.5 rounded-full text-xs font-medium border transition-colors" data-field="remaining">剩余量</button>
                    <button onclick="toggleBeanSort('price')" class="bean-sort-btn flex-shrink-0 px-3 py-1.5 rounded-full text-xs font-medium border transition-colors" data-field="price">价格</button>
                </div>
            </div>

            <div id="gear-list" class="space-y-2 pb-4 hidden mt-4"></div>

            <!-- 标签管理列表（只在 tags tab 显示） -->
            <div id="tags-list" class="space-y-2 pb-4 hidden mt-4"></div>

            <!-- 数据备份区域（只在 backup tab 显示） -->
            <div id="backup-panel" class="glass-panel rounded-2xl p-4 mt-8 hidden">
                <button onclick="batchOptimizeImages()" class="w-full mt-3 flex items-center justify-center gap-2 bg-stone-800 border border-stone-700 hover:bg-stone-700 text-amber-500 py-3 rounded-lg text-xs font-medium active:scale-95 transition-transform">
                    <i data-lucide="shrink" class="w-3"></i> 优化旧图片 (批量瘦身)
                </button>
                <button onclick="showRoastPeriodsConfig()" class="w-full mt-3 flex items-center justify-center gap-2 bg-stone-800 border border-stone-700 hover:bg-stone-700 text-amber-500 py-3 rounded-lg text-xs font-medium active:scale-95 transition-transform">
                    <i data-lucide="settings" class="w-3"></i> 赏味周期配置
                </button>
                <h3 class="text-xs font-bold text-stone-500 uppercase mb-3 flex items-center gap-1 mt-6"><i data-lucide="hard-drive" class="w-3"></i> 数据备份</h3>
                
                <!-- 存储空间使用情况 -->
                <div id="storage-info" class="mb-4 p-3 bg-stone-800/50 rounded-lg border border-stone-700">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-[10px] text-stone-500 uppercase">存储空间</span>
                        <span id="storage-percentage" class="text-xs font-bold text-stone-400"></span>
                    </div>
                    <div class="w-full bg-stone-900 rounded-full h-2 mb-1">
                        <div id="storage-bar" class="bg-amber-500 h-2 rounded-full transition-all" style="width: 0%"></div>
                    </div>
                    <div class="text-[10px] text-stone-600" id="storage-text"></div>
                </div>
                
                <div class="flex gap-3">
                    <button onclick="exportData()" class="flex-1 flex items-center justify-center gap-2 bg-stone-900 border border-stone-700 hover:bg-stone-800 text-stone-300 py-3 rounded-lg text-xs font-medium active:scale-95 transition-transform">
                        <i data-lucide="download" class="w-3"></i> 导出备份
                    </button>
                    <div class="flex-1 relative">
                        <button class="w-full flex items-center justify-center gap-2 bg-stone-900 border border-stone-700 hover:bg-stone-800 text-stone-300 py-3 rounded-lg text-xs font-medium active:scale-95 transition-transform">
                            <i data-lucide="upload" class="w-3"></i> 导入恢复
                        </button>
                        <input type="file" onchange="importData(this)" accept=".json" class="absolute inset-0 opacity-0 cursor-pointer">
                    </div>
                </div>
                <button onclick="resetAllData()" class="w-full mt-3 flex items-center justify-center gap-2 bg-red-900/30 border border-red-800/50 hover:bg-red-900/40 text-red-400 py-3 rounded-lg text-xs font-medium active:scale-95 transition-transform">
                    <i data-lucide="trash-2" class="w-3"></i> 清空所有数据
                </button>
                <p class="text-[10px] text-stone-600 mt-3 text-center leading-relaxed">数据仅保存在您的浏览器中。<br>建议定期导出 JSON 文件以防丢失。</p>

                <!-- 打赏部分 -->
                <div class="mt-6 pt-6 border-t border-stone-700">
                    <div class="text-center mb-4">
                        <h3 class="text-sm font-bold text-stone-300 mb-2 flex items-center justify-center gap-2">
                            <i data-lucide="heart" class="w-4 text-amber-500"></i>
                            感谢支持
                        </h3>
                        <p class="text-xs text-stone-400 leading-relaxed px-2">
                            感谢你使用 Latte Studio！这个工具原本就是我给自己写着玩的，能帮到大家我很开心。工具会一直保持免费，但服务器和域名需要续费呀 (T_T)。如果你觉得它值得长期存在，请我喝杯咖啡吧，你的支持是保证小站不失联、且我在深夜继续修复 Bug 的最大动力！☕️
                        </p>
                    </div>
                    <div class="flex flex-col items-center gap-3">
                        <div class="bg-white p-3 rounded-lg shadow-lg">
                            <img src="../qr.jpg" alt="打赏二维码" class="w-32 h-32 object-contain rounded">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 数字滑轮选择器 -->
    <div id="wheel-overlay" class="fixed inset-0 z-50 hidden wheel-overlay-backdrop flex items-end justify-center">
        <div class="w-full bg-stone-950/95 border-t border-stone-800 rounded-t-3xl pb-6 pt-3 px-4 safe-bottom">
            <div class="flex items-center justify-between mb-2">
                <button id="wheel-cancel" class="text-xs text-stone-400 px-2 py-1">取消</button>
                <div id="wheel-title" class="text-xs text-stone-300 font-medium"></div>
                <button id="wheel-confirm" class="text-xs text-amber-400 font-semibold px-2 py-1">确定</button>
            </div>
            <div class="relative mt-1">
                <div class="absolute inset-x-4 top-1/2 -translate-y-1/2 h-9 rounded-xl border border-amber-500/40 bg-amber-500/5 wheel-center-mask"></div>
                <div id="wheel-column" class="wheel-column max-h-56 overflow-y-auto no-scrollbar py-3 space-y-1 text-center text-lg font-mono text-stone-400">
                    <!-- 动态填充数字 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 自定义确认弹窗 -->
    <!-- 日期筛选弹出层 -->
    <div id="date-filter-overlay" class="fixed inset-0 z-50 hidden wheel-overlay-backdrop flex items-center justify-center px-4">
        <div class="bg-stone-900 border border-stone-800 rounded-2xl shadow-xl p-4 w-full max-w-sm mx-auto box-border">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-sm font-bold text-stone-200">日期筛选</h3>
                <button onclick="toggleDateFilter()" class="text-stone-500 hover:text-stone-300 p-1">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] text-stone-500 uppercase mb-2 block font-medium">开始日期</label>
                    <div class="relative w-full">
                        <input 
                            type="date" 
                            id="filter-date-start" 
                            class="block w-full box-border appearance-none bg-stone-800 border border-stone-700 text-stone-300 text-sm rounded-lg px-3 py-2.5 focus:outline-none focus:border-amber-500 focus:ring-1 focus:ring-amber-500 transition-colors"
                            onchange="setDateFilter('start', this.value)"
                            style="color-scheme: dark;" 
                        >
                    </div>
                </div>
                <div>
                    <label class="text-[10px] text-stone-500 uppercase mb-2 block font-medium">结束日期</label>
                    <div class="relative w-full">
                        <input 
                            type="date" 
                            id="filter-date-end" 
                            class="block w-full box-border appearance-none bg-stone-800 border border-stone-700 text-stone-300 text-sm rounded-lg px-3 py-2.5 focus:outline-none focus:border-amber-500 focus:ring-1 focus:ring-amber-500 transition-colors"
                            onchange="setDateFilter('end', this.value)"
                            style="color-scheme: dark;" 
                        >
                    </div>
                </div>
                
                <div class="flex gap-3 pt-2">
                    <button onclick="clearDateFilter()" class="flex-1 px-4 py-2.5 rounded-xl text-xs font-bold bg-stone-800 border border-stone-700 text-stone-400 hover:bg-stone-700 transition-all active:scale-95">清除</button>
                    <button onclick="toggleDateFilter()" class="flex-1 px-4 py-2.5 rounded-xl text-xs font-bold bg-amber-600 text-white hover:bg-amber-500 border border-amber-600 transition-all active:scale-95 shadow-lg shadow-amber-900/20">确定</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 咖啡豆选择弹出层 -->
    <div id="bean-select-overlay" class="fixed inset-0 z-50 hidden wheel-overlay-backdrop flex items-center justify-center px-4">
        <div class="bg-stone-900 border border-stone-800 rounded-2xl shadow-xl p-4 w-full max-w-sm max-h-[80vh] flex flex-col">
            <div class="flex items-center justify-between mb-4 flex-shrink-0">
                <h3 class="text-sm font-bold text-stone-200">选择咖啡豆</h3>
                <button onclick="hideBeanDropdown()" class="text-stone-500 hover:text-stone-300">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
            <div class="mb-3 flex-shrink-0">
                <input 
                    type="text" 
                    id="bean-search-overlay-input" 
                    placeholder="搜索咖啡豆..." 
                    class="w-full px-3 py-2 rounded-lg text-sm bg-stone-800 border border-stone-700 text-stone-300 placeholder-stone-600 focus:outline-none focus:border-amber-500 transition-colors"
                    oninput="filterBeanDropdown(this.value)"
                >
            </div>
            <div id="bean-select-list" class="flex-1 overflow-y-auto space-y-1 min-h-0">
                <!-- 列表项将通过 JavaScript 动态生成 -->
            </div>
        </div>
    </div>

    <div id="confirm-overlay" class="fixed inset-0 z-50 hidden wheel-overlay-backdrop flex items-center justify-center px-4">
        <div class="w-full bg-stone-900 border border-stone-800 rounded-2xl p-6 shadow-2xl mx-4">
            <div class="flex items-center gap-3 mb-4">
                <div id="confirm-icon" class="w-10 h-10 rounded-full bg-red-500/20 flex items-center justify-center flex-shrink-0">
                    <i data-lucide="alert-triangle" class="w-5 h-5 text-red-500"></i>
                </div>
                <h3 id="confirm-title" class="text-lg font-bold text-stone-200">确认删除</h3>
            </div>
            <p id="confirm-message" class="text-sm text-stone-400 mb-6 leading-relaxed"></p>
            <div class="flex gap-3">
                <button id="confirm-cancel" class="flex-1 px-4 py-3 rounded-xl bg-stone-800 hover:bg-stone-700 text-stone-300 font-medium transition-colors active:scale-95 flex items-center justify-center">取消</button>
                <button id="confirm-ok" class="flex-1 px-4 py-3 rounded-xl bg-red-600 hover:bg-red-700 text-white font-medium transition-colors active:scale-95 flex items-center justify-center">删除</button>
            </div>
        </div>
    </div>

    <!-- 图片预览模态框 -->
    <div id="image-preview-overlay" class="fixed inset-0 z-50 hidden wheel-overlay-backdrop flex items-center justify-center px-4" onclick="closeImagePreview()">
        <div class="relative max-w-full max-h-[90vh] flex items-center justify-center" onclick="event.stopPropagation()">
            <button onclick="closeImagePreview()" class="absolute -top-10 right-0 text-white hover:text-stone-300 p-2 transition-colors">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            <img id="image-preview-img" src="" alt="预览" class="max-w-full max-h-[90vh] object-contain rounded-lg shadow-2xl">
        </div>
    </div>

    <!-- 资产添加/编辑弹窗 -->
    <div id="asset-form-modal" class="fixed inset-0 z-50 hidden wheel-overlay-backdrop flex items-center justify-center px-4" onclick="if(event.target===this) hideAssetFormModal()">
        <div class="bg-stone-900 border border-stone-800 rounded-2xl shadow-xl p-5 w-full max-w-md max-h-[90vh] overflow-y-auto box-border" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 id="asset-form-title" class="text-sm font-bold text-stone-200 flex items-center gap-1">
                    <i data-lucide="plus-circle" class="w-4"></i> 添加新项目
                </h3>
                <button onclick="hideAssetFormModal()" class="text-stone-500 hover:text-stone-300 p-1">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div class="flex gap-3 items-start min-w-0">
                    <div class="relative w-20 h-20 bg-stone-800 rounded-xl border border-stone-700 overflow-hidden flex-shrink-0 cursor-pointer flex items-center justify-center text-stone-600 hover:border-amber-500 transition-colors">
                        <img id="new-asset-preview" class="w-full h-full object-cover hidden">
                        <i data-lucide="image" class="w-6" id="new-asset-icon"></i>
                        <input type="file" id="new-asset-image" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer">
                    </div>
                    
                    <div class="flex-1 space-y-3 min-w-0">
                        <div>
                            <label class="text-[10px] font-bold text-stone-500 uppercase mb-1 block">名称</label>
                            <input id="new-asset-name" class="block w-full appearance-none bg-[#0a0a0a] border border-stone-800 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-amber-600 min-w-0 box-border">
                        </div>
                        <select id="new-asset-roast" class="block w-full appearance-none bg-[#0a0a0a] border border-stone-800 rounded-lg px-3 py-2 text-xs text-stone-300 focus:outline-none hidden min-w-0 box-border">
                            <option>浅烘</option><option>中浅</option><option selected>中烘</option><option>中深</option><option>深烘</option>
                        </select>
                    </div>
                </div>

                <div id="roast-date-field" class="hidden w-full">
                    <label class="text-[10px] font-bold text-stone-500 uppercase mb-1 block">烘焙日期</label>
                    <div class="relative w-full">
                        <input id="new-asset-roast-date" type="date" class="block w-full appearance-none bg-[#0a0a0a] border border-stone-800 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-amber-600 min-w-0 box-border" style="color-scheme: dark;">
                    </div>
                </div>

                <div id="recommended-params-field" class="hidden space-y-2 w-full">
                    <label class="text-[10px] font-bold text-stone-500 uppercase mb-1 block">推荐参数</label>
                    <div class="grid grid-cols-2 gap-3 w-full">
                        <div class="min-w-0 w-full">
                            <label class="text-[9px] text-stone-600 mb-0.5 block truncate">推荐粉量 (g)</label>
                            <input id="new-asset-recommended-dose" type="number" inputmode="decimal" step="0.1" min="0" placeholder="18.0" class="block w-full appearance-none bg-[#0a0a0a] border border-stone-800 rounded-lg px-2 py-2 text-xs text-white focus:outline-none focus:border-amber-600 min-w-0 box-border">
                        </div>
                        <div class="min-w-0 w-full">
                            <label class="text-[9px] text-stone-600 mb-0.5 block truncate">推荐水温 (°C)</label>
                            <input id="new-asset-recommended-temp" type="number" inputmode="numeric" step="1" min="0" placeholder="93" class="block w-full appearance-none bg-[#0a0a0a] border border-stone-800 rounded-lg px-2 py-2 text-xs text-white focus:outline-none focus:border-amber-600 min-w-0 box-border">
                        </div>
                        <div class="min-w-0 w-full">
                            <label class="text-[9px] text-stone-600 mb-0.5 block truncate">推荐时间 (s)</label>
                            <input id="new-asset-recommended-time" type="number" inputmode="numeric" step="1" min="0" placeholder="25" class="block w-full appearance-none bg-[#0a0a0a] border border-stone-800 rounded-lg px-2 py-2 text-xs text-white focus:outline-none focus:border-amber-600 min-w-0 box-border">
                        </div>
                        <div class="min-w-0 w-full">
                            <label class="text-[9px] text-stone-600 mb-0.5 block truncate">推荐液重 (g)</label>
                            <input id="new-asset-recommended-yield" type="number" inputmode="decimal" step="0.1" min="0" placeholder="36.0" class="block w-full appearance-none bg-[#0a0a0a] border border-stone-800 rounded-lg px-2 py-2 text-xs text-white focus:outline-none focus:border-amber-600 min-w-0 box-border">
                        </div>
                    </div>
                </div>

                <!-- 自定义赏味周期（仅咖啡豆，默认折叠） -->
                <div id="bean-custom-periods-field" class="hidden w-full">
                    <button type="button" onclick="toggleBeanCustomPeriods()" class="w-full flex items-center justify-between px-3 py-2 bg-stone-800/50 border border-stone-700 rounded-lg hover:bg-stone-800 transition-colors">
                        <span class="text-[10px] font-bold text-stone-400 uppercase">自定义赏味周期（高级）</span>
                        <i data-lucide="chevron-down" id="bean-custom-periods-chevron" class="w-4 h-4 text-stone-500 transition-transform"></i>
                    </button>
                    <div id="bean-custom-periods-content" class="hidden mt-2 space-y-2 p-3 bg-stone-800/30 border border-stone-700 rounded-lg">
                        <p class="text-[10px] text-stone-500 mb-3">为这款豆子单独设置赏味周期参数，将覆盖全局设置</p>
                        <div id="bean-custom-periods-inputs" class="space-y-3">
                            <!-- 内容将通过 JavaScript 动态生成 -->
                        </div>
                    </div>
                </div>

                <div id="asset-extra-fields" class="grid grid-cols-2 gap-3 hidden w-full">
                    <div class="min-w-0 w-full">
                        <label id="asset-total-label" class="text-[10px] font-bold text-stone-500 uppercase mb-1 block">总量 (g)</label>
                        <input id="new-asset-total" type="number" inputmode="decimal" step="0.1" min="0" class="block w-full appearance-none bg-[#0a0a0a] border border-stone-800 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-amber-600 min-w-0 box-border">
                    </div>
                    <div class="min-w-0 w-full">
                        <label id="asset-price-label" class="text-[10px] font-bold text-stone-500 uppercase mb-1 block">价格 (¥)</label>
                        <input id="new-asset-price" type="number" inputmode="decimal" step="0.01" min="0" class="block w-full appearance-none bg-[#0a0a0a] border border-stone-800 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-amber-600 min-w-0 box-border">
                    </div>
                </div>
                
                <div>
                    <label class="text-[10px] font-bold text-stone-500 uppercase mb-1 block">备注</label>
                    <textarea id="new-asset-notes" class="block w-full appearance-none bg-[#0a0a0a] border border-stone-800 rounded-lg px-3 py-2 text-sm text-stone-300 focus:outline-none focus:border-amber-600 resize-none min-h-[60px] min-w-0 box-border"></textarea>
                </div>
                
                <div class="flex gap-3 pt-2">
                    <button onclick="hideAssetFormModal()" class="flex-1 px-4 py-2.5 rounded-xl text-xs font-bold bg-stone-800 border border-stone-700 text-stone-400 hover:bg-stone-700 transition-all active:scale-95">取消</button>
                    <button id="asset-submit-btn" onclick="addAsset()" class="flex-1 px-4 py-2.5 rounded-xl text-xs font-bold bg-amber-600 text-white hover:bg-amber-500 border border-amber-600 transition-all active:scale-95 shadow-lg shadow-amber-900/20">确认添加</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 修改剩余豆量弹窗 -->
    <div id="adjust-bean-weight-modal" class="fixed inset-0 z-50 hidden wheel-overlay-backdrop flex items-center justify-center px-4" onclick="if(event.target===this) hideAdjustBeanWeightModal()">
        <div class="bg-stone-900 border border-stone-800 rounded-2xl shadow-xl p-5 w-full max-w-sm mx-auto box-border" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-sm font-bold text-stone-200">调整剩余豆量</h3>
                <button onclick="hideAdjustBeanWeightModal()" class="text-stone-500 hover:text-stone-300 p-1">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-bold text-stone-500 uppercase mb-1 block">已用量 (g)</label>
                    <input type="number" id="adjust-bean-used" inputmode="decimal" step="0.1" min="0" class="w-full bg-[#0a0a0a] border border-stone-800 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-amber-600">
                    <p class="text-[10px] text-stone-600 mt-1">调整已用量以修改剩余量</p>
                </div>
                <div class="flex gap-3 pt-2">
                    <button onclick="hideAdjustBeanWeightModal()" class="flex-1 px-4 py-2.5 rounded-xl text-xs font-bold bg-stone-800 border border-stone-700 text-stone-400 hover:bg-stone-700 transition-all active:scale-95">取消</button>
                    <button onclick="confirmAdjustBeanWeight()" class="flex-1 px-4 py-2.5 rounded-xl text-xs font-bold bg-amber-600 text-white hover:bg-amber-500 border border-amber-600 transition-all active:scale-95 shadow-lg shadow-amber-900/20">确认</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 赏味周期配置弹窗 -->
    <div id="roast-periods-config-modal" class="fixed inset-0 z-50 hidden wheel-overlay-backdrop flex items-center justify-center px-4" onclick="if(event.target===this) hideRoastPeriodsConfig()">
        <div class="bg-stone-900 border border-stone-800 rounded-2xl shadow-xl p-5 w-full max-w-md mx-auto box-border max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-sm font-bold text-stone-200 flex items-center gap-1">
                    <i data-lucide="settings" class="w-4"></i> 赏味周期配置
                </h3>
                <button onclick="hideRoastPeriodsConfig()" class="text-stone-500 hover:text-stone-300 p-1">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
            <div id="roast-periods-config-content" class="space-y-4">
                <!-- 内容将通过 JavaScript 动态生成 -->
            </div>
        </div>
    </div>

    <!-- 咖啡豆详情弹窗 -->
    <div id="bean-detail-modal" class="fixed inset-0 z-50 hidden wheel-overlay-backdrop flex items-center justify-center px-4" onclick="if(event.target===this) hideBeanDetailModal()">
        <div class="bg-stone-900 border border-stone-800 rounded-2xl shadow-xl p-5 w-full max-w-sm mx-auto box-border max-h-[85vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-sm font-bold text-stone-200">咖啡豆详情</h3>
                <button onclick="hideBeanDetailModal()" class="text-stone-500 hover:text-stone-300 p-1">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
            <div id="bean-detail-content" class="space-y-4">
                <!-- 内容将通过 JavaScript 动态生成 -->
            </div>
        </div>
    </div>

    <!-- 历史记录详情弹窗 -->
    <div id="log-detail-modal" class="fixed inset-0 z-50 hidden wheel-overlay-backdrop flex items-center justify-center px-4" onclick="if(event.target===this) hideLogDetailModal()">
        <div class="bg-stone-900 border border-stone-800 rounded-2xl shadow-xl p-5 w-full max-w-md mx-auto box-border max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-sm font-bold text-stone-200">记录详情</h3>
                <button onclick="hideLogDetailModal()" class="text-stone-500 hover:text-stone-300 p-1">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
            <div id="log-detail-content" class="space-y-4">
                <!-- 内容将通过 JavaScript 动态生成 -->
            </div>
        </div>
    </div>

    <!-- 历史记录编辑弹窗 -->
    <div id="log-edit-modal" class="fixed inset-0 z-50 hidden wheel-overlay-backdrop flex items-center justify-center px-4" onclick="if(event.target===this) hideLogEditModal()">
        <div class="bg-stone-900 border border-stone-800 rounded-2xl shadow-xl p-5 w-full max-w-md mx-auto box-border max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-sm font-bold text-stone-200 flex items-center gap-1">
                    <i data-lucide="edit-2" class="w-4"></i> 编辑记录
                </h3>
                <button onclick="hideLogEditModal()" class="text-stone-500 hover:text-stone-300 p-1">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
            <div id="log-edit-content" class="space-y-4">
                <!-- 内容将通过 JavaScript 动态生成 -->
            </div>
        </div>
    </div>

    <!-- 底部导航栏 -->
    <nav class="fixed bottom-0 left-0 right-0 w-full max-w-md mx-auto z-40 bg-[#0c0c0c]/95 backdrop-blur-lg border-t border-white/5 px-6 pt-2 pb-1 flex justify-between items-center safe-bottom">
        <button onclick="switchTab('record')" class="nav-btn flex flex-col items-center gap-1 text-amber-500 transition-colors group p-1" data-target="record">
            <i data-lucide="plus-circle" class="w-8 h-8 stroke-[1.5]"></i>
        </button>

        <button onclick="switchTab('history')" class="nav-btn flex flex-col items-center gap-1 text-stone-600 transition-colors hover:text-stone-300 group p-1" data-target="history">
            <i data-lucide="clipboard-list" class="w-8 h-8 stroke-[1.5]"></i>
        </button>

        <button onclick="switchTab('gear')" class="nav-btn flex flex-col items-center gap-1 text-stone-600 transition-colors hover:text-stone-300 group p-1" data-target="gear">
            <i data-lucide="layout-grid" class="w-8 h-8 stroke-[1.5]"></i>
        </button>
    </nav>

    <!-- 核心逻辑脚本 -->
    <script>
        const DB = {
            logs: JSON.parse(localStorage.getItem('el_logs') || '[]'),
            beans: JSON.parse(localStorage.getItem('el_beans') || '[]'),
            grinders: JSON.parse(localStorage.getItem('el_grinders') || '[]'),
            machines: JSON.parse(localStorage.getItem('el_machines') || '[]'),
            milks: JSON.parse(localStorage.getItem('el_milks') || '[]'),
            customTags: JSON.parse(localStorage.getItem('el_custom_tags') || '[]'),
            deletedDefaultTags: JSON.parse(localStorage.getItem('el_deleted_default_tags') || '[]'),
            prefs: JSON.parse(localStorage.getItem('el_prefs') || '{}'),
            customRoastPeriods: JSON.parse(localStorage.getItem('el_custom_roast_periods') || 'null')
        };

        /**
         * 渲染图标，必要时重试并兜底占位
         * @param {number} attempt - 当前重试次数
         * @returns {void}
         */
        function renderIconsWithRetry(attempt = 0) {
            const MAX_ATTEMPTS = 3;
            if (window.lucide && typeof window.lucide.createIcons === 'function') {
                window.lucide.createIcons();
                return;
            }
            if (attempt >= MAX_ATTEMPTS) {
                document.querySelectorAll('[data-lucide]').forEach(el => {
                    if (!el.dataset.fallback) {
                        el.dataset.fallback = '1';
                        el.textContent = '•';
                    }
                });
                console.warn('lucide 未加载，已显示占位符');
                return;
            }
            setTimeout(() => renderIconsWithRetry(attempt + 1), 300);
        }

        if (DB.beans.length === 0 && DB.machines.length === 0) {
            // 计算7天前的日期作为示例烘焙日期
            const roastDate = new Date();
            roastDate.setDate(roastDate.getDate() - 7);
            const roastDateStr = roastDate.toISOString().split('T')[0];
            
            DB.beans = [{id: "b_demo", name: "我的咖啡豆", roast: "中深", image: null, notes: '', totalWeight: 500, price: 120, roastDate: roastDateStr, manualUsed: undefined}];
            DB.machines = [{id: "m_demo", name: "我的咖啡机", notes: '', image: null}];
            DB.grinders = [{id: "g_demo", name: "我的磨豆机", notes: '', image: null}];
            DB.milks = [{id: "milk_demo", name: "我的牛奶", notes: '', totalWeight: 1000, price: 25, image: null}];
        }

        const STATE = {
            currentTab: 'record',
            currentGearTab: 'beans',
            currentRating: 0,
            isGodShot: false,
            selectedTags: [],
            newAssetImage: null,
            newLogImage: null,
            editingLogId: null,
            editingAssetType: null,
            editingAssetId: null,
            deleteContext: null,
            beanSort: 'roastDate-desc', // 默认排序：烘焙日期新→旧
            adjustingBeanId: null, // 正在调整剩余量的豆子ID
            editLogRating: 0,
            editLogTags: [],
            editLogGodShot: false
        };

        const DEFAULT_TAGS = [
        // 风味
        '焦糖', '坚果', '太妃糖', '巧克力', '烘焙味重', '苦味强', '甜感好',

        // 奶咖平衡
        '比例均衡', '奶味偏重', '咖啡感弱', '咖啡感足',

        // 口感
        '醇厚', '顺滑', '层次好', '尾韵长', '偏薄',

        // 流速
        '流速正常', '流速快', '流速慢',

        // 萃取问题
        '通道效应', '喷涌', '过萃', '欠萃'
        ];

        /**
         * 计算单位成本（元/克或元/毫升）
         * @param {number} totalWeight - 包装总量
         * @param {number} price - 包装价格
         * @returns {number} 单位成本，若数据不足返回 0
         */
        function getUnitCost(totalWeight, price) {
            const total = parseFloat(totalWeight);
            const pkgPrice = parseFloat(price);
            if (Number.isNaN(total) || Number.isNaN(pkgPrice) || total <= 0 || pkgPrice < 0) return 0;
            return pkgPrice / total;
        }

        /**
         * 计算单杯成本
         * @param {{ bean: any, milk: any, dose: number, milkWeight: number }} params - 成本参数
         * @returns {{ beanCost: number, milkCost: number, totalCost: number }} 成本结果
         */
        function computeCupCost({ bean, milk, dose, milkWeight }) {
            const beanUnit = bean ? getUnitCost(bean.totalWeight, bean.price) : 0;
            const milkUnit = milk ? getUnitCost(milk.totalWeight, milk.price) : 0;
            const doseVal = Number.isFinite(dose) ? dose : 0;
            const milkVal = Number.isFinite(milkWeight) ? milkWeight : 0;
            const beanCost = Math.max(0, beanUnit * doseVal);
            const milkCost = Math.max(0, milkUnit * milkVal);
            const totalCost = beanCost + milkCost;
            return {
                beanCost: Number(beanCost.toFixed(2)),
                milkCost: Number(milkCost.toFixed(2)),
                totalCost: Number(totalCost.toFixed(2))
            };
        }

        /**
         * 统计某个豆子的使用与剩余
         * @param {{ id: string, totalWeight?: number, manualUsed?: number }} bean - 豆子对象
         * @returns {{ used: number, remaining: number, total: number }} 用量信息
         */
        function getBeanRemaining(bean) {
            if (!bean || !bean.id) return { used: 0, remaining: 0, total: 0 };
            const total = parseFloat(bean.totalWeight) || 0;
            // 优先使用手动调整的已用量，否则从记录中计算
            let used = 0;
            if (typeof bean.manualUsed === 'number' && bean.manualUsed >= 0) {
                used = bean.manualUsed;
            } else {
                used = DB.logs.reduce((sum, log) => {
                    if (log.beanId === bean.id) {
                        const dose = parseFloat(log.dose) || 0;
                        return sum + dose;
                    }
                    return sum;
                }, 0);
            }
            const remaining = Math.max(0, total - used);
            return {
                used: Number(used.toFixed(1)),
                remaining: Number(remaining.toFixed(1)),
                total: Number(total.toFixed(1))
            };
        }

        /**
         * 将金额格式化为人民币文本
         * @param {number} amount - 金额
         * @returns {string} 格式化文本
         */
        function formatCurrency(amount) {
            const num = parseFloat(String(amount));
            if (Number.isNaN(num) || num <= 0) return '-';
            return `¥${num.toFixed(2)}`;
        }

        /**
         * 计算距离烘焙的天数
         * @param {string} roastDate - 烘焙日期（YYYY-MM-DD）
         * @param {string|Date|null} referenceDate - 参考日期（YYYY-MM-DD 或 Date对象），默认为当前日期
         * @returns {number|null} 天数，缺省返回 null
         */
        function getRoastDays(roastDate, referenceDate = null) {
            if (!roastDate) return null;
            const roast = new Date(roastDate);
            if (Number.isNaN(roast.getTime())) return null;
            
            // 如果没有提供参考日期，使用当前日期
            let refDate = referenceDate;
            if (!refDate) {
                refDate = new Date();
            } else if (typeof refDate === 'string') {
                refDate = new Date(refDate);
            }
            
            if (Number.isNaN(refDate.getTime())) return null;
            
            const diff = refDate.setHours(0,0,0,0) - roast.setHours(0,0,0,0);
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            return Math.max(0, days);
        }

        /**
         * 赏味周期配置数据
         * @type {Object}
         */
        const ROAST_PERIODS = {
            '浅烘': {养豆期: [14, 21], 最佳赏味期: [21, 60], 赏味期: [0, 90], 赏味衰退期: [90, Infinity]},
            '中浅': {养豆期: [10, 14], 最佳赏味期: [14, 50], 赏味期: [0, 70], 赏味衰退期: [75, Infinity]},
            '中烘': {养豆期: [7, 10], 最佳赏味期: [10, 40], 赏味期: [0, 50], 赏味衰退期: [60, Infinity]},
            '中深': {养豆期: [5, 7], 最佳赏味期: [7, 30], 赏味期: [0, 40], 赏味衰退期: [40, Infinity]},
            '深烘': {养豆期: [4, 6], 最佳赏味期: [6, 25], 赏味期: [0, 30], 赏味衰退期: [30, Infinity]},
            '深烘焙': {养豆期: [4, 6], 最佳赏味期: [6, 25], 赏味期: [0, 30], 赏味衰退期: [30, Infinity]}
        };

        /**
         * 获取赏味周期参数（优先使用豆子特定配置，然后是全局自定义，最后是默认）
         * @param {string|null} beanId - 咖啡豆ID，如果提供则优先使用该豆子的特定配置
         * @returns {Object} 赏味周期配置对象
         */
        function getRoastPeriods(beanId = null) {
            let basePeriods = ROAST_PERIODS;
            
            // 1. 如果有全局自定义配置，先合并
            if (DB.customRoastPeriods && typeof DB.customRoastPeriods === 'object') {
                basePeriods = { ...ROAST_PERIODS };
                Object.keys(DB.customRoastPeriods).forEach(key => {
                    if (ROAST_PERIODS[key]) {
                        basePeriods[key] = { ...ROAST_PERIODS[key], ...DB.customRoastPeriods[key] };
                    }
                });
            }
            
            // 2. 如果有豆子ID，优先使用豆子特定的配置
            if (beanId) {
                const bean = DB.beans.find(b => b.id === beanId);
                if (bean && bean.customRoastPeriods && typeof bean.customRoastPeriods === 'object') {
                    const beanPeriods = { ...basePeriods };
                    // 只覆盖该豆子烘焙度的配置
                    const roastKey = bean.roast;
                    if (roastKey && basePeriods[roastKey]) {
                        beanPeriods[roastKey] = { ...basePeriods[roastKey], ...bean.customRoastPeriods };
                    }
                    return beanPeriods;
                }
            }
            
            return basePeriods;
        }

        /**
         * 根据烘焙度和天数获取赏味阶段信息
         * @param {string} roast - 烘焙度
         * @param {number|null} days - 烘焙后天数
         * @param {string|null} beanId - 咖啡豆ID，用于获取豆子特定的配置
         * @returns {{stage: string, text: string, color: string}|null} 阶段信息
         */
        function getRoastStage(roast, days, beanId = null) {
            if (!roast || days === null || days === undefined) return null;
            
            // 标准化烘焙度名称
            const roastKey = roast.includes('浅') && !roast.includes('中') ? '浅烘' :
                           roast.includes('中浅') ? '中浅' :
                           roast.includes('中深') ? '中深' :
                           roast.includes('深') ? '深烘' :
                           roast.includes('中') ? '中烘' : null;
            
            const periodsMap = getRoastPeriods(beanId);
            if (!roastKey || !periodsMap[roastKey]) return null;
            
            const periods = periodsMap[roastKey];
            
            // 判断当前处于哪个阶段（按优先级：养豆期 > 最佳赏味期 > 赏味衰退期 > 赏味期）
            if (days >= periods.养豆期[0] && days < periods.养豆期[1]) {
                return {stage: '养豆期', text: '养豆期', color: '#3b82f6'}; // 蓝色
            } else if (days >= periods.最佳赏味期[0] && days < periods.最佳赏味期[1]) {
                return {stage: '最佳赏味期', text: '最佳赏味期', color: '#10b981'}; // 绿色
            } else if (days >= periods.赏味衰退期[0]) {
                return {stage: '赏味衰退期', text: '赏味衰退期', color: '#ef4444'}; // 红色
            } else if (days < periods.赏味期[1]) {
                return {stage: '赏味期', text: '赏味期', color: '#f59e0b'}; // 琥珀色
            }
            
            return null;
        }

        /**
         * 计算豆子生命周期进度
         * @param {string} roast - 烘焙度
         * @param {number|null} days - 烘焙后天数
         * @param {string|null} beanId - 咖啡豆ID，用于获取豆子特定的配置
         * @returns {{progress: number, currentStage: string, color: string, maxDays: number, currentStageDays: number, nextStageDays: number, currentStageEnd: number, nextStageName: string}|null} 进度信息
         */
        function getLifecycleProgress(roast, days, beanId = null) {
            if (!roast || days === null || days === undefined) return null;
            
            // 标准化烘焙度名称
            const roastKey = roast.includes('浅') && !roast.includes('中') ? '浅烘' :
                           roast.includes('中浅') ? '中浅' :
                           roast.includes('中深') ? '中深' :
                           roast.includes('深') ? '深烘' :
                           roast.includes('中') ? '中烘' : null;
            
            const periodsMap = getRoastPeriods(beanId);
            if (!roastKey || !periodsMap[roastKey]) return null;
            
            const periods = periodsMap[roastKey];
            const stageInfo = getRoastStage(roast, days, beanId);
            
            // 计算最大天数（赏味衰退期的开始）
            const maxDays = periods.赏味衰退期[0];
            
            // 计算进度百分比（0-100）
            let progress = 0;
            if (days < 0) {
                progress = 0;
            } else if (days >= maxDays) {
                progress = 100;
            } else {
                progress = (days / maxDays) * 100;
            }
            
            // 计算当前阶段信息
            let currentStageDays = 0; // 当前阶段已过天数
            let currentStageEnd = 0; // 当前阶段结束天数
            let nextStageName = ''; // 下一个阶段名称
            let nextStageDays = 0; // 距离下一个阶段的天数
            
            if (stageInfo) {
                const stage = stageInfo.stage;
                
                if (stage === '养豆期') {
                    currentStageEnd = periods.养豆期[1];
                    nextStageName = '最佳赏味期';
                    nextStageDays = Math.max(0, currentStageEnd - days);
                    currentStageDays = days - periods.养豆期[0];
                } else if (stage === '最佳赏味期') {
                    currentStageEnd = periods.最佳赏味期[1];
                    nextStageName = '赏味衰退期';
                    nextStageDays = Math.max(0, currentStageEnd - days);
                    currentStageDays = days - periods.最佳赏味期[0];
                } else if (stage === '赏味期') {
                    // 赏味期可能在最佳赏味期之前或之后
                    if (days < periods.最佳赏味期[0]) {
                        // 在最佳赏味期之前
                        currentStageEnd = periods.最佳赏味期[0];
                        nextStageName = '最佳赏味期';
                        nextStageDays = Math.max(0, currentStageEnd - days);
                        currentStageDays = days;
                    } else {
                        // 在最佳赏味期之后，但还在赏味期内
                        currentStageEnd = periods.赏味期[1];
                        nextStageName = '赏味衰退期';
                        nextStageDays = Math.max(0, currentStageEnd - days);
                        currentStageDays = days - periods.最佳赏味期[1];
                    }
                } else if (stage === '赏味衰退期') {
                    currentStageEnd = Infinity;
                    nextStageName = '';
                    nextStageDays = 0;
                    currentStageDays = days - periods.赏味衰退期[0];
                }
            }
            
            return {
                progress: Math.min(100, Math.max(0, progress)),
                currentStage: stageInfo ? stageInfo.stage : '未知',
                color: stageInfo ? stageInfo.color : '#6b7280',
                maxDays: maxDays,
                currentStageDays: Math.max(0, currentStageDays),
                nextStageDays: nextStageDays,
                currentStageEnd: currentStageEnd,
                nextStageName: nextStageName
            };
        }

        /**
         * 按烘焙日期排序咖啡豆（新→旧，无日期排最后）
         * @param {Array} beans - 豆子列表
         * @returns {Array} 已排序列表
         */
        function sortBeansByRoastDate(beans) {
            return [...beans].sort((a, b) => {
                const ad = a.roastDate ? new Date(a.roastDate).getTime() : -Infinity;
                const bd = b.roastDate ? new Date(b.roastDate).getTime() : -Infinity;
                if (ad === bd) return 0;
                if (ad === -Infinity) return 1;
                if (bd === -Infinity) return -1;
                return bd - ad; // 新→旧
            });
        }

        /**
         * 根据当前排序设置对咖啡豆进行排序
         * @param {Array} beans - 豆子列表
         * @returns {Array} 已排序列表
         */
        function sortBeans(beans) {
            const sortType = STATE.beanSort || 'roastDate-desc';
            const [field, order] = sortType.split('-');
            
            return [...beans].sort((a, b) => {
                if (field === 'roastDate') {
                    const ad = a.roastDate ? new Date(a.roastDate).getTime() : -Infinity;
                    const bd = b.roastDate ? new Date(b.roastDate).getTime() : -Infinity;
                    if (ad === bd) return 0;
                    if (ad === -Infinity) return 1;
                    if (bd === -Infinity) return -1;
                    return order === 'desc' ? bd - ad : ad - bd;
                } else if (field === 'name') {
                    const aName = (a.name || '').toLowerCase();
                    const bName = (b.name || '').toLowerCase();
                    if (aName === bName) return 0;
                    return order === 'asc' ? (aName < bName ? -1 : 1) : (aName > bName ? -1 : 1);
                } else if (field === 'remaining') {
                    const aRemain = getBeanRemaining(a).remaining;
                    const bRemain = getBeanRemaining(b).remaining;
                    return order === 'desc' ? bRemain - aRemain : aRemain - bRemain;
                } else if (field === 'price') {
                    const aPrice = parseFloat(a.price) || 0;
                    const bPrice = parseFloat(b.price) || 0;
                    return order === 'desc' ? bPrice - aPrice : aPrice - bPrice;
                }
                return 0;
            });
        }

        /**
         * 切换咖啡豆排序方式（点击同一字段切换升序/降序，点击不同字段切换到该字段）
         * @param {string} field - 排序字段
         * @returns {void}
         */
        function toggleBeanSort(field) {
            const currentSort = STATE.beanSort || 'roastDate-desc';
            const [currentField, currentOrder] = currentSort.split('-');
            
            let newSort;
            if (currentField === field) {
                // 如果点击的是当前字段，切换排序方向
                newSort = currentOrder === 'desc' ? `${field}-asc` : `${field}-desc`;
            } else {
                // 如果点击的是不同字段，切换到该字段的默认排序（降序）
                newSort = `${field}-desc`;
            }
            
            STATE.beanSort = newSort;
            saveData();
            renderGearList();
            updateBeanSortButtons();
        }

        /**
         * 设置咖啡豆排序方式（兼容旧代码）
         * @param {string} sortType - 排序类型
         * @returns {void}
         */
        function setBeanSort(sortType) {
            STATE.beanSort = sortType;
            saveData();
            renderGearList();
            updateBeanSortButtons();
        }

        /**
         * 更新排序按钮样式
         * @returns {void}
         */
        function updateBeanSortButtons() {
            const currentSort = STATE.beanSort || 'roastDate-desc';
            const [currentField, currentOrder] = currentSort.split('-');
            
            // 定义按钮文本映射
            const buttonTexts = {
                'roastDate': '烘焙日期',
                'name': '名称',
                'remaining': '剩余量',
                'price': '价格'
            };
            
            document.querySelectorAll('.bean-sort-btn').forEach(btn => {
                const field = btn.dataset.field;
                if (!field) return; // 跳过没有data-field的按钮（旧按钮）
                
                const baseText = buttonTexts[field] || field;
                
                if (field === currentField) {
                    // 当前选中的字段，显示高亮样式和排序方向
                    const arrow = currentOrder === 'desc' ? ' ↓' : ' ↑';
                    btn.textContent = baseText + arrow;
                    btn.className = 'bean-sort-btn flex-shrink-0 px-3 py-1.5 rounded-full text-xs font-medium border transition-colors bg-stone-800 text-amber-500 border-amber-500/50';
                } else {
                    // 未选中的字段，显示默认样式
                    btn.textContent = baseText;
                    btn.className = 'bean-sort-btn flex-shrink-0 px-3 py-1.5 rounded-full text-xs font-medium border transition-colors bg-stone-900 border-stone-800 text-stone-400 hover:bg-stone-800';
                }
            });
        }

        function saveData() {
            try {
                // 保存前检查存储空间
                const storageInfo = checkStorageSpace();
                if (storageInfo.isNearLimit) {
                    console.warn('存储空间接近限制:', getStorageInfo());
                }
                
                localStorage.setItem('el_logs', JSON.stringify(DB.logs));
                localStorage.setItem('el_beans', JSON.stringify(DB.beans));
                localStorage.setItem('el_grinders', JSON.stringify(DB.grinders));
                localStorage.setItem('el_machines', JSON.stringify(DB.machines));
                localStorage.setItem('el_milks', JSON.stringify(DB.milks));
                localStorage.setItem('el_custom_tags', JSON.stringify(DB.customTags));
                localStorage.setItem('el_deleted_default_tags', JSON.stringify(DB.deletedDefaultTags));
                localStorage.setItem('el_prefs', JSON.stringify(DB.prefs));
                if (DB.customRoastPeriods !== null) {
                    localStorage.setItem('el_custom_roast_periods', JSON.stringify(DB.customRoastPeriods));
                } else {
                    localStorage.removeItem('el_custom_roast_periods');
                }
                
                // 保存后更新存储空间显示（如果在备份页面）
                if (STATE.currentGearTab === 'backup') {
                    updateStorageInfo();
                }
            } catch (e) { 
                const storageInfo = checkStorageSpace();
                if (storageInfo.percentage > 95) {
                    showAlert("存储空间已满，无法保存！\n\n建议：\n1. 导出备份\n2. 删除部分旧记录或图片\n3. 清理浏览器缓存");
                } else {
                showAlert("存储空间不足，无法保存！建议导出备份后清理旧记录。");
                }
            }
        }

        /**
         * 更新水温颜色：92-96°C 显示绿色
         * @returns {void}
         */
        function updateTempColor() {
            const tempInput = document.getElementById('input-temp');
            if (!tempInput) return;
            const temp = parseFloat(tempInput.value) || 0;
            if (temp >= 92 && temp <= 96) {
                tempInput.classList.remove('text-white', 'text-red-400', 'text-amber-400');
                tempInput.classList.add('text-green-400');
            } else if (temp < 92) {
                tempInput.classList.remove('text-white', 'text-green-400', 'text-amber-400');
                tempInput.classList.add('text-red-400');
            } else {
                tempInput.classList.remove('text-white', 'text-green-400', 'text-red-400');
                tempInput.classList.add('text-amber-400');
            }
        }

        /**
         * 终极压缩：强制 JPEG + 500px限制
         * 修复了 WebP 回退到 PNG 导致体积变大的问题
         */
        function compressImage(file, callback) {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    // 1. 激进的分辨率限制：600px
                    // 对于 localStorage 存储，这是平衡画质与体积的甜点
                    const MAX = 600; 
                    let w = img.width, h = img.height;
                    
                    if (w > h) { 
                        if (w > MAX) { h *= MAX / w; w = MAX; } 
                    } else { 
                        if (h > MAX) { w *= MAX / h; h = MAX; } 
                    }
                    
                    canvas.width = w; 
                    canvas.height = h;

                    // 2. 铺一层白色背景
                    // 防止 PNG 透明图转 JPEG 变黑，虽然照片一般没透明度，但这是个好习惯
                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillRect(0, 0, w, h);
                    
                    // 3. 绘制图片
                    ctx.drawImage(img, 0, 0, w, h);

                    // 4. 强制使用 JPEG，质量 0.7 (70%)
                    // JPEG 对照片的压缩率远好于 PNG，且所有浏览器都支持
                    let quality = 0.7;
                    let base64 = canvas.toDataURL('image/jpeg', quality);

                    // 5. 检查是否依然过大 (超过 60KB)，如果是，再压一次
                    if (base64.length > 80000) {
                        quality = 0.5;
                        base64 = canvas.toDataURL('image/jpeg', quality);
                    }

                    console.log(`压缩结果: ${w}x${h}, 格式: JPEG, 质量: ${quality}, 体积: ${(base64.length/1024).toFixed(2)}KB`);
                    callback(base64);
                }
            }
        }

        /**
         * 检查 localStorage 存储空间使用情况
         * @returns {Object} 返回 {used: number, available: number, percentage: number, isNearLimit: boolean}
         */
        function checkStorageSpace() {
            let used = 0;
            try {
                // 计算已使用的存储空间（字节）
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        used += localStorage[key].length + key.length;
                    }
                }
            } catch (e) {
                // 某些浏览器可能不支持
            }
            
            // localStorage 通常限制在 5-10MB，这里保守估计为 5MB
            const limit = 5 * 1024 * 1024; // 5MB
            const available = limit - used;
            const percentage = (used / limit) * 100;
            const isNearLimit = percentage > 80; // 超过 80% 视为接近限制
            
            return { used, available, limit, percentage, isNearLimit };
        }

        /**
         * 获取存储空间使用情况的格式化字符串
         * @returns {string}
         */
        function getStorageInfo() {
            const info = checkStorageSpace();
            const usedMB = (info.used / (1024 * 1024)).toFixed(2);
            const limitMB = (info.limit / (1024 * 1024)).toFixed(0);
            return `${usedMB}MB / ${limitMB}MB (${info.percentage.toFixed(1)}%)`;
        }

        /**
         * 更新存储空间信息显示
         * @returns {void}
         */
        function updateStorageInfo() {
            const info = checkStorageSpace();
            const percentageEl = document.getElementById('storage-percentage');
            const barEl = document.getElementById('storage-bar');
            const textEl = document.getElementById('storage-text');
            
            if (percentageEl && barEl && textEl) {
                const usedMB = (info.used / (1024 * 1024)).toFixed(2);
                const limitMB = (info.limit / (1024 * 1024)).toFixed(0);
                const percentage = info.percentage;
                
                percentageEl.textContent = `${percentage.toFixed(1)}%`;
                barEl.style.width = `${Math.min(percentage, 100)}%`;
                
                // 根据使用率设置颜色
                if (percentage > 90) {
                    barEl.className = 'bg-red-500 h-2 rounded-full transition-all';
                    percentageEl.className = 'text-xs font-bold text-red-400';
                } else if (percentage > 80) {
                    barEl.className = 'bg-amber-500 h-2 rounded-full transition-all';
                    percentageEl.className = 'text-xs font-bold text-amber-400';
                } else {
                    barEl.className = 'bg-amber-500 h-2 rounded-full transition-all';
                    percentageEl.className = 'text-xs font-bold text-stone-400';
                }
                
                textEl.textContent = `已使用 ${usedMB}MB / 总计 ${limitMB}MB`;
                
                if (info.isNearLimit) {
                    textEl.textContent += ' ⚠️ 接近限制';
                    textEl.className = 'text-[10px] text-amber-400';
                } else {
                    textEl.className = 'text-[10px] text-stone-600';
                }
            }
        }

        /**
         * 清理旧数据中的冗余图片字段
         * @returns {void}
         */
        function cleanupRedundantImages() {
            let cleaned = false;
            // 清理记录中的 beanImage 字段（已优化为从资产中查找）
            if (Array.isArray(DB.logs)) {
                DB.logs.forEach(log => {
                    if (log.beanImage !== undefined) {
                        delete log.beanImage;
                        cleaned = true;
                    }
                });
            }
            // 如果清理了数据，保存
            if (cleaned) {
                saveData();
                console.log('已清理旧数据中的冗余图片字段，节省存储空间');
            }
        }

        /**
         * 初始化应用：下拉、标签、星级、资产列表、历史记录等
         * @returns {void}
         */
        function init() {
            // 清理旧数据中的冗余图片
            cleanupRedundantImages();
            migrateData(DB);
            
            renderDropdowns();
            renderTags();
            renderStars();
            // 只在资产页 active 时才渲染资产列表
            if (document.getElementById('tab-gear').classList.contains('active')) {
            renderGearList();
            }
            renderHistory();

            // 恢复下拉选项（豆子 / 设备 / 牛奶）
            if (DB.prefs.lastBean && DB.beans.find(b => b.id === DB.prefs.lastBean)) {
                document.getElementById('input-bean').value = DB.prefs.lastBean;
            }
            if (DB.prefs.lastMachine) document.getElementById('input-machine').value = DB.prefs.lastMachine;
            if (DB.prefs.lastGrinder) document.getElementById('input-grinder').value = DB.prefs.lastGrinder;
            if (DB.prefs.lastMilk) document.getElementById('input-milk').value = DB.prefs.lastMilk;

            updateBeanHero();
            renderIconsWithRetry();

            // 水温颜色更新
            document.getElementById('input-temp').addEventListener('input', updateTempColor);
            updateTempColor();
            const doseInput = document.getElementById('input-dose');
            if (doseInput) {
                doseInput.addEventListener('input', () => {
                    updateBeanHero();
                    updateRatios();
                });
            }
            const milkWeightInput = document.getElementById('input-milk-weight');
            if (milkWeightInput) {
                milkWeightInput.addEventListener('input', () => {
                    updateBeanHero();
                    updateRatios();
                });
            }
            const yieldInput = document.getElementById('input-yield');
            if (yieldInput) {
                yieldInput.addEventListener('input', updateRatios);
            }

            // 初始化滑轮组件
            initWheelInputs();

            // 图片上传事件
            const logImageInput = document.getElementById('input-log-image');
            if (logImageInput) {
                logImageInput.addEventListener('change', (e) => {
                    if (e.target.files && e.target.files[0]) {
                        compressImage(e.target.files[0], (base64) => {
                            STATE.newLogImage = base64;
                            const preview = document.getElementById('log-image-preview');
                            const container = document.getElementById('log-image-preview-container');
                            if (preview) preview.src = base64;
                            if (container) container.classList.remove('hidden');
                            renderIconsWithRetry();
                        });
                    }
                });
            }

            // 恢复上一次记录的完整参数
            restoreLastSession();
            
            // 初始化比例显示
            updateRatios();

            // 恢复上一次所在的 tab（记录 / 历史 / 资产）
            if (DB.prefs.lastTab) {
                switchTab(DB.prefs.lastTab);
            }
        }

        /**
         * 从 DB.prefs 恢复上一次记录时的参数（粉重、液重、时间、水温、研磨度、评分、标签、备注等）
         * @returns {void}
         */
        function restoreLastSession() {
            const last = DB.prefs.lastSession;
            if (!last) return;

            // 恢复豆子与设备（若仍存在）
            if (last.beanId && DB.beans.find(b => b.id === last.beanId)) {
                document.getElementById('input-bean').value = last.beanId;
                updateBeanHero();
            }
            if (last.machineId && DB.machines.find(m => m.id === last.machineId)) {
                document.getElementById('input-machine').value = last.machineId;
            }
            if (last.grinderId && DB.grinders.find(g => g.id === last.grinderId)) {
                document.getElementById('input-grinder').value = last.grinderId;
            }

            // 恢复数值类参数
            if (typeof last.dose !== 'undefined') document.getElementById('input-dose').value = last.dose;
            if (typeof last.yield !== 'undefined') document.getElementById('input-yield').value = last.yield;
            if (typeof last.time !== 'undefined') document.getElementById('input-time').value = last.time;
            if (typeof last.temp !== 'undefined') document.getElementById('input-temp').value = last.temp;
            if (typeof last.grindSize !== 'undefined') document.getElementById('input-grind-size').value = last.grindSize;
            if (typeof last.milkWeight !== 'undefined') document.getElementById('input-milk-weight').value = last.milkWeight;
            if (last.milkId && DB.milks.find(m => m.id === last.milkId)) {
                document.getElementById('input-milk').value = last.milkId;
            }
            updateTempColor();

            // 不恢复评分、标签、完美萃取、备注（每次新建记录时这些应该清空）

            // 恢复完美萃取按钮样式
            const godBtn = document.getElementById('btn-god-shot');
            if (godBtn) {
                godBtn.className = STATE.isGodShot
                    ? 'flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-bold transition-all bg-gradient-to-r from-amber-500 to-yellow-500 text-black shadow-[0_0_15px_rgba(245,158,11,0.5)] transform scale-105'
                    : 'flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-bold transition-all bg-stone-800 text-stone-500 border border-stone-700 active:scale-95';
            }
        }

        /**
         * 根据配置生成滑轮数字列表
         * @param {number} min - 最小值
         * @param {number} max - 最大值
         * @param {number} step - 步进
         * @param {number} current - 当前值
         * @returns {{values: string[], currentIndex: number}}
         */
        function buildWheelValues(min, max, step, current) {
            const values = [];
            let bestIndex = 0;
            let bestDist = Number.POSITIVE_INFINITY;
            let foundExact = false;
            
            // current 应该已经对齐过了，直接使用
            let index = 0;
            for (let v = min; v <= max + 1e-8; v += step) {
                const fixed = step < 1 ? v.toFixed(1) : v.toFixed(0);
                const numValue = parseFloat(fixed);
                values.push(fixed);
                
                // 优先精确匹配（考虑浮点数精度问题）
                const diff = Math.abs(numValue - current);
                if (!foundExact && diff < 1e-6) {
                    bestIndex = index;
                    bestDist = 0;
                    foundExact = true;
                } else if (!foundExact) {
                    // 如果还没找到精确匹配，继续找最接近的
                    if (diff < bestDist) {
                        bestDist = diff;
                        bestIndex = index;
                    }
                }
                index += 1;
            }
            return { values, currentIndex: bestIndex };
        }

        /**
         * 初始化所有带 data-wheel 的输入为滑轮选择交互
         * @returns {void}
         */
        function initWheelInputs() {
            const overlay = document.getElementById('wheel-overlay');
            const col = document.getElementById('wheel-column');
            const titleEl = document.getElementById('wheel-title');
            const btnCancel = document.getElementById('wheel-cancel');
            const btnConfirm = document.getElementById('wheel-confirm');

            /** @type {{ target: HTMLInputElement | null, selected: string }} */
            const wheelState = {
                target: null,
                selected: ''
            };

            /**
             * 根据当前滚动位置找到离中线最近的项并对齐，并更新高亮
             * @returns {void}
             */
            function snapToNearest() {
                const items = Array.from(col.children);
                if (!items.length) return;
                
                // 计算容器中心位置
                const containerCenter = col.clientHeight / 2;
                const scrollTop = col.scrollTop;
                const centerY = scrollTop + containerCenter;
                
                let best = /** @type {HTMLElement} */ (items[0]);
                let bestDist = Number.POSITIVE_INFINITY;
                
                items.forEach((el) => {
                    const itemTop = /** @type {HTMLElement} */(el).offsetTop;
                    const itemHeight = /** @type {HTMLElement} */(el).offsetHeight;
                    const itemCenter = itemTop + itemHeight / 2;
                    const dist = Math.abs(itemCenter - centerY);
                    if (dist < bestDist) {
                        bestDist = dist;
                        best = /** @type {HTMLElement} */(el);
                    }
                });
                
                // 对齐到最佳位置
                const targetScroll = best.offsetTop - (containerCenter - best.clientHeight / 2);
                col.scrollTop = targetScroll;

                // 更新选中值
                const val = best.dataset.value || best.textContent || '';
                wheelState.selected = val.trim();

                // 更新所有项的高亮状态
                items.forEach((el) => {
                    el.classList.remove('text-amber-400', 'font-semibold');
                    el.classList.add('text-stone-400');
                });
                best.classList.remove('text-stone-400');
                best.classList.add('text-amber-400', 'font-semibold');
            }

            /**
             * 打开滑轮选择器
             * @param {HTMLInputElement} inputEl - 目标输入框
             * @returns {void}
             */
            function openWheel(inputEl) {
                const min = parseFloat(inputEl.dataset.min || '0');
                const max = parseFloat(inputEl.dataset.max || '0');
                const step = parseFloat(inputEl.dataset.step || '1');
                
                // 读取当前值：优先读取 value 属性，如果为空则读取 placeholder，最后才用默认值
                let rawValue = inputEl.value;
                // 如果 value 为空字符串或只包含空白，尝试读取 placeholder
                if (!rawValue || rawValue.trim() === '') {
                    rawValue = inputEl.getAttribute('placeholder') || inputEl.placeholder || '';
                }
                // 如果还是空，使用默认值（min）
                if (!rawValue || rawValue.trim() === '') {
                    rawValue = min.toString();
                }
                
                // 解析数值，确保在有效范围内
                let rawCurrent = parseFloat(rawValue.trim());
                if (isNaN(rawCurrent)) {
                    rawCurrent = min;
                } else {
                    // 确保值在 min 和 max 之间
                    rawCurrent = Math.max(min, Math.min(max, rawCurrent));
                }
                
                // 对齐到步进值（buildWheelValues 内部也会对齐，但这里先对齐可以确保精确匹配）
                let alignedCurrent = rawCurrent;
                if (step < 1) {
                    alignedCurrent = Math.round(rawCurrent / step) * step;
                    alignedCurrent = parseFloat(alignedCurrent.toFixed(1));
                } else {
                    alignedCurrent = Math.round(rawCurrent);
                }

                const { values, currentIndex } = buildWheelValues(min, max, step, alignedCurrent);
                col.innerHTML = '';
                
                // 创建所有选项（仅用于显示，不支持点击选中，只能通过滑动选择）
                values.forEach((val, idx) => {
                    const btn = document.createElement('div');
                    btn.className = 'wheel-item w-full flex items-center justify-center text-lg font-mono text-stone-400 pointer-events-none';
                    btn.textContent = val;
                    btn.dataset.value = val;
                    col.appendChild(btn);
                });

                const label = inputEl.previousElementSibling?.textContent?.trim() || '';
                titleEl.textContent = label || '选择数值';

                wheelState.target = inputEl;
                wheelState.selected = values[currentIndex] || values[0] || '';

                overlay.classList.remove('hidden');
                document.body.classList.add('overflow-hidden');

                // 立即滚动到当前值（优化：使用 scrollIntoView 或直接设置 scrollTop，避免延迟）
                if (values.length && currentIndex >= 0 && currentIndex < values.length) {
                    // 使用单次 requestAnimationFrame 立即执行
                    requestAnimationFrame(() => {
                    const item = col.children[currentIndex];
                    if (!item) return;
                    
                        // 直接使用 scrollIntoView 或计算 scrollTop，避免多次延迟
                    const containerHeight = col.clientHeight;
                        const itemHeight = item.clientHeight || 40;
                        const itemTop = item.offsetTop;
                    const containerCenter = containerHeight / 2;
                        const targetScroll = itemTop - containerCenter + itemHeight / 2;
                    
                        // 直接设置 scrollTop，不使用平滑滚动
                        col.scrollTop = targetScroll;
                    
                    // 立即高亮当前项
                    Array.from(col.children).forEach((el) => {
                        el.classList.remove('text-amber-400', 'font-semibold');
                        el.classList.add('text-stone-400');
                    });
                    item.classList.remove('text-stone-400');
                    item.classList.add('text-amber-400', 'font-semibold');
                    
                    // 更新选中值
                    wheelState.selected = values[currentIndex];
                    });
                }
            }

            /**
             * 关闭滑轮选择器
             * @param {boolean} apply - 是否应用当前选择到输入框
             * @returns {void}
             */
            function closeWheel(apply) {
                if (apply && wheelState.target) {
                    // 始终基于当前滚动位置重新对齐并取值，保证滑完直接点“确定”也生效
                    snapToNearest();
                    if (wheelState.selected) {
                        wheelState.target.value = wheelState.selected;
                        const event = new Event('input', { bubbles: true });
                        wheelState.target.dispatchEvent(event);
                    }
                }
                wheelState.target = null;
                overlay.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
            }

            btnCancel.addEventListener('click', function onCancel() {
                closeWheel(false);
            });

            btnConfirm.addEventListener('click', function onConfirm() {
                closeWheel(true);
            });

            overlay.addEventListener('click', function onOverlayClick(e) {
                if (e.target === overlay) {
                    closeWheel(false);
                }
            });

            // 滚动结束后自动吸附到最近的数字，避免停在两项中间
            let scrollTimer = null;
            col.addEventListener('scroll', function onScroll() {
                if (scrollTimer) clearTimeout(scrollTimer);
                scrollTimer = setTimeout(() => {
                    snapToNearest();
                }, 80);
            });

            document.querySelectorAll('input[data-wheel="true"]').forEach((el) => {
                el.addEventListener('click', function onInputClick() {
                    openWheel(/** @type {HTMLInputElement} */ (el));
                });
            });
        }

        function renderDropdowns() {
            const beanSel = document.getElementById('input-bean');
            const machSel = document.getElementById('input-machine');
            const grindSel = document.getElementById('input-grinder');
            const milkSel = document.getElementById('input-milk');
            const sortedBeans = sortBeansByRoastDate(DB.beans);
            
            // 1. 豆子：只显示名称
            beanSel.innerHTML = sortedBeans.length ? sortedBeans.map(b => {
                return `<option value="${b.id}">${b.name}</option>`;
            }).join('') : '<option value="">请添加豆子...</option>';
            
            machSel.innerHTML = DB.machines.length ? DB.machines.map(m => `<option value="${m.id}">${m.name}</option>`).join('') : '<option value="">无设备</option>';
            grindSel.innerHTML = DB.grinders.length ? DB.grinders.map(g => `<option value="${g.id}">${g.name}</option>`).join('') : '<option value="">无设备</option>';
            
            // 2. 牛奶：只显示名称
            milkSel.innerHTML = DB.milks.length ? DB.milks.map(m => {
                return `<option value="${m.id}">${m.name}</option>`;
            }).join('') : '<option value="">请添加牛奶...</option>';
            
            beanSel.addEventListener('change', updateBeanHero);
            milkSel.addEventListener('change', updateBeanHero);
        }

        /**
         * 更新奶咖比和粉液比显示
         * @returns {void}
         */
        function updateRatios() {
            const milkWeight = parseFloat(document.getElementById('input-milk-weight')?.value) || 0;
            const yield = parseFloat(document.getElementById('input-yield')?.value) || 0;
            const dose = parseFloat(document.getElementById('input-dose')?.value) || 0;
            
            // 计算奶咖比（牛奶/液重，显示为比例格式）
            const milkCoffeeRatioEl = document.getElementById('milk-coffee-ratio');
            if (milkCoffeeRatioEl) {
                if (yield > 0 && milkWeight > 0) {
                    const ratio = (milkWeight / yield).toFixed(1);
                    milkCoffeeRatioEl.textContent = `奶咖比 1:${ratio}`;
                } else {
                    milkCoffeeRatioEl.textContent = '';
                }
            }
            
            // 计算粉液比（粉重/液重）
            const doseYieldRatioEl = document.getElementById('dose-yield-ratio');
            if (doseYieldRatioEl) {
                if (yield > 0 && dose > 0) {
                    const ratio = (dose / yield).toFixed(2);
                    doseYieldRatioEl.textContent = `粉液比 1:${(yield / dose).toFixed(1)}`;
                } else {
                    doseYieldRatioEl.textContent = '';
                }
            }
        }

/**
         * 更新豆子展示卡片 & 下方的信息栏
         */
         function updateBeanHero() {
            const beanId = document.getElementById('input-bean').value;
            const milkId = document.getElementById('input-milk').value;
            const bean = beanId ? DB.beans.find(b => b.id === beanId) : null;
            const milk = milkId ? DB.milks.find(m => m.id === milkId) : null;
            
            const nameEl = document.getElementById('hero-bean-name');
            const imgEl = document.getElementById('bean-hero-img'); 
            const fallbackEl = document.getElementById('bean-hero-fallback');
            const badge = document.getElementById('hero-roast-badge');
            
            // 1. 更新顶部卡片标题
            let titleText = '';
            if (bean && milk) {
                titleText = `${bean.name} × ${milk.name}`;
            } else if (bean) {
                titleText = bean.name;
            } else {
                titleText = "选择咖啡豆";
            }
            nameEl.innerText = titleText;
            
            // 字体大小自适应
            nameEl.style.fontSize = '';
            nameEl.style.whiteSpace = 'nowrap';
            nameEl.style.overflow = 'hidden';
            nameEl.style.textOverflow = 'ellipsis';
            requestAnimationFrame(() => {
                const container = nameEl.parentElement;
                if (!container) return;
                const containerWidth = container.clientWidth - 40; 
                const textWidth = nameEl.scrollWidth;
                if (textWidth > containerWidth) {
                    const scale = Math.min(1, (containerWidth / textWidth) * 0.95);
                    const baseSize = 24; 
                    const minSize = 16; 
                    nameEl.style.fontSize = `${Math.max(minSize, baseSize * scale)}px`;
                }
            });
            
            // 2. 更新顶部卡片图片和标签
            if (bean) {
                badge.innerText = bean.roast || '未知';
                badge.classList.remove('hidden');
                badge.classList.add('!opacity-100');
                badge.style.backgroundColor = getRoastColor(bean.roast);

                const stageBadge = document.getElementById('hero-stage-badge');
                const roastDays = getRoastDays(bean.roastDate, new Date());
                const stageInfo = getRoastStage(bean.roast, roastDays, bean.id);
                
                if (stageInfo && roastDays !== null && stageBadge) {
                    stageBadge.innerText = stageInfo.text;
                    stageBadge.style.backgroundColor = stageInfo.color;
                    stageBadge.classList.remove('hidden');
                    stageBadge.classList.add('!opacity-100');
                } else if (stageBadge) {
                    stageBadge.classList.add('hidden');
                }

                if (bean.image) {
                    imgEl.src = bean.image;
                    imgEl.classList.remove('hidden');
                    fallbackEl.classList.add('hidden');
                } else {
                    imgEl.src = '';
                    imgEl.classList.add('hidden');
                    fallbackEl.classList.remove('hidden');
                }
            } else {
                badge.classList.add('hidden');
                const stageBadge = document.getElementById('hero-stage-badge');
                if (stageBadge) stageBadge.classList.add('hidden');
                imgEl.src = '';
                imgEl.classList.add('hidden');
                fallbackEl.classList.remove('hidden');
            }

            // 清空旧的 stats 区域 (防止残留)
            const oldStatsEl = document.getElementById('hero-bean-stats');
            if (oldStatsEl) oldStatsEl.innerHTML = '';

            // 3. 更新选择器下方的信息 (新逻辑)
            const beanInfoEl = document.getElementById('bean-info-display');
            const milkInfoEl = document.getElementById('milk-info-display');

            // --- 豆子信息 ---
            if (beanInfoEl) {
                if (bean) {
                    let leftText = '';
                    let rightText = '';

                    // 剩余量
                    const remain = getBeanRemaining(bean);
                    if (remain.total > 0) {
                        leftText = `余 ${remain.remaining}g`;
                    }

                    // 单价
                    if (bean.totalWeight > 0 && bean.price > 0) {
                        const unitCost = getUnitCost(bean.totalWeight, bean.price);
                        rightText = `<span class="text-amber-500">¥${unitCost.toFixed(2)}/g</span>`;
                    }

                    beanInfoEl.innerHTML = `<span>${leftText}</span><span>${rightText}</span>`;
                } else {
                    beanInfoEl.innerHTML = '';
                }
            }

            // --- 牛奶信息 ---
            if (milkInfoEl) {
                if (milk) {
                    if (milk.totalWeight > 0 && milk.price > 0) {
                        const unitCost = getUnitCost(milk.totalWeight, milk.price);
                        const costPer100 = unitCost * 100;
                        milkInfoEl.innerHTML = `<span class="text-amber-500">¥${costPer100.toFixed(1)}/100ml</span>`;
                    } else {
                        milkInfoEl.innerHTML = '';
                    }
                } else {
                    milkInfoEl.innerHTML = '';
                }
            }
            
            // 更新比例显示
            updateRatios();
            
            // 4. 如果选择了咖啡豆且有推荐参数，自动填充到表单
            if (bean) {
                const doseInput = document.getElementById('input-dose');
                const timeInput = document.getElementById('input-time');
                const yieldInput = document.getElementById('input-yield');
                const tempInput = document.getElementById('input-temp');
                
                if (bean.recommendedDose !== undefined && bean.recommendedDose !== null && doseInput) {
                    doseInput.value = bean.recommendedDose.toString();
                    // 触发input事件以更新wheel组件
                    doseInput.dispatchEvent(new Event('input', { bubbles: true }));
                }
                if (bean.recommendedTime !== undefined && bean.recommendedTime !== null && timeInput) {
                    timeInput.value = bean.recommendedTime.toString();
                    timeInput.dispatchEvent(new Event('input', { bubbles: true }));
                }
                if (bean.recommendedYield !== undefined && bean.recommendedYield !== null && yieldInput) {
                    yieldInput.value = bean.recommendedYield.toString();
                    yieldInput.dispatchEvent(new Event('input', { bubbles: true }));
                }
                if (bean.recommendedTemp !== undefined && bean.recommendedTemp !== null && tempInput) {
                    tempInput.value = bean.recommendedTemp.toString();
                    tempInput.dispatchEvent(new Event('input', { bubbles: true }));
                }
            }
        }

        /**
         * 渲染星级评分（支持半颗星，左半部分为半颗星）
         * @returns {void}
         */
        function renderStars() {
            const container = document.getElementById('star-container');
            const rating = STATE.currentRating || 0;
            
            container.innerHTML = [1, 2, 3, 4, 5].map(i => {
                const isFull = rating >= i;
                const isHalf = rating >= i - 0.5 && rating < i;
                const fillColor = '#d97706';
                const strokeColor = (isFull || isHalf) ? '#d97706' : '#44403c';
                
                return `
                    <div class="relative inline-block" style="width: 48px; height: 48px; padding: 4px;">
                        <svg width="40" height="40" viewBox="0 0 24 24" class="pointer-events-none">
                            <defs>
                                <clipPath id="clip-left-${i}">
                                    <rect x="0" y="0" width="12" height="24"/>
                                </clipPath>
                                <clipPath id="clip-right-${i}">
                                    <rect x="12" y="0" width="12" height="24"/>
                                </clipPath>
                            </defs>
                            <!-- 左半部分填充（半颗星） -->
                            <polygon 
                                points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" 
                                fill="${isHalf || isFull ? fillColor : 'none'}" 
                                stroke="none"
                                clip-path="url(#clip-left-${i})"
                            />
                            <!-- 右半部分填充（整颗星） -->
                            <polygon 
                                points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" 
                                fill="${isFull ? fillColor : 'none'}" 
                                stroke="none"
                                clip-path="url(#clip-right-${i})"
                            />
                            <!-- 完整轮廓 -->
                            <polygon 
                                points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" 
                                fill="none" 
                                stroke="${strokeColor}" 
                                stroke-width="2" 
                                stroke-linecap="round" 
                                stroke-linejoin="round"
                            />
                        </svg>
                        <!-- 左半部分触摸区域：半颗星（增大触摸区域，提高移动端灵敏度） -->
                        <button 
                            onclick="setRating(${i - 0.5})" 
                            class="absolute left-0 top-0 w-1/2 h-full cursor-pointer focus:outline-none transition-transform active:scale-110 touch-manipulation"
                            style="z-index: 2; background: transparent; min-width: 24px; min-height: 48px; -webkit-tap-highlight-color: transparent;"
                            title="${i - 0.5}星"
                        ></button>
                        <!-- 右半部分触摸区域：整颗星（增大触摸区域，提高移动端灵敏度） -->
                        <button 
                            onclick="setRating(${i})" 
                            class="absolute right-0 top-0 w-1/2 h-full cursor-pointer focus:outline-none transition-transform active:scale-110 touch-manipulation"
                            style="z-index: 2; background: transparent; min-width: 24px; min-height: 48px; -webkit-tap-highlight-color: transparent;"
                            title="${i}星"
                        ></button>
                    </div>
                `;
            }).join('');
        }
        
        /**
         * 设置评分（支持半颗星：0.5, 1, 1.5, 2, 2.5, 3, 3.5, 4, 4.5, 5）
         * @param {number} r - 评分值
         * @returns {void}
         */
        function setRating(r) {
            STATE.currentRating = r;
            renderStars();
        }

        function renderTags() {
            // 获取可用的默认标签（排除已删除的）
            const availableDefaultTags = DEFAULT_TAGS.filter(t => !DB.deletedDefaultTags.includes(t));
            const allTags = [...availableDefaultTags, ...DB.customTags];
            const html = allTags.map(t => {
                const isActive = STATE.selectedTags.includes(t);
                // 修复：添加 flex items-center justify-center leading-none 确保高度与带图标的按钮一致
                return `<button onclick="toggleTag('${t}')" class="text-[10px] px-2.5 py-1.5 rounded-lg border transition-all flex items-center justify-center leading-none ${isActive ? 'bg-amber-900/40 text-amber-500 border-amber-600 font-bold shadow-sm' : 'bg-stone-900/50 border-stone-800 text-stone-500 hover:border-stone-600'}">${t}</button>`;
            }).join('');
            
            const addBtn = document.querySelector('#tags-container button:last-child');
            const container = document.getElementById('tags-container');
            if (container && addBtn) {
                container.innerHTML = html;
                container.appendChild(addBtn);
            }
            renderIconsWithRetry();
        }

        function toggleTag(t) {
            if (STATE.selectedTags.includes(t)) STATE.selectedTags = STATE.selectedTags.filter(x => x !== t); else STATE.selectedTags.push(t);
            renderTags();
        }
        function addNewTagPrompt() {
            const tag = prompt("输入新标签名称:");
            if (tag && tag.trim()) {
                const trimmedTag = tag.trim();
                // 检查是否已存在（包括自定义标签和未删除的默认标签）
                const availableDefaultTags = DEFAULT_TAGS.filter(t => !DB.deletedDefaultTags.includes(t));
                if (DB.customTags.includes(trimmedTag) || availableDefaultTags.includes(trimmedTag)) {
                    showAlert("标签已存在！");
                    return;
                }
                // 如果之前是已删除的默认标签，从删除列表中移除
                if (DB.deletedDefaultTags.includes(trimmedTag)) {
                    DB.deletedDefaultTags = DB.deletedDefaultTags.filter(t => t !== trimmedTag);
                }
                // 添加到自定义标签
                if (!DB.customTags.includes(trimmedTag)) {
                    DB.customTags.push(trimmedTag);
                }
                saveData();
                toggleTag(trimmedTag);
                // 如果在标签管理页面，更新列表
                if (STATE.currentGearTab === 'tags') {
                    renderTagsList();
                }
            }
        }

        /**
         * 渲染标签管理列表
         * @returns {void}
         */
        function renderTagsList() {
            const list = document.getElementById('tags-list');
            if (!list) return;
            
            // 获取可用的默认标签（排除已删除的）
            const availableDefaultTags = DEFAULT_TAGS.filter(t => !DB.deletedDefaultTags.includes(t));
            const deletedDefaultTags = DEFAULT_TAGS.filter(t => DB.deletedDefaultTags.includes(t));
            
            // 默认标签（可删除）
            const defaultTagsHtml = availableDefaultTags.length > 0 ? availableDefaultTags.map(tag => `
                <div class="flex items-center gap-3 p-3 bg-stone-900 border border-stone-800 rounded-xl">
                    <div class="flex-1">
                        <div class="text-sm font-medium text-stone-200">${tag}</div>
                        <div class="text-[10px] text-stone-600 mt-0.5">默认标签</div>
                    </div>
                    <button onclick="deleteTag('${tag.replace(/'/g, "\\'")}')" class="text-stone-600 hover:text-red-500 p-2 active:bg-stone-800 rounded transition-colors flex-shrink-0" title="删除">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
            `).join('') : '<div class="text-center text-xs text-stone-600 py-4">所有默认标签已删除</div>';
            
            // 已删除的默认标签（可恢复）
            const deletedTagsHtml = deletedDefaultTags.length > 0 ? deletedDefaultTags.map(tag => `
                <div class="flex items-center gap-3 p-3 bg-stone-900/50 border border-stone-800/50 rounded-xl opacity-60">
                    <div class="flex-1">
                        <div class="text-sm font-medium text-stone-400 line-through">${tag}</div>
                        <div class="text-[10px] text-stone-600 mt-0.5">已删除的默认标签</div>
                    </div>
                    <button onclick="restoreTag('${tag.replace(/'/g, "\\'")}')" class="text-stone-600 hover:text-amber-500 p-2 active:bg-stone-800 rounded transition-colors flex-shrink-0" title="恢复">
                        <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                    </button>
                </div>
            `).join('') : '';
            
            // 自定义标签（可删除）
            const customTagsHtml = DB.customTags.length > 0 ? DB.customTags.map(tag => `
                <div class="flex items-center gap-3 p-3 bg-stone-900 border border-stone-800 rounded-xl">
                    <div class="flex-1">
                        <div class="text-sm font-medium text-stone-200">${tag}</div>
                        <div class="text-[10px] text-stone-600 mt-0.5">自定义标签</div>
                    </div>
                    <button onclick="deleteTag('${tag.replace(/'/g, "\\'")}')" class="text-stone-600 hover:text-red-500 p-2 active:bg-stone-800 rounded transition-colors flex-shrink-0" title="删除">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
            `).join('') : '<div class="text-center text-xs text-stone-600 py-4">暂无自定义标签</div>';
            
            list.innerHTML = `
                <div class="glass-panel rounded-2xl p-4 border border-stone-800 mb-4">
                    <h3 class="text-xs font-bold text-stone-500 uppercase mb-3 flex items-center gap-1">
                        <i data-lucide="tag" class="w-3"></i> 默认标签
                    </h3>
                    <div class="space-y-2">
                        ${defaultTagsHtml}
                    </div>
                    ${deletedTagsHtml ? `
                    <div class="mt-4 pt-4 border-t border-stone-800">
                        <h4 class="text-[10px] font-bold text-stone-600 uppercase mb-2">已删除</h4>
                        <div class="space-y-2">
                            ${deletedTagsHtml}
                        </div>
                    </div>
                    ` : ''}
                </div>
                <div class="glass-panel rounded-2xl p-4 border border-stone-800">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-xs font-bold text-stone-500 uppercase flex items-center gap-1">
                            <i data-lucide="tag-plus" class="w-3"></i> 自定义标签
                        </h3>
                        <button onclick="addNewTagPrompt()" class="text-[10px] px-3 py-1.5 rounded-lg border border-stone-700 text-stone-400 hover:text-stone-300 hover:border-stone-600 transition-colors flex items-center gap-1 active:bg-stone-800">
                            <i data-lucide="plus" class="w-3 h-3"></i> 添加标签
                        </button>
                    </div>
                    <div class="space-y-2">
                        ${customTagsHtml}
                    </div>
                </div>
            `;
            renderIconsWithRetry();
        }

        /**
         * 删除标签（包括默认标签和自定义标签）
         * @param {string} tag - 要删除的标签名称
         * @returns {Promise<void>}
         */
        async function deleteTag(tag) {
            const confirmed = await showConfirm(`确定要删除标签"${tag}"吗？\n删除后，历史记录中使用该标签的记录将不再显示此标签。\n清空数据时会恢复默认标签。`);
            if (confirmed) {
                if (DEFAULT_TAGS.includes(tag)) {
                    // 如果是默认标签，添加到删除列表
                    if (!DB.deletedDefaultTags.includes(tag)) {
                        DB.deletedDefaultTags.push(tag);
                    }
                } else {
                    // 如果是自定义标签，从自定义标签列表中删除
                    DB.customTags = DB.customTags.filter(t => t !== tag);
                }
                saveData();
                renderTagsList();
                renderTags(); // 更新记录页的标签显示
            }
        }

        /**
         * 恢复已删除的默认标签
         * @param {string} tag - 要恢复的标签名称
         * @returns {void}
         */
        function restoreTag(tag) {
            DB.deletedDefaultTags = DB.deletedDefaultTags.filter(t => t !== tag);
            saveData();
            renderTagsList();
            renderTags(); // 更新记录页的标签显示
        }

        document.getElementById('btn-god-shot').addEventListener('click', function() {
            STATE.isGodShot = !STATE.isGodShot;
            this.className = STATE.isGodShot 
                ? 'flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-bold transition-all bg-gradient-to-r from-amber-500 to-yellow-500 text-black shadow-[0_0_15px_rgba(245,158,11,0.5)] transform scale-105'
                : 'flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-bold transition-all bg-stone-800 text-stone-500 border border-stone-700 active:scale-95';
        });

        /**
         * 清除历史记录中的「New」标记，确保只保留最新的一条
         * @returns {void}
         */
        function clearLogNewFlags() {
            DB.logs.forEach(log => {
                if (log.isNew) {
                    log.isNew = false;
                }
            });
        }

        /**
         * 保存或更新一条萃取记录
         * - 如果 STATE.editingLogId 存在，则更新原记录
         * - 否则新增一条记录
         * @returns {Promise<void>}
         */
        async function saveLog() {
            // 检查当前是否在记录页，防止在其他tab下保存
            const recordTab = document.getElementById('tab-record');
            if (!recordTab || !recordTab.classList.contains('active')) {
                return; // 如果不在记录页，直接返回
            }
            
            const beanId = document.getElementById('input-bean').value;
            if (!beanId) {
                await showAlert("请先在资产页添加并选择一款咖啡豆！");
                return;
            }
            const bean = DB.beans.find(b => b.id === beanId);
            const grinderId = document.getElementById('input-grinder').value;
            const machineId = document.getElementById('input-machine').value;
            const milkId = document.getElementById('input-milk').value;
            const grinder = DB.grinders.find(g => g.id === grinderId);
            const machine = DB.machines.find(m => m.id === machineId);
            const milk = DB.milks.find(m => m.id === milkId);
            const doseVal = parseFloat(document.getElementById('input-dose').value) || 0;
            const milkWeightVal = parseFloat(document.getElementById('input-milk-weight').value) || 0;
            const { beanCost, milkCost, totalCost } = computeCupCost({ bean, milk, dose: doseVal, milkWeight: milkWeightVal });
            
            const editingId = STATE.editingLogId;
            const oldLog = editingId ? DB.logs.find(l => l.id === editingId) : null;
            const id = editingId || Date.now().toString();
            const date = oldLog ? oldLog.date : new Date().toISOString();

            const log = {
                id: id,
                date: date,
                beanId: beanId, beanName: bean.name, beanRoast: bean.roast,
                // 优化：不存储 beanImage，避免重复存储。显示时从 DB.beans 中查找
                machineName: machine ? machine.name : '未知设备', grinderName: grinder ? grinder.name : '未知磨豆机',
                milkId: milkId, milkName: milk ? milk.name : '',
                grindSize: document.getElementById('input-grind-size').value || '-',
                dose: document.getElementById('input-dose').value, yield: document.getElementById('input-yield').value,
                milkWeight: document.getElementById('input-milk-weight').value || '0',
                time: document.getElementById('input-time').value, temp: document.getElementById('input-temp').value,
                rating: STATE.currentRating, isGodShot: STATE.isGodShot, tags: STATE.selectedTags,
                notes: document.getElementById('input-notes').value,
                image: STATE.newLogImage || (editingId && oldLog ? oldLog.image : null),
                beanCost,
                milkCost,
                totalCost
            };
            if (!editingId) {
                clearLogNewFlags();
                log.isNew = true;
            } else {
                log.isNew = oldLog?.isNew || false;
            }
            if (editingId && oldLog) {
                DB.logs = DB.logs.map(l => l.id === editingId ? log : l);
            } else {
                DB.logs.unshift(log);
            }
            // 更新偏好：上一次使用的豆子 / 设备 / 刻度以及完整的一次记录参数
            DB.prefs = {
                ...(DB.prefs || {}),
                lastBean: beanId,
                lastMachine: machineId || machine?.id,
                lastGrinder: grinderId || grinder?.id,
                lastMilk: milkId || milk?.id,
                lastGrindSize: log.grindSize,
                lastSession: {
                    beanId: beanId,
                    machineId: machineId || machine?.id,
                    grinderId: grinderId || grinder?.id,
                    milkId: milkId || milk?.id,
                    dose: log.dose,
                    yield: log.yield,
                    time: log.time,
                    temp: log.temp,
                    grindSize: log.grindSize,
                    milkWeight: log.milkWeight
                    // 不保存评分、标签、完美萃取、备注（这些每次新建时应该清空）
                }
            };
            saveData();
            STATE.currentRating = 0; STATE.isGodShot = false; STATE.selectedTags = []; STATE.editingLogId = null; STATE.newLogImage = null;
            document.getElementById('input-notes').value = ''; setRating(0);
            clearLogImage();
            document.getElementById('btn-god-shot').className = 'flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-bold transition-all bg-stone-800 text-stone-500 border border-stone-700 active:scale-95';
            
            // 重置标签UI显示
            renderTags();

            // 保存后按钮文案恢复"记录这杯"
            const saveTextEl = document.getElementById('btn-save-log-text');
            if (saveTextEl) saveTextEl.textContent = '记录这杯';

            switchTab('history'); renderHistory();
        }

        let filterGod = false; let filterBean = 'ALL'; let filterSearch = '';
        let filterDateStart = ''; let filterDateEnd = '';
        let historyPage = 0; const HISTORY_PAGE_SIZE = 10; let historyAllFiltered = [];
        
        function renderHistory(resetPage = false) {
            if (resetPage) historyPage = 0;
            
            const list = document.getElementById('history-list');
            const filterContainer = document.getElementById('history-filters');
            
            // --- 顶部筛选器渲染 (保持不变) ---
            if (DB.beans.length > 5) {
                const selectedBean = filterBean !== 'ALL' ? DB.beans.find(b => b.id === filterBean) : null;
                filterContainer.innerHTML = `
                    <div class="relative flex-1 max-w-xs">
                        <div class="relative">
                            <input 
                                type="text" 
                                id="bean-search-input" 
                                placeholder="选择或搜索咖啡豆..." 
                                value="${selectedBean ? selectedBean.name : filterSearch}"
                                class="w-full h-8 px-3 pr-8 rounded-full text-xs bg-stone-900 border border-stone-800 text-stone-300 placeholder-stone-600 focus:outline-none focus:border-stone-600 transition-colors"
                                onclick="showBeanDropdown()"
                                readonly
                            >
                            <button onclick="showBeanDropdown()" class="absolute right-2 top-1/2 -translate-y-1/2 text-stone-500 hover:text-stone-300">
                                <i data-lucide="chevron-down" class="w-3 h-3"></i>
                            </button>
                        </div>
                    </div>
                    ${filterBean !== 'ALL' ? `<button onclick="setBeanFilter('ALL')" class="flex-shrink-0 flex items-center gap-1.5 px-3 py-1.5 h-8 rounded-full text-xs font-medium border bg-stone-900 border-stone-800 text-stone-400 hover:bg-stone-800 transition-colors">清除</button>` : ''}
                `;
                renderIconsWithRetry();
                if (filterSearch) filterBeanDropdown(filterSearch);
            } else {
                let filterHtml = `<button onclick="setBeanFilter('ALL')" class="flex-shrink-0 flex items-center gap-1.5 px-3 py-1.5 h-8 rounded-full text-xs font-medium border whitespace-nowrap transition-colors ${filterBean === 'ALL' ? 'bg-stone-200 text-black border-stone-200' : 'bg-stone-900 border-stone-800 text-stone-400 hover:bg-stone-800'}">全部</button>`;
                DB.beans.forEach(b => { filterHtml += `<button onclick="setBeanFilter('${b.id}')" class="flex-shrink-0 flex items-center gap-1.5 px-3 py-1.5 h-8 rounded-full text-xs font-medium border whitespace-nowrap transition-colors ${filterBean === b.id ? 'bg-stone-800 text-stone-200 border-stone-600' : 'bg-stone-900 border-stone-800 text-stone-500 hover:bg-stone-800'}">${b.name}</button>`; });
                filterContainer.innerHTML = filterHtml;
            }
            
            const dateBtn = document.getElementById('filter-date-btn');
            if (dateBtn) {
                const dateText = formatDateRange(filterDateStart, filterDateEnd);
                dateBtn.className = `flex-shrink-0 flex items-center gap-1.5 px-3 py-1.5 h-8 rounded-full text-xs font-medium border transition-colors ${filterDateStart || filterDateEnd ? 'bg-stone-800 text-amber-500 border-amber-500/50' : 'bg-stone-900 border-stone-800 text-stone-400 hover:bg-stone-800'}`;
                dateBtn.innerHTML = `
                    <i data-lucide="calendar" class="w-3 h-3"></i>
                    <span>${dateText}</span>
                    ${filterDateStart || filterDateEnd ? `<i data-lucide="x" class="w-3 h-3 ml-1" onclick="event.stopPropagation(); clearDateFilter();"></i>` : ''}
                `;
                renderIconsWithRetry();
            }
            
            // --- 数据筛选与分页 ---
            historyAllFiltered = DB.logs.filter(l => {
                const beanMatch = filterBean === 'ALL' || l.beanId === filterBean;
                const godMatch = !filterGod || l.isGodShot;
                const searchMatch = !filterSearch || (l.beanName && l.beanName.toLowerCase().includes(filterSearch.toLowerCase()));
                let dateMatch = true;
                if (filterDateStart || filterDateEnd) {
                    const logDate = new Date(l.date);
                    logDate.setHours(0, 0, 0, 0); 
                    if (filterDateStart) {
                        const startDate = new Date(filterDateStart);
                        startDate.setHours(0, 0, 0, 0);
                        if (logDate < startDate) dateMatch = false;
                    }
                    if (filterDateEnd && dateMatch) {
                        const endDate = new Date(filterDateEnd);
                        endDate.setHours(23, 59, 59, 999);
                        if (logDate > endDate) dateMatch = false;
                    }
                }
                return beanMatch && godMatch && searchMatch && dateMatch;
            }).sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (historyAllFiltered.length === 0) { 
                list.innerHTML = '<div class="text-center py-24 text-stone-700 flex flex-col items-center"><i data-lucide="clipboard-x" class="w-10 h-10 mb-2 opacity-50"></i><span>暂无符合条件的记录</span></div>'; 
                renderIconsWithRetry(); 
                return; 
            }
            
            const endIndex = Math.min((historyPage + 1) * HISTORY_PAGE_SIZE, historyAllFiltered.length);
            if (resetPage || historyPage === 0) {
                list.innerHTML = '';
            }
            
            const startIndex = historyPage * HISTORY_PAGE_SIZE;
            const currentPageLogs = historyAllFiltered.slice(startIndex, endIndex);
            
            if (currentPageLogs.length === 0 && (resetPage || historyPage === 0)) {
                list.innerHTML = '<div class="text-center py-24 text-stone-700 flex flex-col items-center"><i data-lucide="clipboard-x" class="w-10 h-10 mb-2 opacity-50"></i><span>暂无符合条件的记录</span></div>';
                renderIconsWithRetry();
                return;
            }
            
            // --- 生成列表项HTML ---
            const newItems = currentPageLogs.map(log => {
                const currentBean = log.beanId ? DB.beans.find(b => b.id === log.beanId) : null;
                const displayImage = log.image || currentBean?.image;
                const roastDays = currentBean ? getRoastDays(currentBean.roastDate, log.date) : null;
                const stageInfo = getRoastStage(log.beanRoast, roastDays, log.beanId || null);
                
                // === 修改核心：背景色始终由烘焙度决定，不受赏味期影响 ===
                const roastColor = getRoastColor(log.beanRoast); 

                const costInfo = (() => {
                    const bean = log.beanId ? DB.beans.find(b => b.id === log.beanId) : null;
                    const milk = log.milkId ? DB.milks.find(m => m.id === log.milkId) : null;
                    if (typeof log.totalCost === 'number' && log.totalCost > 0) {
                        return { beanCost: log.beanCost || 0, milkCost: log.milkCost || 0, totalCost: log.totalCost };
                    }
                    return computeCupCost({
                        bean,
                        milk,
                        dose: parseFloat(log.dose) || 0,
                        milkWeight: parseFloat(log.milkWeight) || 0
                    });
                })();

                return `
                <div class="relative bg-stone-900 rounded-xl overflow-hidden border transition-all cursor-pointer hover:border-stone-700 ${log.isGodShot ? 'border-amber-500/40 shadow-[0_0_15px_rgba(245,158,11,0.15)]' : 'border-stone-800'}" onclick="showLogDetailModal('${log.id}')">
                    ${log.isNew ? '<div class="absolute top-2 left-2 z-10"><span class="px-2 py-0.5 text-[10px] font-bold rounded-full bg-emerald-500 text-black shadow-lg">New</span></div>' : ''}
                    <div class="flex h-full">
                        <div class="w-20 relative flex items-center justify-center flex-shrink-0" style="background: ${roastColor};">
                            ${displayImage ? `<img src="${displayImage}" class="absolute inset-0 w-full h-full object-cover">` : '<i data-lucide="coffee" class="text-white/30 w-6 h-6"></i>'}
                            ${log.isGodShot ? '<div class="absolute top-0 left-0 w-full h-1 bg-amber-500 shadow-[0_0_10px_#f59e0b]"></div>' : ''}
                        </div>
                        <div class="flex-1 p-3 min-w-0">
                            <div class="flex items-start gap-2 mb-3">
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2 mb-1">
                                        ${log.rating ? `<div class="flex items-center gap-0.5 text-amber-500 font-bold text-sm flex-shrink-0"><span>${log.rating}</span><i data-lucide="star" class="w-3 h-3 fill-current"></i></div>` : ''}
                                        <div class="flex-1 min-w-0">
                                            <h3 class="text-sm font-bold truncate ${log.isGodShot ? 'text-amber-100' : 'text-stone-200'}" style="font-size: clamp(0.75rem, 2.5vw, 0.875rem);">${log.milkName ? `${log.beanName} × ${log.milkName}` : log.beanName}</h3>
                                            ${log.beanRoast ? `
                                                <div class="flex items-center gap-1.5 mt-0.5 flex-wrap">
                                                    <div class="text-[10px] font-bold text-white inline-block px-2 py-0.5 rounded-full" style="background-color: ${getRoastColor(log.beanRoast)}">${log.beanRoast}</div>
                                                    ${stageInfo && roastDays !== null ? `<div class="text-[10px] font-bold text-white inline-block px-2 py-0.5 rounded-full" style="background-color: ${stageInfo.color}">${stageInfo.text}</div>` : ''}
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                    <div class="text-[10px] text-stone-500 flex items-center gap-1.5 flex-wrap">
                                        <span>${new Date(log.date).getMonth()+1}/${new Date(log.date).getDate()} ${new Date(log.date).getHours()}:${new Date(log.date).getMinutes().toString().padStart(2,'0')}</span>
                                        <span class="text-stone-600">·</span>
                                        <span class="text-stone-400">${log.grinderName || '未知磨豆机'}</span>
                                        ${log.machineName ? `<span class="text-stone-600">·</span><span class="text-stone-400">${log.machineName}</span>` : ''}
                                        ${(() => {
                                            const logRoastDays = currentBean ? getRoastDays(currentBean.roastDate, log.date) : null;
                                            return logRoastDays !== null ? `<span class="text-stone-600">·</span><span class="text-stone-400">烘焙 ${logRoastDays} 天</span>` : '';
                                        })()}
                                        ${costInfo.totalCost > 0 ? `<span class="text-stone-600">·</span><span class="text-amber-400">成本 ${formatCurrency(costInfo.totalCost)}${costInfo.beanCost || costInfo.milkCost ? `（豆${formatCurrency(costInfo.beanCost)}${costInfo.milkCost ? ` / 奶${formatCurrency(costInfo.milkCost)}` : ''}）` : ''}</span>` : ''}
                                    </div>
                                </div>
                                <div class="flex items-center gap-1 flex-shrink-0">
                                    <button onclick="event.stopPropagation(); showLogEditModal('${log.id}')" class="text-stone-600 hover:text-amber-500 p-1 transition-colors" title="编辑"><i data-lucide="edit-2" class="w-3.5 h-3.5"></i></button>
                                    <button onclick="event.stopPropagation(); deleteLog('${log.id}')" class="text-stone-600 hover:text-red-500 p-1 transition-colors" title="删除"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-3 gap-2 mb-3">
                                <div class="bg-black/30 px-2 py-1.5 rounded border border-stone-800 text-center">
                                    <div class="text-[8px] text-stone-500 uppercase mb-0.5">刻度</div>
                                    <div class="text-xs font-bold text-amber-500 font-mono">${log.grindSize || '-'}</div>
                                    </div>
                                <div class="bg-black/30 px-2 py-1.5 rounded border border-stone-800 text-center">
                                    <div class="text-[8px] text-stone-500 uppercase mb-0.5">粉重</div>
                                    <div class="text-xs text-stone-300 font-mono">${log.dose || '0'}g</div>
                                </div>
                                <div class="bg-black/30 px-2 py-1.5 rounded border border-stone-800 text-center">
                                    <div class="text-[8px] text-stone-500 uppercase mb-0.5">液重</div>
                                    <div class="text-xs text-stone-300 font-mono">${log.yield || '0'}g</div>
                                </div>
                                <div class="bg-black/30 px-2 py-1.5 rounded border border-stone-800 text-center">
                                    <div class="text-[8px] text-stone-500 uppercase mb-0.5">牛奶</div>
                                    <div class="text-xs text-stone-300 font-mono">${log.milkWeight && parseFloat(log.milkWeight) > 0 ? log.milkWeight + 'g' : '-'}</div>
                                </div>
                                <div class="bg-black/30 px-2 py-1.5 rounded border border-stone-800 text-center">
                                    <div class="text-[8px] text-stone-500 uppercase mb-0.5">时间</div>
                                    <div class="text-xs text-stone-300 font-mono">${log.time || '0'}s</div>
                                </div>
                                <div class="bg-black/30 px-2 py-1.5 rounded border border-stone-800 text-center">
                                    <div class="text-[8px] text-stone-500 uppercase mb-0.5">水温</div>
                                    <div class="text-xs text-stone-300 font-mono">${log.temp || '-'}°C</div>
                                </div>
                            </div>
                            
                            ${log.tags && log.tags.length > 0 ? `
                                <div class="flex flex-wrap gap-1.5 mb-2">
                                    ${log.tags.map(t => `<span class="text-[10px] text-stone-300 bg-stone-800/80 px-2 py-0.5 rounded">${t}</span>`).join('')}
                                </div>
                            ` : ''}
                            
                            ${log.notes ? `
                                <div class="bg-black/20 p-2 rounded text-[10px] text-stone-400 border border-white/5 italic leading-relaxed">
                                    ${log.notes}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            }).join('');
            
            if (newItems) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = newItems;
                while (tempDiv.firstChild) {
                    list.appendChild(tempDiv.firstChild);
                }
            }
            
            renderIconsWithRetry();
            
            if (endIndex < historyAllFiltered.length) {
                const loadMoreEl = document.getElementById('history-load-more');
                if (loadMoreEl) loadMoreEl.remove();
                const loadMore = document.createElement('div');
                loadMore.id = 'history-load-more';
                loadMore.className = 'text-center py-4 text-stone-600 text-xs';
                loadMore.innerHTML = '<i data-lucide="chevron-down" class="w-4 h-4 inline-block"></i> 滚动加载更多';
                list.appendChild(loadMore);
                renderIconsWithRetry();
            } else {
                const loadMoreEl = document.getElementById('history-load-more');
                if (loadMoreEl) loadMoreEl.remove();
            }
            
            setupHistoryScroll();
        }
        
/**
         * 设置历史记录的无限滚动（全局窗口滚动监听）
         */
         function setupHistoryScroll() {
            // 移除旧的监听器（防止重复绑定）
            window.removeEventListener('scroll', handleHistoryScroll);
            // 绑定到全局窗口
            window.addEventListener('scroll', handleHistoryScroll);
        }
        
        /**
         * 处理全局滚动事件
         */
        function handleHistoryScroll() {
            // 1. 如果当前不在历史页，不执行加载逻辑
            if (STATE.currentTab !== 'history') return;

            const list = document.getElementById('history-list');
            if (!list) return;
            
            // 2. 获取全局滚动位置信息
            const scrollTop = window.scrollY || document.documentElement.scrollTop; // 当前滚动高度
            const windowHeight = window.innerHeight; // 屏幕视口高度
            const docHeight = document.documentElement.scrollHeight; // 整个文档高度

            // 3. 计算距离底部的距离
            // 当 (文档总高度 - 当前滚动 - 视口高度) 小于 200px 时，加载更多
            if (docHeight - scrollTop - windowHeight < 200) {
                // 确保还有更多数据可加载
                if ((historyPage + 1) * HISTORY_PAGE_SIZE < historyAllFiltered.length) {
                    // 防抖：简单的防抖处理，防止短时间内多次触发（可选，这里利用 renderHistory 重置 DOM 稍微起到节流作用，但严谨点可以加个锁）
                    // 这里直接复用原有逻辑
                    historyPage++;
                    renderHistory(false);
                }
            }
        }
        /**
         * 显示咖啡豆选择弹出层
         * @returns {void}
         */
        function showBeanDropdown() {
            const overlay = document.getElementById('bean-select-overlay');
            const list = document.getElementById('bean-select-list');
            const searchInput = document.getElementById('bean-search-overlay-input');
            if (overlay && list) {
                overlay.classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
                
                // 生成咖啡豆列表
                let html = `<button onclick="event.stopPropagation(); setBeanFilter('ALL'); updateBeanSearchInput(''); filterSearch=''; hideBeanDropdown();" class="w-full text-left px-3 py-2.5 rounded-lg text-sm hover:bg-stone-800 transition-colors ${filterBean === 'ALL' ? 'bg-stone-800 text-amber-500' : 'text-stone-300'}" data-bean-name="">全部</button>`;
                DB.beans.forEach(b => {
                    html += `<button onclick="event.stopPropagation(); setBeanFilter('${b.id}'); updateBeanSearchInput('${b.name.replace(/'/g, "\\'")}'); filterSearch=''; hideBeanDropdown();" class="w-full text-left px-3 py-2.5 rounded-lg text-sm hover:bg-stone-800 transition-colors ${filterBean === b.id ? 'bg-stone-800 text-amber-500' : 'text-stone-300'}" data-bean-name="${b.name.toLowerCase()}">${b.name}</button>`;
                });
                list.innerHTML = html;
                
                // 清空搜索框
                if (searchInput) {
                    searchInput.value = '';
                }
                
                // 点击外部关闭
                overlay.onclick = (e) => {
                    if (e.target === overlay) {
                        hideBeanDropdown();
                    }
                };
                
                renderIconsWithRetry();
            }
        }
        
        /**
         * 隐藏咖啡豆选择弹出层
         * @returns {void}
         */
        function hideBeanDropdown() {
            const overlay = document.getElementById('bean-select-overlay');
            if (overlay) {
                overlay.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
            }
        }
        
        /**
         * 过滤弹出层列表中的咖啡豆
         * @param {string} value - 搜索值
         * @returns {void}
         */
        function filterBeanDropdown(value) {
            const list = document.getElementById('bean-select-list');
            if (!list) return;
            const buttons = list.querySelectorAll('button[data-bean-name]');
            const searchLower = value.toLowerCase();
            buttons.forEach(btn => {
                const beanName = btn.getAttribute('data-bean-name') || '';
                if (beanName.includes(searchLower) || value.length === 0) {
                    btn.style.display = '';
                } else {
                    btn.style.display = 'none';
                }
            });
        }
        
        /**
         * 更新咖啡豆搜索输入框的值
         * @param {string} value - 要设置的值
         * @returns {void}
         */
        function updateBeanSearchInput(value) {
            const input = document.getElementById('bean-search-input');
            if (input) {
                input.value = value;
            }
        }
        
        /**
         * 筛选咖啡豆搜索
         * @param {string} value - 搜索值
         * @returns {void}
         */
        function filterBeanSearch(value) {
            filterSearch = value;
            // 过滤下拉列表
            filterBeanDropdown(value);
            // 如果搜索值完全匹配某个豆子，自动选择
            const matchedBean = DB.beans.find(b => b.name.toLowerCase() === value.toLowerCase());
            if (matchedBean && value.length > 0) {
                filterBean = matchedBean.id;
                renderHistory(true);
            } else if (value.length === 0) {
                filterBean = 'ALL';
                renderHistory(true);
            } else {
                // 只过滤，不自动选择，让用户从下拉列表中选择
                filterBean = 'ALL';
                renderHistory(true);
            }
        }
        
        /**
         * 获取烘焙度对应的背景颜色
         * @param {string} roast - 烘焙度
         * @returns {string} 颜色值
         */
        function getRoastColor(roast) {
            if (!roast) return '#57534e'; // 默认石灰色 (Stone-600)
            const r = roast.toLowerCase();
            
            // 1. 先判断复合词 (特定程度)
            if (r.includes('中浅') || r.includes('medium-light')) return '#b8864a'; // 中浅棕
            if (r.includes('中深') || r.includes('medium-dark')) return '#6b4e1a'; // 中深棕
            if (r.includes('极深') || r.includes('very-dark')) return '#2a1a05'; // 黑咖色
            
            // 2. 再判断单字 (通用程度)
            if (r.includes('浅') || r.includes('light')) return '#d4a574'; // 浅金棕
            if (r.includes('深') || r.includes('dark')) return '#4a2c0a'; // 深棕
            if (r.includes('中') || r.includes('medium')) return '#8b6914'; // 中棕 (琥珀色)
            
            return '#57534e'; // 默认
        }
        
        /**
         * 清除记录图片
         * @returns {void}
         */
        function clearLogImage() {
            STATE.newLogImage = null;
            const preview = document.getElementById('log-image-preview');
            const container = document.getElementById('log-image-preview-container');
            const input = document.getElementById('input-log-image');
            if (preview) preview.src = '';
            if (container) container.classList.add('hidden');
            if (input) input.value = '';
        }
        
        /**
         * 格式化日期范围显示
         * @param {string} start - 开始日期
         * @param {string} end - 结束日期
         * @returns {string} 格式化后的日期字符串
         */
        function formatDateRange(start, end) {
            if (!start && !end) return '日期筛选';
            if (start && end) {
                const startDate = new Date(start);
                const endDate = new Date(end);
                const startStr = `${startDate.getMonth() + 1}/${startDate.getDate()}`;
                const endStr = `${endDate.getMonth() + 1}/${endDate.getDate()}`;
                return `${startStr} - ${endStr}`;
            }
            if (start) {
                const startDate = new Date(start);
                return `从 ${startDate.getMonth() + 1}/${startDate.getDate()}`;
            }
            if (end) {
                const endDate = new Date(end);
                return `至 ${endDate.getMonth() + 1}/${endDate.getDate()}`;
            }
            return '日期筛选';
        }
        
        /**
         * 切换日期筛选弹出层显示/隐藏
         * @returns {void}
         */
        function toggleDateFilter() {
            const overlay = document.getElementById('date-filter-overlay');
            if (overlay) {
                if (overlay.classList.contains('hidden')) {
                    overlay.classList.remove('hidden');
                    document.body.classList.add('overflow-hidden');
                    // 更新输入框的值
                    const startInput = overlay.querySelector('#filter-date-start');
                    const endInput = overlay.querySelector('#filter-date-end');
                    if (startInput) startInput.value = filterDateStart;
                    if (endInput) endInput.value = filterDateEnd;
                    renderIconsWithRetry();
                } else {
                    overlay.classList.add('hidden');
                    document.body.classList.remove('overflow-hidden');
                }
            }
        }

        /**
         * 自定义确认弹窗（替代系统 confirm）
         * @param {string} message - 提示信息
         * @returns {Promise<boolean>} - 用户确认返回 true，取消返回 false
         */
        function showConfirm(message) {
            return new Promise((resolve) => {
                const overlay = document.getElementById('confirm-overlay');
                const messageEl = document.getElementById('confirm-message');
                const titleEl = document.getElementById('confirm-title');
                const iconEl = document.getElementById('confirm-icon');
                const btnCancel = document.getElementById('confirm-cancel');
                const btnOk = document.getElementById('confirm-ok');

                messageEl.textContent = message;
                // 设置标题和图标为删除样式
                if (titleEl) titleEl.textContent = '确认删除';
                if (iconEl) {
                    iconEl.className = 'w-10 h-10 rounded-full bg-red-500/20 flex items-center justify-center flex-shrink-0';
                    iconEl.innerHTML = '<i data-lucide="alert-triangle" class="w-5 h-5 text-red-500"></i>';
                }
                if (btnOk) btnOk.textContent = '删除';
                if (btnCancel) {
                    btnCancel.style.display = 'flex';
                    btnCancel.style.alignItems = 'center';
                    btnCancel.style.justifyContent = 'center';
                }
                overlay.classList.remove('hidden');
                document.body.classList.add('overflow-hidden');

                const cleanup = () => {
                    overlay.classList.add('hidden');
                    document.body.classList.remove('overflow-hidden');
                    btnCancel.onclick = null;
                    btnOk.onclick = null;
                    overlay.onclick = null;
                };

                btnCancel.onclick = () => {
                    cleanup();
                    resolve(false);
                };

                btnOk.onclick = () => {
                    cleanup();
                    resolve(true);
                };

                overlay.onclick = (e) => {
                    if (e.target === overlay) {
                        cleanup();
                        resolve(false);
                    }
                };

                renderIconsWithRetry();
            });
        }

        /**
         * 自定义提示弹窗（替代系统 alert，仅显示消息）
         * @param {string} message - 提示信息
         * @returns {Promise<void>}
         */
        function showAlert(message) {
            return new Promise((resolve) => {
                const overlay = document.getElementById('confirm-overlay');
                const messageEl = document.getElementById('confirm-message');
                const titleEl = document.getElementById('confirm-title');
                const iconEl = document.getElementById('confirm-icon');
                const btnCancel = document.getElementById('confirm-cancel');
                const btnOk = document.getElementById('confirm-ok');

                messageEl.textContent = message;
                // 设置标题和图标为提示样式
                if (titleEl) titleEl.textContent = '提示';
                if (iconEl) {
                    iconEl.className = 'w-10 h-10 rounded-full bg-amber-500/20 flex items-center justify-center flex-shrink-0';
                    iconEl.innerHTML = '<i data-lucide="info" class="w-5 h-5 text-amber-500"></i>';
                }
                btnCancel.style.display = 'none';
                btnOk.textContent = '确定';
                overlay.classList.remove('hidden');
                document.body.classList.add('overflow-hidden');

                const cleanup = () => {
                    overlay.classList.add('hidden');
                    document.body.classList.remove('overflow-hidden');
                    btnCancel.style.display = 'flex';
                    btnCancel.style.alignItems = 'center';
                    btnCancel.style.justifyContent = 'center';
                    btnOk.textContent = '删除';
                    // 恢复标题和图标为默认删除样式
                    const titleEl = document.getElementById('confirm-title');
                    const iconEl = document.getElementById('confirm-icon');
                    if (titleEl) titleEl.textContent = '确认删除';
                    if (iconEl) {
                        iconEl.className = 'w-10 h-10 rounded-full bg-red-500/20 flex items-center justify-center flex-shrink-0';
                        iconEl.innerHTML = '<i data-lucide="alert-triangle" class="w-5 h-5 text-red-500"></i>';
                    }
                    btnOk.onclick = null;
                    overlay.onclick = null;
                };

                btnOk.onclick = () => {
                    cleanup();
                    resolve();
                };

                overlay.onclick = (e) => {
                    if (e.target === overlay) {
                        cleanup();
                        resolve();
                    }
                };

                renderIconsWithRetry();
            });
        }

        function toggleFilter(type) {
            if (type === 'god') {
                filterGod = !filterGod;
                document.getElementById('filter-god').className = filterGod ? 'flex-shrink-0 flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium border bg-amber-500/10 border-amber-500/50 text-amber-500 transition-colors' : 'flex-shrink-0 flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium border border-stone-800 text-stone-400 transition-colors';
            }
            renderHistory(true); // 重置分页
        }
        function setBeanFilter(id) { filterBean = id; filterSearch = ''; renderHistory(true); }
        
        /**
         * 设置日期筛选
         * @param {string} type - 'start' 或 'end'
         * @param {string} value - 日期值
         * @returns {void}
         */
        function setDateFilter(type, value) {
            if (type === 'start') {
                filterDateStart = value;
            } else if (type === 'end') {
                filterDateEnd = value;
            }
            // 验证日期范围：开始日期不能晚于结束日期
            if (filterDateStart && filterDateEnd && filterDateStart > filterDateEnd) {
                if (type === 'start') {
                    filterDateEnd = filterDateStart;
                    const endInput = document.getElementById('filter-date-end');
                    if (endInput) endInput.value = filterDateStart;
                } else {
                    filterDateStart = filterDateEnd;
                    const startInput = document.getElementById('filter-date-start');
                    if (startInput) startInput.value = filterDateEnd;
                }
            }
            renderHistory(true);
        }
        
        /**
         * 清除日期筛选
         * @returns {void}
         */
        function clearDateFilter() {
            filterDateStart = '';
            filterDateEnd = '';
            const overlay = document.getElementById('date-filter-overlay');
            if (overlay) {
                const startInput = overlay.querySelector('#filter-date-start');
                const endInput = overlay.querySelector('#filter-date-end');
                if (startInput) startInput.value = '';
                if (endInput) endInput.value = '';
            }
            renderHistory(true);
        }
        async function deleteLog(id) {
            const confirmed = await showConfirm("确定要删除这条记录吗？");
            if (confirmed) {
                DB.logs = DB.logs.filter(l => l.id !== id);
                saveData();
                renderHistory();
            }
        }

        /**
         * 从历史记录加载一条日志到记录页进行修改
         * @param {string} id - 日志 ID
         * @returns {void}
         */
        function loadLogToForm(id) {
            const log = DB.logs.find(l => l.id === id);
            if (!log) return;

            STATE.editingLogId = id;
            const saveTextEl = document.getElementById('btn-save-log-text');
            if (saveTextEl) saveTextEl.textContent = '保存修改';

            // 选择豆子
            if (log.beanId && DB.beans.find(b => b.id === log.beanId)) {
                document.getElementById('input-bean').value = log.beanId;
                updateBeanHero();
            }

            // 恢复刻度 / 粉重 / 液重 / 时间 / 水温 / 牛奶
            document.getElementById('input-grind-size').value = log.grindSize || '';
            document.getElementById('input-dose').value = log.dose;
            document.getElementById('input-yield').value = log.yield;
            document.getElementById('input-time').value = log.time;
            document.getElementById('input-temp').value = log.temp || '93';
            if (log.milkWeight) document.getElementById('input-milk-weight').value = log.milkWeight;
            if (log.milkId && DB.milks.find(m => m.id === log.milkId)) {
                document.getElementById('input-milk').value = log.milkId;
            }
            updateTempColor();

            // 评分 / 标签 / 备注
            STATE.currentRating = log.rating || 0;
            STATE.selectedTags = Array.isArray(log.tags) ? [...log.tags] : [];
            STATE.isGodShot = !!log.isGodShot;
            renderStars();
            
            // 恢复图片
            if (log.image) {
                STATE.newLogImage = log.image;
                const preview = document.getElementById('log-image-preview');
                const container = document.getElementById('log-image-preview-container');
                if (preview) preview.src = log.image;
                if (container) container.classList.remove('hidden');
            } else {
                clearLogImage();
            }
            renderTags();

            const notesEl = document.getElementById('input-notes');
            notesEl.value = log.notes || '';

            // 完美萃取按钮样式
            const godBtn = document.getElementById('btn-god-shot');
            godBtn.className = STATE.isGodShot
                ? 'flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-bold transition-all bg-gradient-to-r from-amber-500 to-yellow-500 text-black shadow-[0_0_15px_rgba(245,158,11,0.5)] transform scale-105'
                : 'flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-bold transition-all bg-stone-800 text-stone-500 border border-stone-700 active:scale-95';

            // 切换回记录页
            switchTab('record');
        }

        /**
         * 显示历史记录详情弹窗
         * @param {string} id - 记录ID
         * @returns {void}
         */
        function showLogDetailModal(id) {
            const log = DB.logs.find(l => l.id === id);
            if (!log) return;

            const currentBean = log.beanId ? DB.beans.find(b => b.id === log.beanId) : null;
            const displayImage = log.image || currentBean?.image;
            const roastDays = currentBean ? getRoastDays(currentBean.roastDate, log.date) : null;
            const stageInfo = getRoastStage(log.beanRoast, roastDays, log.beanId || null);
            const roastColor = getRoastColor(log.beanRoast);

            const costInfo = (() => {
                const bean = log.beanId ? DB.beans.find(b => b.id === log.beanId) : null;
                const milk = log.milkId ? DB.milks.find(m => m.id === log.milkId) : null;
                if (typeof log.totalCost === 'number' && log.totalCost > 0) {
                    return { beanCost: log.beanCost || 0, milkCost: log.milkCost || 0, totalCost: log.totalCost };
                }
                return computeCupCost({
                    bean,
                    milk,
                    dose: parseFloat(log.dose) || 0,
                    milkWeight: parseFloat(log.milkWeight) || 0
                });
            })();

            const date = new Date(log.date);
            const dateStr = `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日 ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;

            const content = `
                <div class="space-y-4">
                    <!-- 头部信息 -->
                    <div class="flex items-start gap-3">
                        <div class="w-20 h-20 rounded-xl overflow-hidden flex-shrink-0 border-2 ${log.isGodShot ? 'border-amber-500' : 'border-stone-700'}" style="background: ${roastColor};">
                            ${displayImage ? `<img src="${displayImage}" class="w-full h-full object-cover">` : '<div class="w-full h-full flex items-center justify-center"><i data-lucide="coffee" class="text-white/30 w-8 h-8"></i></div>'}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                ${log.rating ? `<div class="flex items-center gap-0.5 text-amber-500 font-bold text-lg flex-shrink-0"><span>${log.rating}</span><i data-lucide="star" class="w-4 h-4 fill-current"></i></div>` : ''}
                                <h3 class="text-base font-bold ${log.isGodShot ? 'text-amber-100' : 'text-stone-200'}">${log.milkName ? `${log.beanName} × ${log.milkName}` : log.beanName}</h3>
                            </div>
                            ${log.beanRoast ? `
                                <div class="flex items-center gap-1.5 mb-2 flex-wrap">
                                    <div class="text-[10px] font-bold text-white inline-block px-2 py-0.5 rounded-full" style="background-color: ${roastColor}">${log.beanRoast}</div>
                                    ${stageInfo && roastDays !== null ? `<div class="text-[10px] font-bold text-white inline-block px-2 py-0.5 rounded-full" style="background-color: ${stageInfo.color}">${stageInfo.text}</div>` : ''}
                                </div>
                            ` : ''}
                            <div class="text-xs text-stone-400 space-y-0.5">
                                <div>${dateStr}</div>
                                <div>${log.grinderName || '未知磨豆机'}${log.machineName ? ` · ${log.machineName}` : ''}</div>
                                ${roastDays !== null ? `<div>烘焙 ${roastDays} 天</div>` : ''}
                                ${costInfo.totalCost > 0 ? `<div class="text-amber-400">成本 ${formatCurrency(costInfo.totalCost)}${costInfo.beanCost || costInfo.milkCost ? `（豆${formatCurrency(costInfo.beanCost)}${costInfo.milkCost ? ` / 奶${formatCurrency(costInfo.milkCost)}` : ''}）` : ''}</div>` : ''}
                            </div>
                        </div>
                    </div>

                    <!-- 参数网格 -->
                    <div class="grid grid-cols-3 gap-2">
                        <div class="bg-black/30 px-3 py-2 rounded border border-stone-800 text-center">
                            <div class="text-[9px] text-stone-500 uppercase mb-1">刻度</div>
                            <div class="text-sm font-bold text-amber-500 font-mono">${log.grindSize || '-'}</div>
                        </div>
                        <div class="bg-black/30 px-3 py-2 rounded border border-stone-800 text-center">
                            <div class="text-[9px] text-stone-500 uppercase mb-1">粉重</div>
                            <div class="text-sm text-stone-300 font-mono">${log.dose || '0'}g</div>
                        </div>
                        <div class="bg-black/30 px-3 py-2 rounded border border-stone-800 text-center">
                            <div class="text-[9px] text-stone-500 uppercase mb-1">液重</div>
                            <div class="text-sm text-stone-300 font-mono">${log.yield || '0'}g</div>
                        </div>
                        <div class="bg-black/30 px-3 py-2 rounded border border-stone-800 text-center">
                            <div class="text-[9px] text-stone-500 uppercase mb-1">牛奶</div>
                            <div class="text-sm text-stone-300 font-mono">${log.milkWeight && parseFloat(log.milkWeight) > 0 ? log.milkWeight + 'g' : '-'}</div>
                        </div>
                        <div class="bg-black/30 px-3 py-2 rounded border border-stone-800 text-center">
                            <div class="text-[9px] text-stone-500 uppercase mb-1">时间</div>
                            <div class="text-sm text-stone-300 font-mono">${log.time || '0'}s</div>
                        </div>
                        <div class="bg-black/30 px-3 py-2 rounded border border-stone-800 text-center">
                            <div class="text-[9px] text-stone-500 uppercase mb-1">水温</div>
                            <div class="text-sm text-stone-300 font-mono">${log.temp || '-'}°C</div>
                        </div>
                    </div>

                    <!-- 比例显示 -->
                    ${(() => {
                        const milkWeight = parseFloat(log.milkWeight) || 0;
                        const yield = parseFloat(log.yield) || 0;
                        const dose = parseFloat(log.dose) || 0;
                        const milkCoffeeRatio = (yield > 0 && milkWeight > 0) ? (milkWeight / yield).toFixed(1) : null;
                        const doseYieldRatio = (yield > 0 && dose > 0) ? (yield / dose).toFixed(1) : null;
                        
                        if (!milkCoffeeRatio && !doseYieldRatio) return '';
                        
                        return `
                            <div class="grid grid-cols-2 gap-2">
                                ${milkCoffeeRatio !== null ? `
                                    <div class="bg-black/30 px-3 py-2 rounded border border-stone-800 text-center">
                                        <div class="text-[9px] text-stone-500 uppercase mb-1">奶咖比</div>
                                        <div class="text-sm text-stone-300 font-mono">1:${milkCoffeeRatio}</div>
                                    </div>
                                ` : ''}
                                ${doseYieldRatio !== null ? `
                                    <div class="bg-black/30 px-3 py-2 rounded border border-stone-800 text-center">
                                        <div class="text-[9px] text-stone-500 uppercase mb-1">粉液比</div>
                                        <div class="text-sm text-stone-300 font-mono">1:${doseYieldRatio}</div>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    })()}

                    <!-- 标签 -->
                    ${log.tags && log.tags.length > 0 ? `
                        <div>
                            <div class="text-[10px] font-bold text-stone-500 uppercase mb-2">标签</div>
                            <div class="flex flex-wrap gap-1.5">
                                ${log.tags.map(t => `<span class="text-xs text-stone-300 bg-stone-800/80 px-2 py-1 rounded">${t}</span>`).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- 备注 -->
                    ${log.notes ? `
                        <div>
                            <div class="text-[10px] font-bold text-stone-500 uppercase mb-2">备注</div>
                            <div class="bg-black/20 p-3 rounded text-sm text-stone-400 border border-white/5 leading-relaxed">
                                ${log.notes}
                            </div>
                        </div>
                    ` : ''}

                    <!-- 图片 -->
                    ${log.image ? `
                        <div>
                            <div class="text-[10px] font-bold text-stone-500 uppercase mb-2">图片</div>
                            <img src="${log.image}" alt="记录图片" class="w-full max-w-xs rounded-xl border border-stone-700 object-cover">
                        </div>
                    ` : ''}
                </div>
            `;

            const contentEl = document.getElementById('log-detail-content');
            if (contentEl) {
                contentEl.innerHTML = content;
            }

            const modal = document.getElementById('log-detail-modal');
            if (modal) {
                modal.classList.remove('hidden');
                renderIconsWithRetry();
            }
        }

        /**
         * 隐藏历史记录详情弹窗
         * @returns {void}
         */
        function hideLogDetailModal() {
            const modal = document.getElementById('log-detail-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        /**
         * 显示历史记录编辑弹窗
         * @param {string} id - 记录ID
         * @returns {void}
         */
        function showLogEditModal(id) {
            const log = DB.logs.find(l => l.id === id);
            if (!log) return;

            STATE.editingLogId = id;

            // 如果没有保存ID，尝试通过名称查找ID
            let machineId = log.machineId || '';
            let grinderId = log.grinderId || '';
            if (!machineId && log.machineName) {
                const found = DB.machines.find(m => m.name === log.machineName);
                if (found) machineId = found.id;
            }
            if (!grinderId && log.grinderName) {
                const found = DB.grinders.find(g => g.name === log.grinderName);
                if (found) grinderId = found.id;
            }

            // 生成编辑表单HTML
            const content = `
                <form onsubmit="event.preventDefault(); saveLogFromModal();" class="space-y-4">
                    <!-- 豆子和牛奶选择 -->
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[10px] font-bold text-stone-500 uppercase mb-1 block">咖啡豆</label>
                            <select id="edit-log-bean" class="block w-full appearance-none bg-[#0a0a0a] border border-stone-800 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-amber-600">
                                ${DB.beans.map(b => `<option value="${b.id}" ${b.id === log.beanId ? 'selected' : ''}>${b.name}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-stone-500 uppercase mb-1 block">牛奶</label>
                            <select id="edit-log-milk" class="block w-full appearance-none bg-[#0a0a0a] border border-stone-800 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-amber-600">
                                <option value="">无</option>
                                ${DB.milks.map(m => `<option value="${m.id}" ${m.id === log.milkId ? 'selected' : ''}>${m.name}</option>`).join('')}
                            </select>
                        </div>
                    </div>

                    <!-- 设备选择 -->
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[10px] font-bold text-stone-500 uppercase mb-1 block">咖啡机</label>
                            <select id="edit-log-machine" class="block w-full appearance-none bg-[#0a0a0a] border border-stone-800 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-amber-600">
                                <option value="">无</option>
                                ${DB.machines.map(m => `<option value="${m.id}" ${m.id === machineId ? 'selected' : ''}>${m.name}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-stone-500 uppercase mb-1 block">磨豆机</label>
                            <select id="edit-log-grinder" class="block w-full appearance-none bg-[#0a0a0a] border border-stone-800 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-amber-600">
                                <option value="">无</option>
                                ${DB.grinders.map(g => `<option value="${g.id}" ${g.id === grinderId ? 'selected' : ''}>${g.name}</option>`).join('')}
                            </select>
                        </div>
                    </div>

                    <!-- 核心参数 -->
                    <div class="grid grid-cols-3 gap-2">
                        <div>
                            <label class="text-[9px] text-stone-600 mb-0.5 block">刻度</label>
                            <input id="edit-log-grind-size" type="text" value="${log.grindSize || ''}" class="block w-full appearance-none bg-[#0a0a0a] border border-stone-800 rounded-lg px-2 py-2 text-xs text-white focus:outline-none focus:border-amber-600">
                        </div>
                        <div>
                            <label class="text-[9px] text-stone-600 mb-0.5 block">粉重 (g)</label>
                            <input id="edit-log-dose" type="number" step="0.1" value="${log.dose || ''}" class="block w-full appearance-none bg-[#0a0a0a] border border-stone-800 rounded-lg px-2 py-2 text-xs text-white focus:outline-none focus:border-amber-600">
                        </div>
                        <div>
                            <label class="text-[9px] text-stone-600 mb-0.5 block">液重 (g)</label>
                            <input id="edit-log-yield" type="number" step="0.1" value="${log.yield || ''}" class="block w-full appearance-none bg-[#0a0a0a] border border-stone-800 rounded-lg px-2 py-2 text-xs text-white focus:outline-none focus:border-amber-600">
                        </div>
                        <div>
                            <label class="text-[9px] text-stone-600 mb-0.5 block">牛奶 (g)</label>
                            <input id="edit-log-milk-weight" type="number" step="1" value="${log.milkWeight || ''}" class="block w-full appearance-none bg-[#0a0a0a] border border-stone-800 rounded-lg px-2 py-2 text-xs text-white focus:outline-none focus:border-amber-600">
                        </div>
                        <div>
                            <label class="text-[9px] text-stone-600 mb-0.5 block">时间 (s)</label>
                            <input id="edit-log-time" type="number" step="1" value="${log.time || ''}" class="block w-full appearance-none bg-[#0a0a0a] border border-stone-800 rounded-lg px-2 py-2 text-xs text-white focus:outline-none focus:border-amber-600">
                        </div>
                        <div>
                            <label class="text-[9px] text-stone-600 mb-0.5 block">水温 (°C)</label>
                            <input id="edit-log-temp" type="number" step="1" value="${log.temp || ''}" class="block w-full appearance-none bg-[#0a0a0a] border border-stone-800 rounded-lg px-2 py-2 text-xs text-white focus:outline-none focus:border-amber-600">
                        </div>
                    </div>

                    <!-- 评分 -->
                    <div>
                        <label class="text-[10px] font-bold text-stone-500 uppercase mb-2 block">评分</label>
                        <div id="edit-log-stars" class="flex gap-2 justify-center"></div>
                    </div>

                    <!-- 完美萃取 -->
                    <div>
                        <button type="button" id="edit-log-god-shot" onclick="toggleEditLogGodShot()" class="w-full flex items-center justify-center gap-1.5 px-3 py-2 rounded-full text-xs font-bold transition-all ${log.isGodShot ? 'bg-gradient-to-r from-amber-500 to-yellow-500 text-black' : 'bg-stone-800 text-stone-500 border border-stone-700'}">
                            <i data-lucide="crown" class="w-3"></i> 完美萃取
                        </button>
                    </div>

                    <!-- 标签 -->
                    <div>
                        <label class="text-[10px] font-bold text-stone-500 uppercase mb-2 block">标签</label>
                        <div id="edit-log-tags" class="flex flex-wrap gap-2"></div>
                    </div>

                    <!-- 备注 -->
                    <div>
                        <label class="text-[10px] font-bold text-stone-500 uppercase mb-1 block">备注</label>
                        <textarea id="edit-log-notes" class="block w-full appearance-none bg-[#0a0a0a] border border-stone-800 rounded-lg px-3 py-2 text-sm text-stone-300 focus:outline-none focus:border-amber-600 resize-none min-h-[80px]">${log.notes || ''}</textarea>
                    </div>

                    <!-- 按钮 -->
                    <div class="flex gap-3 pt-2">
                        <button type="button" onclick="hideLogEditModal()" class="flex-1 px-4 py-2.5 rounded-xl text-xs font-bold bg-stone-800 border border-stone-700 text-stone-400 hover:bg-stone-700 transition-all active:scale-95">取消</button>
                        <button type="submit" class="flex-1 px-4 py-2.5 rounded-xl text-xs font-bold bg-amber-600 text-white hover:bg-amber-500 border border-amber-600 transition-all active:scale-95 shadow-lg shadow-amber-900/20">保存修改</button>
                    </div>
                </form>
            `;

            const contentEl = document.getElementById('log-edit-content');
            if (contentEl) {
                contentEl.innerHTML = content;
            }

            // 初始化评分星星
            renderEditLogStars(log.rating || 0);
            
            // 初始化标签
            renderEditLogTags(log.tags || []);

            // 初始化完美萃取状态
            STATE.editLogGodShot = !!log.isGodShot;

            const modal = document.getElementById('log-edit-modal');
            if (modal) {
                modal.classList.remove('hidden');
                renderIconsWithRetry();
            }
        }

        /**
         * 隐藏历史记录编辑弹窗
         * @returns {void}
         */
        function hideLogEditModal() {
            const modal = document.getElementById('log-edit-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
            STATE.editingLogId = null;
        }

        /**
         * 渲染编辑弹窗的评分星星（支持半颗星）
         * @param {number} rating - 评分值
         * @returns {void}
         */
        function renderEditLogStars(rating) {
            const container = document.getElementById('edit-log-stars');
            if (!container) return;

            STATE.editLogRating = rating;
            const fillColor = '#d97706';
            const strokeColor = '#44403c';
            
            container.innerHTML = [1, 2, 3, 4, 5].map(i => {
                const isFull = rating >= i;
                const isHalf = rating >= i - 0.5 && rating < i;
                const currentStrokeColor = (isFull || isHalf) ? fillColor : strokeColor;
                
                return `
                    <div class="relative inline-block" style="width: 48px; height: 48px; padding: 4px;">
                        <svg width="40" height="40" viewBox="0 0 24 24" class="pointer-events-none">
                            <defs>
                                <clipPath id="edit-clip-left-${i}">
                                    <rect x="0" y="0" width="12" height="24"/>
                                </clipPath>
                                <clipPath id="edit-clip-right-${i}">
                                    <rect x="12" y="0" width="12" height="24"/>
                                </clipPath>
                            </defs>
                            <!-- 左半部分填充（半颗星） -->
                            <polygon 
                                points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" 
                                fill="${isHalf || isFull ? fillColor : 'none'}" 
                                stroke="none"
                                clip-path="url(#edit-clip-left-${i})"
                            />
                            <!-- 右半部分填充（整颗星） -->
                            <polygon 
                                points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" 
                                fill="${isFull ? fillColor : 'none'}" 
                                stroke="none"
                                clip-path="url(#edit-clip-right-${i})"
                            />
                            <!-- 完整轮廓 -->
                            <polygon 
                                points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" 
                                fill="none" 
                                stroke="${currentStrokeColor}" 
                                stroke-width="2" 
                                stroke-linecap="round" 
                                stroke-linejoin="round"
                            />
                        </svg>
                        <!-- 左半部分触摸区域：半颗星 -->
                        <button 
                            type="button"
                            onclick="setEditLogRating(${i - 0.5})" 
                            class="absolute left-0 top-0 w-1/2 h-full cursor-pointer focus:outline-none transition-transform active:scale-110 touch-manipulation"
                            style="z-index: 2; background: transparent; min-width: 24px; min-height: 48px; -webkit-tap-highlight-color: transparent;"
                            title="${i - 0.5}星"
                        ></button>
                        <!-- 右半部分触摸区域：整颗星 -->
                        <button 
                            type="button"
                            onclick="setEditLogRating(${i})" 
                            class="absolute right-0 top-0 w-1/2 h-full cursor-pointer focus:outline-none transition-transform active:scale-110 touch-manipulation"
                            style="z-index: 2; background: transparent; min-width: 24px; min-height: 48px; -webkit-tap-highlight-color: transparent;"
                            title="${i}星"
                        ></button>
                    </div>
                `;
            }).join('');
            renderIconsWithRetry();
        }

        /**
         * 设置编辑弹窗的评分（支持半颗星）
         * @param {number} r - 评分值
         * @returns {void}
         */
        function setEditLogRating(r) {
            STATE.editLogRating = r;
            renderEditLogStars(r);
        }

        /**
         * 渲染编辑弹窗的标签
         * @param {string[]} selectedTags - 已选标签
         * @returns {void}
         */
        function renderEditLogTags(selectedTags) {
            const container = document.getElementById('edit-log-tags');
            if (!container) return;

            STATE.editLogTags = Array.isArray(selectedTags) ? [...selectedTags] : [];
            const allTags = [...DEFAULT_TAGS, ...(DB.customTags || [])].filter(t => !DB.deletedDefaultTags.includes(t));
            
            container.innerHTML = allTags.map(tag => {
                const isSelected = STATE.editLogTags.includes(tag);
                return `
                    <button type="button" onclick="toggleEditLogTag('${tag}')" class="text-[10px] px-3 py-1.5 rounded-lg border transition-colors ${
                        isSelected 
                            ? 'bg-amber-600 text-white border-amber-600' 
                            : 'bg-stone-800 text-stone-400 border-stone-700 hover:border-stone-600'
                    }">
                        ${tag}
                    </button>
                `;
            }).join('');
            renderIconsWithRetry();
        }

        /**
         * 切换编辑弹窗的标签
         * @param {string} tag - 标签名
         * @returns {void}
         */
        function toggleEditLogTag(tag) {
            if (!STATE.editLogTags) STATE.editLogTags = [];
            const index = STATE.editLogTags.indexOf(tag);
            if (index > -1) {
                STATE.editLogTags.splice(index, 1);
            } else {
                STATE.editLogTags.push(tag);
            }
            renderEditLogTags(STATE.editLogTags);
        }

        /**
         * 切换编辑弹窗的完美萃取状态
         * @returns {void}
         */
        function toggleEditLogGodShot() {
            STATE.editLogGodShot = !STATE.editLogGodShot;
            const btn = document.getElementById('edit-log-god-shot');
            if (btn) {
                btn.className = STATE.editLogGodShot
                    ? 'w-full flex items-center justify-center gap-1.5 px-3 py-2 rounded-full text-xs font-bold transition-all bg-gradient-to-r from-amber-500 to-yellow-500 text-black'
                    : 'w-full flex items-center justify-center gap-1.5 px-3 py-2 rounded-full text-xs font-bold transition-all bg-stone-800 text-stone-500 border border-stone-700';
            }
        }

        /**
         * 从编辑弹窗保存记录
         * @returns {Promise<void>}
         */
        async function saveLogFromModal() {
            if (!STATE.editingLogId) return;

            const log = DB.logs.find(l => l.id === STATE.editingLogId);
            if (!log) return;

            const beanId = document.getElementById('edit-log-bean')?.value;
            if (!beanId) {
                await showAlert("请选择咖啡豆！");
                return;
            }

            const bean = DB.beans.find(b => b.id === beanId);
            const machineId = document.getElementById('edit-log-machine')?.value || '';
            const grinderId = document.getElementById('edit-log-grinder')?.value || '';
            const milkId = document.getElementById('edit-log-milk')?.value || '';
            const machine = DB.machines.find(m => m.id === machineId);
            const grinder = DB.grinders.find(g => g.id === grinderId);
            const milk = DB.milks.find(m => m.id === milkId);

            const doseVal = parseFloat(document.getElementById('edit-log-dose')?.value) || 0;
            const milkWeightVal = parseFloat(document.getElementById('edit-log-milk-weight')?.value) || 0;
            const { beanCost, milkCost, totalCost } = computeCupCost({ bean, milk, dose: doseVal, milkWeight: milkWeightVal });

            const updatedLog = {
                ...log,
                beanId: beanId,
                beanName: bean.name,
                beanRoast: bean.roast,
                machineId: machineId || '',
                machineName: machine ? machine.name : '未知设备',
                grinderId: grinderId || '',
                grinderName: grinder ? grinder.name : '未知磨豆机',
                milkId: milkId,
                milkName: milk ? milk.name : '',
                grindSize: document.getElementById('edit-log-grind-size')?.value || '-',
                dose: document.getElementById('edit-log-dose')?.value || '',
                yield: document.getElementById('edit-log-yield')?.value || '',
                milkWeight: document.getElementById('edit-log-milk-weight')?.value || '0',
                time: document.getElementById('edit-log-time')?.value || '',
                temp: document.getElementById('edit-log-temp')?.value || '',
                rating: STATE.editLogRating || 0,
                isGodShot: STATE.editLogGodShot || false,
                tags: STATE.editLogTags || [],
                notes: document.getElementById('edit-log-notes')?.value || '',
                beanCost,
                milkCost,
                totalCost
            };

            DB.logs = DB.logs.map(l => l.id === STATE.editingLogId ? updatedLog : l);
            saveData();
            hideLogEditModal();
            renderHistory();
            await showAlert("记录已更新！");
        }

        function switchGearSubTab(tab) {
            STATE.currentGearTab = tab;
            
            // 1. 更新顶部按钮高亮
            document.querySelectorAll('.gear-sub-tab').forEach(b => {
                if (b.dataset.target === tab) {
                    b.className = 'gear-sub-tab flex-1 py-2 text-xs font-bold uppercase rounded-lg transition-all bg-stone-800 text-white shadow-sm';
                } else {
                    b.className = 'gear-sub-tab flex-1 py-2 text-xs font-bold uppercase rounded-lg transition-all text-stone-500';
                }
            });
            
            // 2. 如果之前在编辑状态，切换 Tab 时重置表单
            if (STATE.editingAssetId && STATE.editingAssetType && STATE.editingAssetType !== tab) {
                STATE.editingAssetId = null;
                STATE.editingAssetType = null;
                STATE.newAssetImage = null;
                resetAssetForm();
            }
            
            // 3. 获取所有面板
            const gearList = document.getElementById('gear-list');
            const tagsList = document.getElementById('tags-list');
            const backupPanel = document.getElementById('backup-panel');
            const addButton = document.getElementById('gear-add-button-container');
            const sortContainer = document.getElementById('bean-sort-container');
            
            // === 4. 防弹逻辑：先全部隐藏 ===
            if (gearList) gearList.classList.add('hidden');
            if (tagsList) tagsList.classList.add('hidden');
            if (backupPanel) backupPanel.classList.add('hidden');
            if (addButton) addButton.classList.add('hidden');
            if (sortContainer) sortContainer.classList.add('hidden');
            
            // === 5. 按需显示 ===
            if (tab === 'backup') {
                // 显示备份
                if (backupPanel) backupPanel.classList.remove('hidden');
                updateStorageInfo();
                
            } else if (tab === 'tags') {
                // 显示标签列表
                if (tagsList) tagsList.classList.remove('hidden');
                renderTagsList();
                
            } else {
                // 显示添加按钮和资产列表 (beans, milks, machines, grinders)
                if (addButton) addButton.classList.remove('hidden');
                if (gearList) gearList.classList.remove('hidden');
                
                // 仅咖啡豆显示排序功能
                if (tab === 'beans' && sortContainer) {
                    sortContainer.classList.remove('hidden');
                    // 初始化排序按钮状态
                    updateBeanSortButtons();
                }
                
                renderGearList();
            }
            
            renderIconsWithRetry();
        }

        /**
         * 重置资产表单
         * @returns {void}
         */
        function resetAssetForm() {
            document.getElementById('new-asset-name').value = '';
            document.getElementById('new-asset-notes').value = '';
            document.getElementById('new-asset-preview').classList.add('hidden');
            document.getElementById('new-asset-icon').classList.remove('hidden');
            document.getElementById('new-asset-image').value = '';
            document.getElementById('new-asset-total').value = '';
            document.getElementById('new-asset-price').value = '';
            document.getElementById('new-asset-roast-date').value = '';
            document.getElementById('new-asset-recommended-dose').value = '';
            document.getElementById('new-asset-recommended-time').value = '';
            document.getElementById('new-asset-recommended-yield').value = '';
            document.getElementById('new-asset-recommended-temp').value = '';
            const roastSelect = document.getElementById('new-asset-roast');
            if (roastSelect) roastSelect.value = '中烘'; // 重置为默认值
            STATE.newAssetImage = null;
            
            // 重置自定义周期字段
            const customPeriodsContent = document.getElementById('bean-custom-periods-content');
            if (customPeriodsContent) {
                customPeriodsContent.classList.add('hidden');
                const chevron = document.getElementById('bean-custom-periods-chevron');
                if (chevron) chevron.style.transform = 'rotate(0deg)';
            }
            
            const titleEl = document.getElementById('asset-form-title');
            const btnEl = document.getElementById('asset-submit-btn');
            if (titleEl) titleEl.innerHTML = '<i data-lucide="plus-circle" class="w-4"></i> 添加新项目';
            if (btnEl) btnEl.textContent = '确认添加';
        }

        /**
         * 从表单获取豆子自定义赏味周期配置
         * @returns {Object|null} 自定义周期配置对象，如果没有配置则返回 null
         */
        function getBeanCustomPeriodsFromForm() {
            const stageNames = ['养豆期', '最佳赏味期', '赏味期', '赏味衰退期'];
            const customPeriods = {};
            let hasValue = false;

            stageNames.forEach(stageName => {
                const startInput = document.getElementById(`bean-custom-${stageName}-start`);
                const endInput = document.getElementById(`bean-custom-${stageName}-end`);
                
                if (startInput && endInput) {
                    const startValue = startInput.value.trim();
                    const endValue = endInput.value.trim();
                    
                    // 如果至少有一个字段有值，就保存配置
                    if (startValue || endValue) {
                        const start = startValue === '' ? 0 : parseFloat(startValue);
                        const end = endValue === '' ? Infinity : parseFloat(endValue);
                        
                        if (!isNaN(start) && !isNaN(end)) {
                            customPeriods[stageName] = [start, end];
                            hasValue = true;
                        }
                    }
                }
            });

            return hasValue ? customPeriods : null;
        }

        /**
         * 切换豆子自定义赏味周期展开/折叠
         * @returns {void}
         */
        function toggleBeanCustomPeriods() {
            const content = document.getElementById('bean-custom-periods-content');
            const chevron = document.getElementById('bean-custom-periods-chevron');
            if (content && chevron) {
                const isHidden = content.classList.contains('hidden');
                if (isHidden) {
                    content.classList.remove('hidden');
                    chevron.style.transform = 'rotate(180deg)';
                } else {
                    content.classList.add('hidden');
                    chevron.style.transform = 'rotate(0deg)';
                }
                renderIconsWithRetry();
            }
        }

        /**
         * 渲染豆子自定义赏味周期输入框
         * @returns {void}
         */
        function renderBeanCustomPeriodsInputs() {
            const container = document.getElementById('bean-custom-periods-inputs');
            if (!container) return;

            const roastSelect = document.getElementById('new-asset-roast');
            const currentRoast = roastSelect ? roastSelect.value : '中烘';
            const periods = getRoastPeriods();
            const currentPeriod = periods[currentRoast] || periods['中烘'];
            const stageNames = ['养豆期', '最佳赏味期', '赏味期', '赏味衰退期'];

            let html = '';
            stageNames.forEach(stageName => {
                const range = currentPeriod[stageName];
                if (!range) return;

                const startValue = range[0] === Infinity ? '' : range[0];
                const endValue = range[1] === Infinity ? '' : range[1];

                html += `<div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="text-[9px] text-stone-600 mb-0.5 block">${stageName} 开始 (天)</label>
                        <input 
                            type="number" 
                            id="bean-custom-${stageName}-start" 
                            value="" 
                            min="0" 
                            step="1"
                            placeholder="${startValue}"
                            class="w-full bg-[#0a0a0a] border border-stone-800 rounded-lg px-2 py-1.5 text-xs text-white focus:outline-none focus:border-amber-600"
                        >
                    </div>
                    <div>
                        <label class="text-[9px] text-stone-600 mb-0.5 block">${stageName} 结束 (天)</label>
                        <input 
                            type="number" 
                            id="bean-custom-${stageName}-end" 
                            value="" 
                            min="0" 
                            step="1"
                            placeholder="${endValue === Infinity ? '无限' : endValue}"
                            class="w-full bg-[#0a0a0a] border border-stone-800 rounded-lg px-2 py-1.5 text-xs text-white focus:outline-none focus:border-amber-600"
                        >
                    </div>
                </div>`;
            });

            container.innerHTML = html;

            // 监听烘焙度变化，更新占位符
            if (roastSelect) {
                roastSelect.addEventListener('change', function() {
                    renderBeanCustomPeriodsInputs();
                });
            }
        }

        /**
         * 显示资产表单弹窗
         * @param {boolean} skipReset - 是否跳过重置表单（用于编辑时）
         * @returns {void}
         */
        function showAssetFormModal(skipReset = false) {
            const modal = document.getElementById('asset-form-modal');
            const type = STATE.currentGearTab;
            
            // 如果不是编辑模式，重置表单
            if (!skipReset) {
                resetAssetForm();
            }
            
            // 根据类型显示/隐藏字段
            const roastEl = document.getElementById('new-asset-roast');
            const roastDateField = document.getElementById('roast-date-field');
            const recommendedParamsField = document.getElementById('recommended-params-field');
            const extraEl = document.getElementById('asset-extra-fields');
            const totalLabel = document.getElementById('asset-total-label');
            const priceLabel = document.getElementById('asset-price-label');
            
            // 烘焙度选择器：仅咖啡豆显示
            if (roastEl) roastEl.style.display = type === 'beans' ? 'block' : 'none';
            
            // 烘焙日期：仅咖啡豆显示
            if (roastDateField) roastDateField.style.display = type === 'beans' ? 'block' : 'none';
            
            // 推荐参数：仅咖啡豆显示
            if (recommendedParamsField) recommendedParamsField.style.display = type === 'beans' ? 'block' : 'none';
            
            // 自定义赏味周期：仅咖啡豆显示
            const beanCustomPeriodsField = document.getElementById('bean-custom-periods-field');
            if (beanCustomPeriodsField) {
                beanCustomPeriodsField.style.display = type === 'beans' ? 'block' : 'none';
                if (type === 'beans') {
                    renderBeanCustomPeriodsInputs();
                }
            }
            
            if (extraEl && totalLabel && priceLabel) {
                if (type === 'beans' || type === 'milks') {
                    extraEl.classList.remove('hidden');
                    totalLabel.textContent = type === 'beans' ? '总量 (g)' : '总量 (ml/g)';
                    priceLabel.textContent = '价格 (¥)';
                } else {
                    extraEl.classList.add('hidden');
                }
            }
            
            modal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            renderIconsWithRetry();
        }

        /**
         * 隐藏资产表单弹窗
         * @returns {void}
         */
        function hideAssetFormModal() {
            const modal = document.getElementById('asset-form-modal');
            modal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
            resetAssetForm();
        }

        /**
         * 显示调整剩余豆量弹窗
         * @param {string} beanId - 豆子ID
         * @returns {void}
         */
        function showAdjustBeanWeightModal(beanId) {
            const bean = DB.beans.find(b => b.id === beanId);
            if (!bean) return;
            
            STATE.adjustingBeanId = beanId;
            const remain = getBeanRemaining(bean);
            const usedInput = document.getElementById('adjust-bean-used');
            if (usedInput) {
                usedInput.value = remain.used;
            }
            
            const modal = document.getElementById('adjust-bean-weight-modal');
            modal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
        }

        /**
         * 隐藏调整剩余豆量弹窗
         * @returns {void}
         */
        function hideAdjustBeanWeightModal() {
            const modal = document.getElementById('adjust-bean-weight-modal');
            modal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
            STATE.adjustingBeanId = null;
        }

        /**
         * 确认调整剩余豆量
         * @returns {void}
         */
        function confirmAdjustBeanWeight() {
            if (!STATE.adjustingBeanId) return;
            
            const bean = DB.beans.find(b => b.id === STATE.adjustingBeanId);
            if (!bean) return;
            
            const usedInput = document.getElementById('adjust-bean-used');
            const newUsed = parseFloat(usedInput.value) || 0;
            
            // 保存手动调整的已用量
            bean.manualUsed = Math.max(0, newUsed);
            saveData();
            
            hideAdjustBeanWeightModal();
            renderGearList();
        }

        /**
         * 显示咖啡豆详情弹窗
         * @param {string} beanId - 咖啡豆ID
         * @returns {void}
         */
        function showBeanDetailModal(beanId) {
            const bean = DB.beans.find(b => b.id === beanId);
            if (!bean) return;
            
            const modal = document.getElementById('bean-detail-modal');
            const content = document.getElementById('bean-detail-content');
            
            if (!modal || !content) return;
            
            const remain = getBeanRemaining(bean);
            const roastDays = getRoastDays(bean.roastDate, new Date());
            const stageInfo = getRoastStage(bean.roast, roastDays, bean.id);
            const priceText = formatCurrency(bean.price);
            const unitCost = bean.totalWeight > 0 && bean.price > 0 ? getUnitCost(bean.totalWeight, bean.price) : null;
            
            // 构建详情内容HTML
            let html = '';
            
            // 图片
            if (bean.image) {
                html += `<div class="w-full h-48 rounded-xl overflow-hidden mb-4 cursor-pointer" onclick="showImagePreview('${bean.image.replace(/'/g, "\\'")}')">
                    <img src="${bean.image.replace(/"/g, '&quot;')}" alt="${bean.name}" class="w-full h-full object-cover">
                </div>`;
            }
            
            // 名称和标签
            html += `<div class="mb-4">
                <h4 class="text-lg font-bold text-stone-200 mb-2">${bean.name}</h4>
                <div class="flex items-center gap-2 flex-wrap">
                    ${bean.roast ? `<div class="text-[10px] font-bold text-white inline-block px-2 py-0.5 rounded-full" style="background-color: ${getRoastColor(bean.roast)}">${bean.roast}</div>` : ''}
                    ${stageInfo && roastDays !== null ? `<div class="text-[10px] font-bold text-white inline-block px-2 py-0.5 rounded-full" style="background-color: ${stageInfo.color}">${stageInfo.text}</div>` : ''}
                </div>
            </div>`;
            
            // 基本信息
            html += `<div class="space-y-3">
                <div class="grid grid-cols-2 gap-3">
                    ${bean.totalWeight > 0 ? `<div>
                        <div class="text-[10px] text-stone-500 mb-0.5">总量</div>
                        <div class="text-sm text-stone-200">${bean.totalWeight}g</div>
                    </div>` : ''}
                    ${priceText !== '-' ? `<div>
                        <div class="text-[10px] text-stone-500 mb-0.5">价格</div>
                        <div class="text-sm text-stone-200">${priceText}</div>
                    </div>` : ''}
                    ${unitCost ? `<div>
                        <div class="text-[10px] text-stone-500 mb-0.5">单价</div>
                        <div class="text-sm text-amber-500">¥${unitCost.toFixed(2)}/g</div>
                    </div>` : ''}
                    ${bean.roastDate ? `<div>
                        <div class="text-[10px] text-stone-500 mb-0.5">烘焙日期</div>
                        <div class="text-sm text-stone-200">${bean.roastDate}</div>
                    </div>` : ''}
                    ${roastDays !== null ? `<div>
                        <div class="text-[10px] text-stone-500 mb-0.5">烘焙天数</div>
                        <div class="text-sm text-stone-200">${roastDays} 天</div>
                    </div>` : ''}
                </div>
            </div>`;
            
            // 使用情况
            if (remain.total > 0) {
                html += `<div class="mt-4 pt-4 border-t border-stone-800">
                    <div class="text-[10px] text-stone-500 mb-2">使用情况</div>
                    <div class="space-y-1">
                        <div class="flex justify-between text-sm">
                            <span class="text-stone-400">已用</span>
                            <span class="text-stone-200">${remain.used}g</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-stone-400">剩余</span>
                            <span class="text-emerald-400">${remain.remaining}g</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-stone-400">总量</span>
                            <span class="text-stone-200">${remain.total}g</span>
                        </div>
                    </div>
                </div>`;
            }
            
            // 推荐参数
            if (bean.recommendedDose !== undefined || bean.recommendedTime !== undefined || bean.recommendedYield !== undefined || bean.recommendedTemp !== undefined) {
                html += `<div class="mt-4 pt-4 border-t border-stone-800">
                    <div class="text-[10px] text-stone-500 mb-2">推荐参数</div>
                    <div class="grid grid-cols-2 gap-2">
                        ${bean.recommendedDose !== undefined && bean.recommendedDose !== null ? `<div class="bg-stone-800 rounded-lg p-2 text-center">
                            <div class="text-[9px] text-stone-500 mb-0.5">粉量</div>
                            <div class="text-sm font-bold text-amber-500">${bean.recommendedDose}g</div>
                        </div>` : ''}
                        ${bean.recommendedTemp !== undefined && bean.recommendedTemp !== null ? `<div class="bg-stone-800 rounded-lg p-2 text-center">
                            <div class="text-[9px] text-stone-500 mb-0.5">水温</div>
                            <div class="text-sm font-bold text-amber-500">${bean.recommendedTemp}°C</div>
                        </div>` : ''}
                        ${bean.recommendedTime !== undefined && bean.recommendedTime !== null ? `<div class="bg-stone-800 rounded-lg p-2 text-center">
                            <div class="text-[9px] text-stone-500 mb-0.5">萃取时间</div>
                            <div class="text-sm font-bold text-amber-500">${bean.recommendedTime}s</div>
                        </div>` : ''}
                        ${bean.recommendedYield !== undefined && bean.recommendedYield !== null ? `<div class="bg-stone-800 rounded-lg p-2 text-center">
                            <div class="text-[9px] text-stone-500 mb-0.5">液重</div>
                            <div class="text-sm font-bold text-amber-500">${bean.recommendedYield}g</div>
                        </div>` : ''}
                    </div>
                </div>`;
            }
            
            // 备注
            if (bean.notes) {
                html += `<div class="mt-4 pt-4 border-t border-stone-800">
                    <div class="text-[10px] text-stone-500 mb-2">备注</div>
                    <div class="text-sm text-stone-300 whitespace-pre-wrap">${bean.notes}</div>
                </div>`;
            }
            
            content.innerHTML = html;
            modal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            renderIconsWithRetry();
        }

        /**
         * 隐藏咖啡豆详情弹窗
         * @returns {void}
         */
        function hideBeanDetailModal() {
            const modal = document.getElementById('bean-detail-modal');
            if (modal) {
                modal.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
            }
        }

        document.getElementById('new-asset-image').addEventListener('change', function(e) {
            if (e.target.files && e.target.files[0]) {
                compressImage(e.target.files[0], (base64) => {
                    STATE.newAssetImage = base64;
                    document.getElementById('new-asset-preview').src = base64; document.getElementById('new-asset-preview').classList.remove('hidden'); document.getElementById('new-asset-icon').classList.add('hidden');
                });
            }
        });

        async function addAsset() {
            const name = document.getElementById('new-asset-name').value.trim();
            if (!name) {
                await showAlert("请输入名称");
                return;
            }
            // 如果正在编辑，使用编辑时的资产类型，防止切换tab后保存到错误的类型
            const type = STATE.editingAssetId && STATE.editingAssetType ? STATE.editingAssetType : STATE.currentGearTab;
            const isEditing = !!STATE.editingAssetId && STATE.editingAssetType === type;

            const notes = document.getElementById('new-asset-notes').value.trim();
            const totalVal = parseFloat(document.getElementById('new-asset-total').value);
            const priceVal = parseFloat(document.getElementById('new-asset-price').value);
            const totalWeight = Number.isNaN(totalVal) ? 0 : Math.max(0, totalVal);
            const price = Number.isNaN(priceVal) ? 0 : Math.max(0, priceVal);
            const roastDate = document.getElementById('new-asset-roast-date').value;
            
            // 获取推荐参数（仅咖啡豆）
            const recommendedDoseVal = document.getElementById('new-asset-recommended-dose').value.trim();
            const recommendedTimeVal = document.getElementById('new-asset-recommended-time').value.trim();
            const recommendedYieldVal = document.getElementById('new-asset-recommended-yield').value.trim();
            const recommendedTempVal = document.getElementById('new-asset-recommended-temp').value.trim();
            const recommendedDose = recommendedDoseVal ? parseFloat(recommendedDoseVal) : null;
            const recommendedTime = recommendedTimeVal ? parseInt(recommendedTimeVal) : null;
            const recommendedYield = recommendedYieldVal ? parseFloat(recommendedYieldVal) : null;
            const recommendedTemp = recommendedTempVal ? parseInt(recommendedTempVal) : null;

            if (isEditing) {
                const list = DB[type];
                const idx = list.findIndex(i => i.id === STATE.editingAssetId);
                if (idx !== -1) {
                    const target = list[idx];
                    target.name = name;
                    target.notes = notes || '';
                    if (type === 'beans') {
                        target.roast = document.getElementById('new-asset-roast').value;
                        target.roastDate = roastDate || '';
                        // 保存推荐参数（如果为空则删除字段）
                        if (recommendedDose !== null && !Number.isNaN(recommendedDose)) {
                            target.recommendedDose = recommendedDose;
                        } else {
                            delete target.recommendedDose;
                        }
                        if (recommendedTime !== null && !Number.isNaN(recommendedTime)) {
                            target.recommendedTime = recommendedTime;
                        } else {
                            delete target.recommendedTime;
                        }
                        if (recommendedYield !== null && !Number.isNaN(recommendedYield)) {
                            target.recommendedYield = recommendedYield;
                        } else {
                            delete target.recommendedYield;
                        }
                        if (recommendedTemp !== null && !Number.isNaN(recommendedTemp)) {
                            target.recommendedTemp = recommendedTemp;
                        } else {
                            delete target.recommendedTemp;
                        }
                        // 保存自定义赏味周期配置
                        const customPeriods = getBeanCustomPeriodsFromForm();
                        if (customPeriods && Object.keys(customPeriods).length > 0) {
                            target.customRoastPeriods = customPeriods;
                        } else {
                            delete target.customRoastPeriods;
                        }
                    }
                    if (type === 'beans' || type === 'milks') {
                        target.totalWeight = totalWeight;
                        target.price = price;
                    }
                    // 所有资产类型都支持图片
                    if (STATE.newAssetImage) {
                        target.image = STATE.newAssetImage;
                    }
                    DB[type][idx] = target;
                }
            } else {
                const item = { id: Date.now().toString(), name: name, notes: notes || '' };
                if (type === 'beans') {
                    item.roast = document.getElementById('new-asset-roast').value;
                    item.roastDate = roastDate || '';
                    // 保存推荐参数（仅保存有效值）
                    if (recommendedDose !== null && !Number.isNaN(recommendedDose)) {
                        item.recommendedDose = recommendedDose;
                    }
                    if (recommendedTime !== null && !Number.isNaN(recommendedTime)) {
                        item.recommendedTime = recommendedTime;
                    }
                    if (recommendedYield !== null && !Number.isNaN(recommendedYield)) {
                        item.recommendedYield = recommendedYield;
                    }
                    if (recommendedTemp !== null && !Number.isNaN(recommendedTemp)) {
                        item.recommendedTemp = recommendedTemp;
                    }
                    // 保存自定义赏味周期配置
                    const customPeriods = getBeanCustomPeriodsFromForm();
                    if (customPeriods && Object.keys(customPeriods).length > 0) {
                        item.customRoastPeriods = customPeriods;
                    }
                }
                if (type === 'beans' || type === 'milks') {
                    item.totalWeight = totalWeight;
                    item.price = price;
                } else {
                    item.totalWeight = 0;
                    item.price = 0;
                    item.roastDate = '';
                }
                // 所有资产类型都支持图片
                item.image = STATE.newAssetImage || null;
                DB[type].push(item);
            }

            saveData();
            resetAssetForm();
            
            // 重置编辑状态和文案
            STATE.editingAssetId = null;
            STATE.editingAssetType = null;

            // 关闭弹窗
            hideAssetFormModal();

            renderGearList();
            renderDropdowns();
        }

        function editAsset(type, id) {
            const list = DB[type];
            const item = list.find(i => i.id === id);
            if (!item) return;

            STATE.currentGearTab = type;
            STATE.editingAssetType = type;
            STATE.editingAssetId = id;

            // 切换到对应的tab
            switchGearSubTab(type);

            // 先显示弹窗（跳过重置），然后填充数据
            showAssetFormModal(true);

            // 填充表单数据
            const nameInput = document.getElementById('new-asset-name');
            const notesInput = document.getElementById('new-asset-notes');
            const roastSelect = document.getElementById('new-asset-roast');
            const previewImg = document.getElementById('new-asset-preview');
            const iconEl = document.getElementById('new-asset-icon');

            if (nameInput) nameInput.value = item.name || '';
            if (notesInput) notesInput.value = item.notes || '';
            if (type === 'beans') {
                if (roastSelect && item.roast) roastSelect.value = item.roast;
            }
            const totalInput = document.getElementById('new-asset-total');
            const priceInput = document.getElementById('new-asset-price');
            if (totalInput) totalInput.value = (type === 'beans' || type === 'milks') && item.totalWeight ? item.totalWeight : '';
            if (priceInput) priceInput.value = (type === 'beans' || type === 'milks') && item.price ? item.price : '';
            const roastDateInput = document.getElementById('new-asset-roast-date');
            if (roastDateInput) roastDateInput.value = (type === 'beans' && item.roastDate) ? item.roastDate : '';
            
            // 填充推荐参数（仅咖啡豆）
            if (type === 'beans') {
                const recommendedDoseInput = document.getElementById('new-asset-recommended-dose');
                const recommendedTimeInput = document.getElementById('new-asset-recommended-time');
                const recommendedYieldInput = document.getElementById('new-asset-recommended-yield');
                const recommendedTempInput = document.getElementById('new-asset-recommended-temp');
                if (recommendedDoseInput) recommendedDoseInput.value = item.recommendedDose || '';
                if (recommendedTimeInput) recommendedTimeInput.value = item.recommendedTime || '';
                if (recommendedYieldInput) recommendedYieldInput.value = item.recommendedYield || '';
                if (recommendedTempInput) recommendedTempInput.value = item.recommendedTemp || '';
                
                // 填充自定义赏味周期配置
                // 先重新渲染输入框（因为 showAssetFormModal 已经渲染了一次）
                renderBeanCustomPeriodsInputs();
                
                if (item.customRoastPeriods) {
                    const stageNames = ['养豆期', '最佳赏味期', '赏味期', '赏味衰退期'];
                    stageNames.forEach(stageName => {
                        const range = item.customRoastPeriods[stageName];
                        if (range) {
                            const startInput = document.getElementById(`bean-custom-${stageName}-start`);
                            const endInput = document.getElementById(`bean-custom-${stageName}-end`);
                            if (startInput) startInput.value = range[0] === Infinity ? '' : range[0];
                            if (endInput) endInput.value = range[1] === Infinity ? '' : range[1];
                        }
                    });
                    // 如果有自定义配置，展开该区域
                    const customPeriodsContent = document.getElementById('bean-custom-periods-content');
                    const chevron = document.getElementById('bean-custom-periods-chevron');
                    if (customPeriodsContent && chevron) {
                        customPeriodsContent.classList.remove('hidden');
                        chevron.style.transform = 'rotate(180deg)';
                    }
                }
            }
            
            // 所有资产类型都支持图片
            if (item.image && previewImg && iconEl) {
                previewImg.src = item.image;
                previewImg.classList.remove('hidden');
                iconEl.classList.add('hidden');
                STATE.newAssetImage = item.image;
            } else if (previewImg && iconEl) {
                previewImg.classList.add('hidden');
                iconEl.classList.remove('hidden');
                STATE.newAssetImage = null;
            }

            // 更新表单标题和按钮
            const titleEl = document.getElementById('asset-form-title');
            const btnEl = document.getElementById('asset-submit-btn');
            if (titleEl) titleEl.innerHTML = '<i data-lucide="edit-3" class="w-4"></i> 编辑项目';
            if (btnEl) btnEl.textContent = '保存修改';
        }

        async function deleteAsset(type, id) {
            const confirmed = await showConfirm("确定要删除此项目吗？");
            if (confirmed) {
                DB[type] = DB[type].filter(i => i.id !== id);
                saveData();
                renderGearList();
                renderDropdowns();
            }
        }

        /**
         * 显示图片预览
         * @param {string} imageSrc - 图片源地址
         * @returns {void}
         */
        function showImagePreview(imageSrc) {
            const overlay = document.getElementById('image-preview-overlay');
            const img = document.getElementById('image-preview-img');
            if (overlay && img) {
                img.src = imageSrc;
                overlay.classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
                renderIconsWithRetry();
            }
        }

        /**
         * 关闭图片预览
         * @returns {void}
         */
        function closeImagePreview() {
            const overlay = document.getElementById('image-preview-overlay');
            if (overlay) {
                overlay.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
            }
        }

        function renderGearList() {
            const type = STATE.currentGearTab;
            
            // === 修复开始：如果是 backup 或 tags 页面，或者是未知类型，直接跳过渲染 ===
            if (type === 'backup' || type === 'tags' || !DB[type]) {
                return;
            }
            // === 修复结束 ===

            const list = document.getElementById('gear-list');
            const data = DB[type];
            
            if (data.length === 0) { list.innerHTML = `<div class="text-center text-xs text-stone-600 py-4">暂无数据</div>`; return; }
            
            const getIcon = (type) => {
                if (type === 'beans') return 'coffee';
                if (type === 'milks') return 'milk';
                if (type === 'machines') return 'zap';
                if (type === 'grinders') return 'cpu';
                return 'package';
            };
            
            const renderData = type === 'beans' ? sortBeans(data) : data;
            
            list.innerHTML = renderData.map(item => {
                const remain = type === 'beans' ? getBeanRemaining(item) : null;
                const priceText = formatCurrency(item.price);
                const roastDays = type === 'beans' ? getRoastDays(item.roastDate, new Date()) : null;
                
                return `
                <div class="flex items-center gap-3 p-4 bg-stone-900 border border-stone-800 rounded-xl mb-2 ${type === 'beans' ? 'cursor-pointer hover:bg-stone-800/50 transition-colors' : ''}" ${type === 'beans' ? `onclick="showBeanDetailModal('${item.id}')"` : ''}>
                    <div class="w-16 h-16 rounded-lg bg-black overflow-hidden flex-shrink-0 flex items-center justify-center text-stone-700 border border-stone-800 ${item.image ? 'cursor-pointer hover:opacity-80 transition-opacity' : ''}" ${item.image ? `onclick="event.stopPropagation(); showImagePreview(this.querySelector('img').src)"` : ''}>
                        ${item.image ? `<img src="${item.image.replace(/"/g, '&quot;')}" class="w-full h-full object-cover">` : `<i data-lucide="${getIcon(type)}" class="w-6 h-6"></i>`}
                    </div>
                    <div class="flex-1 ml-1 min-w-0">
                        <div class="text-sm font-medium text-stone-200 line-clamp-2 leading-tight">${item.name}</div>
                        <div class="flex items-center gap-1.5 mt-0.5 flex-wrap">
                            ${item.roast ? `<div class="text-[10px] font-bold text-white inline-block px-2 py-0.5 rounded-full" style="background-color: ${getRoastColor(item.roast)}">${item.roast}</div>` : ''}
                            ${type === 'beans' ? (() => {
                                const stageInfo = getRoastStage(item.roast, roastDays, item.id);
                                if (stageInfo && roastDays !== null) {
                                    return `<div class="text-[10px] font-bold text-white inline-block px-2 py-0.5 rounded-full" style="background-color: ${stageInfo.color}">${stageInfo.text}</div>`;
                                }
                                return '';
                            })() : ''}
                        </div>
                        ${item.notes ? `<div class="text-[10px] text-stone-600 mt-1 truncate">${item.notes}</div>` : ''}
                        ${type === 'beans' ? (() => {
                            // 计算每克价格
                            const unitCost = item.totalWeight > 0 && item.price > 0 ? getUnitCost(item.totalWeight, item.price) : null;
                            
                            // 烘焙时间、剩余量、单价放在一行
                            const infoLine = roastDays !== null 
                                ? `<div class="flex items-center gap-2 mt-0.5 flex-wrap">
                                    <span class="text-[10px] text-stone-400">烘焙 ${roastDays} 天</span>
                                    ${remain.total > 0 ? `<span class="text-[10px] text-emerald-400">剩余 ${remain.remaining}g / ${remain.total}g</span>` : ''}
                                    ${unitCost ? `<span class="text-[10px] text-amber-500">¥${unitCost.toFixed(2)}/g</span>` : ''}
                                </div>`
                                : '<div class="text-[10px] text-stone-600 mt-0.5">未填烘焙日期</div>';
                            
                            // 生命周期进度条
                            const lifecycleProgress = roastDays !== null ? getLifecycleProgress(item.roast, roastDays, item.id) : null;
                            const progressBar = lifecycleProgress ? (() => {
                                const isLastStage = lifecycleProgress.currentStage === '赏味衰退期';
                                const stageInfo = getRoastStage(item.roast, roastDays, item.id);
                                const stageText = stageInfo ? stageInfo.text : lifecycleProgress.currentStage;
                                
                                let timeInfo = '';
                                if (isLastStage) {
                                    timeInfo = `<div class="text-[10px] text-stone-500 mt-0.5">已进入 ${stageText}，已过 ${lifecycleProgress.currentStageDays} 天</div>`;
                                } else if (lifecycleProgress.nextStageDays > 0) {
                                    timeInfo = `<div class="text-[10px] text-stone-500 mt-0.5">${stageText} 中，还有 ${lifecycleProgress.nextStageDays} 天进入 ${lifecycleProgress.nextStageName}</div>`;
                                } else {
                                    timeInfo = `<div class="text-[10px] text-stone-500 mt-0.5">${stageText} 中</div>`;
                                }
                                
                                return `
                                <div class="mt-2">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="text-[10px] text-stone-500">生命周期</span>
                                        <span class="text-[10px] font-medium" style="color: ${lifecycleProgress.color}">${stageText}</span>
                                    </div>
                                    <div class="w-full h-2 bg-stone-800 rounded-full overflow-hidden relative">
                                        <div class="h-full rounded-full transition-all duration-300" style="width: ${lifecycleProgress.progress}%; background: ${lifecycleProgress.color}"></div>
                                    </div>
                                    ${timeInfo}
                                    <div class="text-[10px] text-stone-600 mt-0.5">总进度：${roastDays} / ${lifecycleProgress.maxDays} 天</div>
                                </div>
                            `;
                            })() : '';
                            
                            return infoLine + progressBar;
                        })() : ''}
                        ${type === 'milks' ? (() => {
                            const totalText = item.totalWeight ? `${item.totalWeight}g` : '-';
                            return `<div class="text-[10px] text-stone-500 mt-1">总量 ${totalText}${priceText !== '-' ? ` · 价格 ${priceText}` : ''}</div>`;
                        })() : ''}
                    </div>
                    <div class="flex flex-col items-center gap-0.5 flex-shrink-0">
                        ${type === 'beans' && remain && remain.total > 0 ? `<button onclick="event.stopPropagation(); showAdjustBeanWeightModal('${item.id}')" class="text-stone-600 hover:text-blue-500 p-1.5 active:bg-stone-800 rounded transition-colors" title="调整剩余量"><i data-lucide="scale" class="w-3.5 h-3.5"></i></button>` : ''}
                        <button onclick="event.stopPropagation(); editAsset('${type}', '${item.id}')" class="text-stone-600 hover:text-amber-500 p-1.5 active:bg-stone-800 rounded transition-colors" title="编辑"><i data-lucide="edit-2" class="w-3.5 h-3.5"></i></button>
                        <button onclick="event.stopPropagation(); deleteAsset('${type}', '${item.id}')" class="text-stone-600 hover:text-red-500 p-1.5 active:bg-stone-800 rounded transition-colors" title="删除"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                    </div>
                </div>
            `;
            }).join('');
            renderIconsWithRetry();
        }

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(DB));
            const node = document.createElement('a'); node.setAttribute("href", dataStr);
            const dateStr = new Date().toISOString().slice(0,10); node.setAttribute("download", `espresso_lab_backup_${dateStr}.json`);
            document.body.appendChild(node); node.click(); node.remove();
        }

        /**
         * 导入备份数据（兼容旧版本备份）
         * @param {HTMLInputElement} input - 文件输入元素
         * @returns {Promise<void>}
         */
        async function importData(input) {
            if (!input.files || !input.files[0]) return;
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.logs || data.beans || data.machines) {
                        const confirmed = await showConfirm("确定要导入该备份吗？\n这将覆盖当前的记录、豆子和设备数据。");
                        if (confirmed) {
                            // 定义数据字段及其默认值（用于兼容旧版本备份）
                            const dataFields = {
                                'logs': [],
                                'beans': [],
                                'grinders': [],
                                'machines': [],
                                'milks': [],
                                'customTags': [],
                                'deletedDefaultTags': [],
                                'prefs': {},
                                'customRoastPeriods': null
                            };
                            
                            // 导入数据，缺失的字段使用默认值
                            Object.keys(dataFields).forEach(k => {
                                if (data[k] !== undefined && data[k] !== null) {
                                    DB[k] = data[k];
                                } else {
                                    // 旧版本备份可能缺少某些字段，使用默认值
                                    DB[k] = dataFields[k];
                                }
                                localStorage.setItem('el_'+k, JSON.stringify(DB[k]));
                            });
                            
                            // 数据迁移：处理旧版本的数据结构
                            migrateData(data);
                            
                            await showAlert("数据恢复成功！页面将刷新。");
                            location.reload();
                        }
                    } else {
                        await showAlert("备份文件格式不正确，无法导入。");
                    }
                } catch(err) {
                    await showAlert("文件格式错误，无法导入。\n错误信息：" + err.message);
                }
            };
            reader.readAsText(input.files[0]); input.value = '';
        }

        /**
         * 数据迁移：处理旧版本备份的数据结构变化
         * @param {Object} data - 导入的数据
         * @returns {void}
         */
        function migrateData(data) {
            // 迁移1：如果旧备份没有 deletedDefaultTags，初始化为空数组
            if (DB.deletedDefaultTags === undefined || DB.deletedDefaultTags === null) {
                DB.deletedDefaultTags = [];
            }
            
            // 迁移2：如果旧备份没有 customTags，初始化为空数组
            if (DB.customTags === undefined || DB.customTags === null) {
                DB.customTags = [];
            }
            
            // 迁移2.5：如果旧备份没有 customRoastPeriods，初始化为 null
            if (DB.customRoastPeriods === undefined) {
                DB.customRoastPeriods = null;
            }
            
            // 迁移3：为旧版本的资产数据添加缺失的字段
            const assetTypes = ['beans', 'grinders', 'machines', 'milks'];
            assetTypes.forEach(type => {
                if (Array.isArray(DB[type])) {
                    DB[type] = DB[type].map(item => {
                        // 确保每个资产都有 image 字段（旧版本可能没有）
                        if (item.image === undefined) {
                            item.image = null;
                        }
                        // 确保每个资产都有 notes 字段（旧版本可能没有）
                        if (item.notes === undefined) {
                            item.notes = '';
                        }
                        if ((type === 'beans' || type === 'milks') && item.totalWeight === undefined) {
                            item.totalWeight = 0;
                        }
                        if ((type === 'beans' || type === 'milks') && item.price === undefined) {
                            item.price = 0;
                        }
                        if (type === 'beans' && item.roastDate === undefined) {
                            item.roastDate = '';
                        }
                        return item;
                    });
                }
            });
            
            // 迁移4：为旧版本的记录数据添加缺失的字段，并清理冗余数据
            if (Array.isArray(DB.logs)) {
                DB.logs = DB.logs.map(log => {
                    // 确保记录有所有必要的字段
                    if (log.milkId === undefined) log.milkId = '';
                    if (log.milkName === undefined) log.milkName = '';
                    if (log.milkWeight === undefined) log.milkWeight = '0';
                    if (log.tags === undefined) log.tags = [];
                    if (log.image === undefined) log.image = null;
                    if (log.beanCost === undefined) log.beanCost = 0;
                    if (log.milkCost === undefined) log.milkCost = 0;
                    if (log.totalCost === undefined) log.totalCost = 0;
                    
                    // 优化：移除 beanImage 字段，避免重复存储图片数据
                    // 旧数据中的 beanImage 会被忽略，显示时从 DB.beans 中查找
                    if (log.beanImage !== undefined) {
                        delete log.beanImage;
                    }
                    
                    return log;
                });
            }
            
            // 迁移5：为旧版本的豆子数据添加缺失的字段
            if (Array.isArray(DB.beans)) {
                DB.beans = DB.beans.map(bean => {
                    // manualUsed 字段：如果未定义，保持undefined让系统自动计算
                    if (bean.manualUsed === undefined) {
                        bean.manualUsed = undefined;
                    }
                    // 推荐参数字段：旧版本可能没有这些字段，保持undefined即可（可选字段）
                    // 这些字段不需要默认值，因为它们是可选的
                    // recommendedDose, recommendedTime, recommendedYield, recommendedTemp
                    // 如果旧版本没有这些字段，它们会保持undefined，这是正确的行为
                    return bean;
                });
            }
            
            // 保存迁移后的数据
            saveData();
        }

        /**
         * 清空所有数据并恢复默认数据
         * @returns {Promise<void>}
         */
        async function resetAllData() {
            const confirmed = await showConfirm("确定要清空所有数据吗？\n这将删除所有记录、豆子、设备等数据，并恢复为默认数据。\n此操作不可恢复！");
            if (!confirmed) return;
            
            // 清空所有数据
            DB.logs = [];
            DB.beans = [];
            DB.grinders = [];
            DB.machines = [];
            DB.milks = [];
            DB.customTags = [];
            DB.deletedDefaultTags = []; // 重置已删除的默认标签
            DB.prefs = {};
            DB.customRoastPeriods = null; // 重置自定义赏味周期配置
            
            // 恢复默认数据
            // 计算7天前的日期作为示例烘焙日期
            const roastDate = new Date();
            roastDate.setDate(roastDate.getDate() - 7);
            const roastDateStr = roastDate.toISOString().split('T')[0];
            
            DB.beans = [{id: "b_demo", name: "我的咖啡豆", roast: "中深", image: null, notes: '', totalWeight: 500, price: 120, roastDate: roastDateStr, manualUsed: undefined}];
            DB.machines = [{id: "m_demo", name: "我的咖啡机", notes: '', image: null}];
            DB.grinders = [{id: "g_demo", name: "我的磨豆机", notes: '', image: null}];
            DB.milks = [{id: "milk_demo", name: "我的牛奶", notes: '', totalWeight: 1000, price: 25, image: null}];
            
            // 保存数据
            saveData();
            
            // 刷新页面
            await showAlert("数据已清空并恢复为默认数据！页面将刷新。");
            location.reload();
        }

        function switchTab(tab) {
            // 先隐藏所有 tab-content
            document.querySelectorAll('.tab-content').forEach(el => {
                el.classList.remove('active');
            });
            
            // 如果切换到非记录页，且正在编辑历史记录，取消编辑状态
            if (tab !== 'record' && STATE.editingLogId) {
                STATE.editingLogId = null;
                STATE.newLogImage = null;
                const saveTextEl = document.getElementById('btn-save-log-text');
                if (saveTextEl) saveTextEl.textContent = '记录这杯';
                clearLogImage();
            }
            
            // 如果切换到非资产页，确保资产页的所有内容都被隐藏
            if (tab !== 'gear') {
                const gearTab = document.getElementById('tab-gear');
                if (gearTab) {
                    const gearList = document.getElementById('gear-list');
                    const tagsList = document.getElementById('tags-list');
                    const backupPanel = document.getElementById('backup-panel');
                    const addButton = document.getElementById('gear-add-button-container');
                    const sortContainer = document.getElementById('bean-sort-container');
                    if (gearList) gearList.classList.add('hidden');
                    if (tagsList) tagsList.classList.add('hidden');
                    if (backupPanel) backupPanel.classList.add('hidden');
                    if (addButton) addButton.classList.add('hidden');
                    if (sortContainer) sortContainer.classList.add('hidden');
                }
            }
            
            // 显示当前 tab
            const currentTab = document.getElementById(`tab-${tab}`);
            currentTab.classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                if (btn.dataset.target === tab) btn.className = 'nav-btn flex flex-col items-center gap-1 text-amber-500 transition-colors group'; else btn.className = 'nav-btn flex flex-col items-center gap-1 text-stone-600 transition-colors hover:text-stone-300 group';
            });
            // 记住上一次所在的 tab
            DB.prefs = { ...(DB.prefs || {}), lastTab: tab };
            saveData();
            if (tab === 'history') {
                renderHistory();
            } else if (tab === 'gear') {
                // 切换到资产页时，确保显示正确的子 tab 内容
                const currentGearTab = STATE.currentGearTab || 'beans';
                // 使用 setTimeout 确保 DOM 更新后再执行
                setTimeout(() => {
                    switchGearSubTab(currentGearTab);
                    // 如果是咖啡豆tab，初始化排序按钮状态
                    if (currentGearTab === 'beans') {
                        updateBeanSortButtons();
                    }
                }, 0);
            }
        }
function recompressImageAsPromise(base64Str) {
    return new Promise((resolve) => {
        // 如果图片本身就很小（小于 50KB），或者是 null，直接跳过
        if (!base64Str || base64Str.length < 50000) {
            resolve(base64Str);
            return;
        }

        const img = new Image();
        img.src = base64Str;
        img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // 强制限制在 600px
            const MAX = 600;
            let w = img.width, h = img.height;
            if (w > h) { if (w > MAX) { h *= MAX / w; w = MAX; } }
            else { if (h > MAX) { w *= MAX / h; h = MAX; } }

            canvas.width = w;
            canvas.height = h;

            // 铺白底（防止透明变黑）
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, w, h);
            ctx.drawImage(img, 0, 0, w, h);

            // 强制 JPEG 0.5
            const newBase64 = canvas.toDataURL('image/jpeg', 0.5);
            resolve(newBase64);
        };
        img.onerror = () => {
            // 如果图片损坏，保留原样
            resolve(base64Str);
        };
    });
}

/**
 * 主函数：批量优化所有图片
 */
async function batchOptimizeImages() {
    // 1. 安全警告
    const confirmed = await showConfirm("⚠️ 操作警告\n\n即将对所有旧图片进行「重压缩」。\n\n这会显著减少体积，但可能会轻微降低画质。\n\n建议先点击「导出备份」以防万一。\n\n是否继续？");
    if (!confirmed) return;

    const btn = document.querySelector('button[onclick="batchOptimizeImages()"]');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i data-lucide="loader-2" class="w-3 animate-spin"></i> 处理中...';

    try {
        let savedSize = 0;
        let count = 0;
        let totalProcessed = 0;
        let totalItems = DB.beans.length + DB.milks.length + DB.machines.length + DB.grinders.length + DB.logs.length;

        // --- 处理咖啡豆 (Beans) ---
        for (let i = 0; i < DB.beans.length; i++) {
            const bean = DB.beans[i];
            if (bean.image) {
                const oldLen = bean.image.length;
                const newImg = await recompressImageAsPromise(bean.image);
                const newLen = newImg.length;
                if (newLen < oldLen) {
                    DB.beans[i].image = newImg;
                    savedSize += (oldLen - newLen);
                    count++;
                }
            }
            totalProcessed++;
            // 更新进度提示
            if (totalProcessed % 5 === 0) {
                btn.innerHTML = `<i data-lucide="loader-2" class="w-3 animate-spin"></i> 正在处理 ${totalProcessed}/${totalItems}...`;
            }
        }

        // --- 处理牛奶 (Milks) ---
        for (let i = 0; i < DB.milks.length; i++) {
            const milk = DB.milks[i];
            if (milk.image) {
                const oldLen = milk.image.length;
                const newImg = await recompressImageAsPromise(milk.image);
                const newLen = newImg.length;
                if (newLen < oldLen) {
                    DB.milks[i].image = newImg;
                    savedSize += (oldLen - newLen);
                    count++;
                }
            }
            totalProcessed++;
            if (totalProcessed % 5 === 0) {
                btn.innerHTML = `<i data-lucide="loader-2" class="w-3 animate-spin"></i> 正在处理 ${totalProcessed}/${totalItems}...`;
            }
        }

        // --- 处理咖啡机 (Machines) ---
        for (let i = 0; i < DB.machines.length; i++) {
            const machine = DB.machines[i];
            if (machine.image) {
                const oldLen = machine.image.length;
                const newImg = await recompressImageAsPromise(machine.image);
                const newLen = newImg.length;
                if (newLen < oldLen) {
                    DB.machines[i].image = newImg;
                    savedSize += (oldLen - newLen);
                    count++;
                }
            }
            totalProcessed++;
            if (totalProcessed % 5 === 0) {
                btn.innerHTML = `<i data-lucide="loader-2" class="w-3 animate-spin"></i> 正在处理 ${totalProcessed}/${totalItems}...`;
            }
        }

        // --- 处理磨豆机 (Grinders) ---
        for (let i = 0; i < DB.grinders.length; i++) {
            const grinder = DB.grinders[i];
            if (grinder.image) {
                const oldLen = grinder.image.length;
                const newImg = await recompressImageAsPromise(grinder.image);
                const newLen = newImg.length;
                if (newLen < oldLen) {
                    DB.grinders[i].image = newImg;
                    savedSize += (oldLen - newLen);
                    count++;
                }
            }
            totalProcessed++;
            if (totalProcessed % 5 === 0) {
                btn.innerHTML = `<i data-lucide="loader-2" class="w-3 animate-spin"></i> 正在处理 ${totalProcessed}/${totalItems}...`;
            }
        }

        // --- 处理历史记录 (Logs) ---
        for (let i = 0; i < DB.logs.length; i++) {
            const log = DB.logs[i];
            if (log.image) {
                const oldLen = log.image.length;
                const newImg = await recompressImageAsPromise(log.image);
                const newLen = newImg.length;
                if (newLen < oldLen) {
                    DB.logs[i].image = newImg;
                    savedSize += (oldLen - newLen);
                    count++;
                }
            }
            totalProcessed++;
            // 更新进度提示
            if (totalProcessed % 5 === 0) {
                btn.innerHTML = `<i data-lucide="loader-2" class="w-3 animate-spin"></i> 正在处理 ${totalProcessed}/${totalItems}...`;
            }
        }

        // --- 完成 ---
        saveData(); // 保存到 localStorage
        
        // 计算节省了多少 MB
        const savedMB = (savedSize / 1024 / 1024).toFixed(2);
        
        await showAlert(`优化完成！\n\n共处理图片：${count} 张\n释放空间：${savedMB} MB\n\n您的存储空间现已大幅释放！`);
        
        // 刷新存储显示
        updateStorageInfo();
        // 刷新界面以显示新图片（可选）
        renderGearList();
        renderHistory();

    } catch (e) {
        console.error(e);
        await showAlert("处理过程中发生错误，请查看控制台。");
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
            renderIconsWithRetry();
    }
}

        /**
         * 显示赏味周期配置弹窗
         * @returns {void}
         */
        function showRoastPeriodsConfig() {
            const modal = document.getElementById('roast-periods-config-modal');
            const content = document.getElementById('roast-periods-config-content');
            if (!modal || !content) return;

            const periods = getRoastPeriods();
            const roastTypes = ['浅烘', '中浅', '中烘', '中深', '深烘', '深烘焙'];
            const stageNames = ['养豆期', '最佳赏味期', '赏味期', '赏味衰退期'];
            
            let html = '<div class="space-y-4">';
            
            roastTypes.forEach(roastType => {
                const period = periods[roastType];
                if (!period) return;
                
                html += `<div class="bg-stone-800/50 rounded-lg p-3 border border-stone-700">
                    <h4 class="text-xs font-bold text-stone-300 mb-3">${roastType}</h4>
                    <div class="space-y-2">`;
                
                stageNames.forEach(stageName => {
                    const range = period[stageName];
                    if (!range) return;
                    
                    const startValue = range[0] === Infinity ? '' : range[0];
                    const endValue = range[1] === Infinity ? '' : range[1];
                    
                    html += `<div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-[10px] text-stone-500 mb-1 block">${stageName} 开始 (天)</label>
                            <input 
                                type="number" 
                                id="roast-${roastType}-${stageName}-start" 
                                value="${startValue}" 
                                min="0" 
                                step="1"
                                class="w-full bg-[#0a0a0a] border border-stone-800 rounded-lg px-2 py-1.5 text-xs text-white focus:outline-none focus:border-amber-600"
                                placeholder="开始天数"
                            >
                        </div>
                        <div>
                            <label class="text-[10px] text-stone-500 mb-1 block">${stageName} 结束 (天)</label>
                            <input 
                                type="number" 
                                id="roast-${roastType}-${stageName}-end" 
                                value="${endValue}" 
                                min="0" 
                                step="1"
                                class="w-full bg-[#0a0a0a] border border-stone-800 rounded-lg px-2 py-1.5 text-xs text-white focus:outline-none focus:border-amber-600"
                                placeholder="结束天数（留空为无限）"
                            >
                        </div>
                    </div>`;
                });
                
                html += `</div></div>`;
            });
            
            html += `
                <div class="flex gap-3 pt-2">
                    <button onclick="resetRoastPeriodsConfig()" class="flex-1 px-4 py-2.5 rounded-xl text-xs font-bold bg-stone-800 border border-stone-700 text-stone-400 hover:bg-stone-700 transition-all active:scale-95">恢复默认</button>
                    <button onclick="saveRoastPeriodsConfig()" class="flex-1 px-4 py-2.5 rounded-xl text-xs font-bold bg-amber-600 text-white hover:bg-amber-500 border border-amber-600 transition-all active:scale-95 shadow-lg shadow-amber-900/20">保存配置</button>
                </div>
            </div>`;
            
            content.innerHTML = html;
            modal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            renderIconsWithRetry();
        }

        /**
         * 隐藏赏味周期配置弹窗
         * @returns {void}
         */
        function hideRoastPeriodsConfig() {
            const modal = document.getElementById('roast-periods-config-modal');
            if (modal) {
                modal.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
            }
        }

        /**
         * 保存赏味周期配置
         * @returns {Promise<void>}
         */
        async function saveRoastPeriodsConfig() {
            const periods = getRoastPeriods();
            const roastTypes = ['浅烘', '中浅', '中烘', '中深', '深烘', '深烘焙'];
            const stageNames = ['养豆期', '最佳赏味期', '赏味期', '赏味衰退期'];
            const customPeriods = {};
            
            roastTypes.forEach(roastType => {
                const customPeriod = {};
                let hasChanges = false;
                
                stageNames.forEach(stageName => {
                    const startInput = document.getElementById(`roast-${roastType}-${stageName}-start`);
                    const endInput = document.getElementById(`roast-${roastType}-${stageName}-end`);
                    
                    if (startInput && endInput) {
                        const startValue = startInput.value.trim() === '' ? null : parseFloat(startInput.value);
                        const endValue = endInput.value.trim() === '' ? Infinity : parseFloat(endInput.value);
                        
                        const defaultPeriod = ROAST_PERIODS[roastType];
                        const defaultRange = defaultPeriod ? defaultPeriod[stageName] : null;
                        
                        // 检查是否有变化
                        if (defaultRange) {
                            if (startValue !== defaultRange[0] || endValue !== defaultRange[1]) {
                                hasChanges = true;
                            }
                        }
                        
                        if (startValue !== null && !isNaN(startValue) && !isNaN(endValue)) {
                            customPeriod[stageName] = [startValue, endValue];
                        }
                    }
                });
                
                if (hasChanges && Object.keys(customPeriod).length > 0) {
                    customPeriods[roastType] = customPeriod;
                }
            });
            
            if (Object.keys(customPeriods).length > 0) {
                DB.customRoastPeriods = customPeriods;
            } else {
                DB.customRoastPeriods = null;
            }
            
            saveData();
            hideRoastPeriodsConfig();
            await showAlert("配置已保存！");
            
            // 刷新相关显示
            renderGearList();
            renderHistory();
        }

        /**
         * 恢复默认赏味周期配置
         * @returns {Promise<void>}
         */
        async function resetRoastPeriodsConfig() {
            const confirmed = await showConfirm("确定要恢复默认配置吗？这将清除所有自定义设置。");
            if (confirmed) {
                DB.customRoastPeriods = null;
                saveData();
                hideRoastPeriodsConfig();
                await showAlert("已恢复默认配置！");
                
                // 重新打开配置窗口显示默认值
                setTimeout(() => {
                    showRoastPeriodsConfig();
                }, 300);
            }
        }

        init();
    </script>
</body>
</html>
</html>